---
title: "Load Data"
author: "Sebastian DiGeronimo"
date: '2022-06-13'
output: html_document
---

# Small lists of things to do
* rename headers to be `tidy`
    can use: .name_repair = janitor::make_clean_names inside read_csv
    
* combine date and time columns to a standard date_time
    - Something like this
     mutate(
    date_time_utc = ymd_hms(paste(`year col`, `month col`, `day col`, `time col`), tz = "utc"),
    .before = lat
  )
  
* set -8888 to 0
* address notes from file to potentially ignore certain rows 
* start plotting
    * histogram, per stations, per pigments, etc
    * simple plots over time
    * maybe some heatmap
    * maybe map

```{r setup, include=FALSE}
root <- rprojroot::find_rstudio_root_file()
knitr::opts_chunk$set(echo = TRUE)
library("ggplot2")
library("tibble")
library("tidyr")
library("readr")
library("purrr")
library("dplyr")
library("stringr")
library("forcats")
library("lubridate")
library("glue")
library("fs")
library("magrittr")
```

```{r create-dir}
# will create a set directory if does not exists
# useful for new projects
mainDir <- rprojroot::find_rstudio_root_file()
subDir <-
    c("data/raw",
      "data/processed",
      "data/plots",
      "data/metadata",
      "Rmd",
      "scripts")

fs::dir_create(path = paste0(mainDir,"/",subDir))
rm(mainDir, subDir)
```


```{r file-paths}
# find carbonate data
dir <- "//data//raw//"

# pigment files
file.pig <-
  fs::dir_ls(path = paste0(root,dir),
             recurse = TRUE,
             regexp = "\\.xlsx$")

```

```{r}
df <-
    readxl::read_xlsx(
        file.pig[1],
        sheet = 2,
        skip = 8,
        na = "-9999",
        .name_repair = janitor::make_clean_names
    ) %>%
    rename(lon = longitude,
         lat = latitude) %>%
    mutate(
        gmt_time = hms::as_hms(strftime(gmt_time, format = "%H:%M:%S")),
        date_time_utc = ymd_hms(
            paste(
                year_of_sample,
                gregorian_month,
                day_of_gregorian_month,
                gmt_time
            ),
            tz = "utc"
        ),
        .before = lon
    )

# set -8888 to 0, represent below Limit of Detection (LOD)
df[df == -8888] <- 0
```

```{r}
df2 <- 
    readxl::read_xlsx(file.pig[2], sheet = 2, skip = 8, na = "-9999", 
                      .name_repair = janitor::make_clean_names) %>%
    mutate(
        time = hms::as_hms(strftime(time, format = "%H:%M:%S")),
        date_time_utc = ymd_hms(
            paste(
                year, month, day, time
            ),
            tz = "utc"
        ),
        .before = lon
    ) %>%
    mutate(indicate_if_filters_are_replicates = as.character(indicate_if_filters_are_replicates) )
df2[df2 == -8888] <- 0



df3 <-
    readxl::read_xlsx(
        file.pig[3],
        sheet = "Report",
        skip = 8,
        na = "-9999",
        .name_repair = janitor::make_clean_names
    ) %>%
    mutate(
        time = hms::as_hms(strftime(time, format = "%H:%M:%S")),
        date_time_utc = ymd_hms(paste(year, month, day, time),
                                tz = "utc"),
        .before = lon
    ) %>%
    mutate(indicate_if_filters_are_replicates = as.character(indicate_if_filters_are_replicates),
           # matches any digit or decimal and convert to numeric
           water_depth = as.numeric(str_extract(water_depth, "\\d*\\.{0,1}\\d")),
           water_depth = replace_na(water_depth, 0)
    )
df3[df3 == -8888] <- 0

df4 <-
    readxl::read_xlsx(
        file.pig[4],
        sheet = "Report",
        skip = 8,
        na = "-9999",
        .name_repair = janitor::make_clean_names
    )  %>%
    # Fixed misspelled month
    mutate(month = case_when(!month %in% c(month.name, month.abb) ~ str_extract(month, "\\w{3}"),
           TRUE ~ month)) %>%
    mutate(
        time = hms::as_hms(strftime(time, format = "%H:%M:%S")),
        date_time_utc = ymd_hms(paste(year, month, day, time),
                                tz = "utc"),
        .before = lon
    ) 

df4[df4 == -8888] <- 0



df234 <- full_join(df3, df2)

df234 <- mutate(df234, hplc_gsfc_id = case_when(is.na(hplc_gsfc_id) ~ gsfc_sample_code,
                                                TRUE ~ hplc_gsfc_id))
```
```{r}
df5 <- 
    readxl::read_xlsx(file.pig[5], sheet = "Report", skip = 8, na = "-9999", 
                      .name_repair =janitor::make_clean_names)
df5[df5 == -8888] <- 0
df5$gmt_time <- gsub("1899-12-31 ", "", as.character(df5$gmt_time))
df <- mutate(df, date_time_utc = ymd_hms(paste(year_of_sample, gregorian_month, day_of_gregorian_month, gmt_time), tz = "utc"), .before = longitude)




#for looking at similarities in the column names between different files
# x <- cbind(names(df),names(df2),names(df3),names(df4),names(df5))
```

