---
title: "Chemtax Analysis"
author: "Anna Finch"
date: '2022-06-24'
output: html_document
---

# 1.0 ---- Summary of Document ----



# 2.0 ---- Setup ----

## 2.1 Load libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
librarian::shelf(
  librarian, conflicted, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  # broom # optional
  
  rlang, cli,
  
  # additional
  rstatix, readxl, ggtext,
  cowplot
  )

conflicts_prefer(
  dplyr::filter(), 
  dplyr::select()
    )

source(here("scripts", "misc_functions.R"))

# set colors
# alternate color palette
# tol_muted <- 
# c('#88CCEE', '#44AA99', '#117733', '#332288', '#DDCC77', '#999933',
#   '#CC6677', '#882255', '#AA4499')

tol_muted <- khroma::color("muted", names = FALSE)(9)

```


## 2.2 Load Metadata and CHEMTAX Data and Setup Variables

Merged metadata is created in `01_load_data.Rmd`
- "combined_pig_dat.csv"

CHEMTAX data is created from CHEMTAX program
- uses: 
  - "chemtax_season_clust.csv" created in `01_load_data.Rmd` 
  - takes results from each cluster (1 - 4) 
  - creates one file per cluster as "1_mbonpig_cluster[1-4].xls"
  - manually merge into "1_mbonpig.xls"
- data includes:
  - Seasonal clusters for each run of CHEMTAX with tabs used in CHEMTAX program
    - cluster 1: Winter
    - cluster 2: Spring
    - cluster 3: Summer
    - cluster 4: Autumn
  - Manually merged data set (used in the rest of this project)

```{r file-paths-chemtax-data, include=FALSE}
# set save directory
dir_plt_save  <- here("data", "plots", "chemtax_analysis")
dir_data_save <- here("data", "processed", "chemtax_analysis")

dir_create(here(dir_plt_save))

# set season names and order
szn <- c("Winter", "Spring", "Summer", "Autumn")

# ---- CHEMTAX file paths
file_chem <-
  here("data", "raw") %>%
  dir_ls(
    recurse = TRUE,
    regexp  = "mbonpig.*\\.xls$") %>% 
  str_sort() %>%
  tibble(files = .) %T>% print()


# ---- load metadata
meta_data <-
  here("data", "processed", "load_data", "combined_pig_dat.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  select(hplc_gsfc_id:lat) %>%
  mutate(season = fct(season, szn)) %>%
  filter(
    str_detect(name_of_water_body, "Florida Keys")
    # sample was missed in original analysis
    & !str_detect(sample, "WS18008_43")
    ) %T>% print()

# ---- load average seasonal CHEMTAX data
# *not used beyond first plot*
# average each season
cmtx_all <-
  file_chem %>%
  filter(str_detect(files, "cluster")) %>%
  mutate(
    filename = basename(files) %>% tools::file_path_sans_ext(),
    ranges   = c("D177:N178", "D273:N274", "D241:N242", "D305:N306"),
    cluster  = str_extract(filename, "\\d$"),
    season   = fct_inorder(szn),
    data     = map2(
      files, ranges,
      ~ read_xls(
        path  = .x,
        sheet = "Notes",
        range = .y,
        .name_repair = janitor::make_clean_names
      )
    )
  ) %>%
  select(-c(1:ranges)) %>%
  unnest(data) %T>% print()


# ---- load merged cluster CHEMTAX data 
cmtx_raw <-
  pull(file_chem, files) %>%
  # remove files with cluster in the name
  str_subset("cluster", negate = TRUE) %>%
  readxl::read_xls(
    .,
    sheet = "Avgs",
    .name_repair = janitor::make_clean_names
  ) %>%
  filter(!str_detect(sample_id, "WS19210-59")) %T>% print()


# ---- phyto full names
phyto_name <-
  tibble(
    names = c(
      "Chlorophyte", "Cryptophyte", "Cyanobacteria 2",
      "Cyanobacteria 4", "Diatom 1", "Diatom 2",
      "Dinoflagellate", "Haptophyte 6", "Haptophyte 8",
      "Prasinophyte"
    )
  ) %>%
  bind_cols(shrt = names(cmtx_all)[-c(1:3)]) %>%
    
  # add rows for combined name
  add_row(
    shrt  = c("cyano", "diat", "hapt"),
    names = c("Cyanobacteria", "Diatom", "Haptophyte")
  )
```


## 2.3 Line and Box Plot Plotting Functions 

Default Line Plot and Box Plots

```{r functions-line-box}
# ---- line plot
line_plt <- function(.dat, .var, .title) {
    
    # set limits
    ylims <- c(0, max(.dat[[.var]]) * 1.05)
    brake <- pretty(ylims, 5)
    
    # plot
    .dat %>%
    ggplot(aes(x = season, y = .data[[.var]])) +
    geom_point(size = 2) +
    geom_line(group = 1, 
              linewidth  = 1) +
    
    # labels
    labs(
     title = glue("Average Concentration per Season of {.title}"),
     x     = "Season",
     y     = "Concentration of Chlorophyll-a (mg m<sup>-3</sup>)"
     ) +
     
    # scale setup   
    scale_y_continuous(
      breaks = brake,
      limits = ylims,
      expand = expansion(mult = 0)
      ) +
    
    # theme setup   
    theme_bw(base_family = "serif") +
    theme(
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      plot.title         = element_text(size = 15),
      axis.ticks.length  = unit(-0.05, "in"),
      axis.text.y        = element_text(margin = unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.title.y       = element_markdown(size = 10),
      axis.text.x        = element_text(margin = unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.ticks.x       = element_blank(),
      legend.background  = element_rect(color = "black", fill = "white")
    )
}

# ---- box plot
box_plt <- function(.dat, .var, .title) {
    
    # limits for plot
    ylims <-  c(0, quantile(.dat[[.var]], 0.99))
    brake <- pretty(ylims, 6)

    # plotting
    .dat %>%
    ggplot() +
    geom_boxplot(
      aes(
        x = season, 
        y = .data[[.var]]
        ),
      outlier.shape = NA) +
    geom_jitter(
        aes(
          x = season, 
          y = .data[[.var]], 
          color = year
          ),
        width = 0.4,
        size = 0.5
        ) +
    
    # labels
    labs(
      title = glue("Concentration of {.title} per Season "),
      x     = "Season",
      y     = "Concentration (mg m<sup>-3</sup>)",
      color = "Year") +

    # scale settings
    scale_color_binned(type = "viridis") +
    
    scale_y_continuous(
      breaks = brake,
      expand = expansion(mult = 0),
      limits = ylims,
      oob    = scales::squish
      ) +
    
    # theme settings
    theme_bw(base_family = "serif") +
    theme(
      panel.grid        = element_blank(),
      plot.title        = element_text(size = 15),
      axis.ticks.length = unit(-0.05, "in"),
      axis.text.y       = element_text(margin = unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.title.y      = element_markdown(size = 10),
      axis.text.x       = element_text(margin = unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.ticks.x      = element_blank(),
      legend.background = element_rect(color = "black", fill = "white")
    )
}
```


# 3.0 ---- Line Plot: Average Seasonal PFT vs Season ----

Not super useful

Average PFT in concentration of total chlorophyll-a (mg m^-3)

```{r line-plt}
cmtx_all %>%
  select(-rms) %>%
  pivot_longer(
    cols      = -c(1:2),
    names_to  = "phyto",
    values_to = "avg_conc"
  ) %>%
  group_by(phyto) %>%
  nest() %>%
  left_join(phyto_name, by = c("phyto" = "shrt")) %$%
  walk2(
    data, 
    names, 
    ~ line_plt(
      .dat = .x,
      .var = "avg_conc",
      .title = .y
    ) %>%
      print()
  )

rm(cmtx_all)
```

# 4.0 ---- Box Plots ----

## 4.1 Merge CHEMTAX Results with Metadata

```{r merge-meta-data}
# ---- join metadata and chemtax data
cmtx_all_w <-
  full_join(
    meta_data,
    cmtx_raw,
    by = join_by(
        "sample" == "sample_id",
        "hplc_gsfc_id" == "sample"
        ),
  ) %T>% print()

# view duplicates
# 2 reason:
# - 1. duplicate sample taken in field
#   - this is signified with the same location and is usually +1 of sample ID
# - 2. internal consistency at NASA where they use subset of sample 
#   - this is signified with a ###.5
janitor::get_dupes(cmtx_all_w, date_time_utc, station, depth) 

# removing duplicates by averaging
cmtx_w <-
  cmtx_all_w %>%
  reframe(
    .by = c(date_time_utc, station, depth),
    pick(1:cluster_code),
    across(
      chloro:pras,
      \(x) mean(x, na.rm = TRUE)
    )
  ) %>%
  distinct(date_time_utc, station, depth, .keep_all = TRUE) %T>% print()

# ---- save chemtax data with metadata
if (
  !file_exists(here(dir_data_save, "chemtax_w_meta_all_wide.csv")) |
    !file_exists(here(dir_data_save, "chemtax_w_meta_wide.csv"))
) {
  # wide format of CHEMTAX and metadata with duplicates
  save_csv(
    .data          = cmtx_all_w,
    save_location  = dir_data_save,
    save_name      = "chemtax_w_meta_all_wide",
    overwrite      = FALSE,
    verbose        = TRUE,
    time_stamp_fmt = NULL
  )

  # wide format of CHEMTAX and metadata without duplicates
  save_csv(
    .data          = cmtx_w,
    save_location  = dir_data_save,
    save_name      = "chemtax_w_meta_wide",
    overwrite      = FALSE,
    verbose        = TRUE,
    time_stamp_fmt = NULL
  )
} else {
  cli::cli_alert_info(
    c(
      "Skipping saving of {.file chemtax_w_meta} ",
      "because exists ",
      "and/or overwrite is set {.var FALSE}"
    )
  )
}

# ---- convert to long format
# i.e. one column for all PFT and one for concentrations
cmtx_l <-
  cmtx_w %>%
  pivot_longer(
    cols      = chloro:pras,
    names_to  = "phyto",
    values_to = "conc"
  ) %>%
  left_join(phyto_name, by = c("phyto" = "shrt"))

rm(file_chem, meta_data, cmtx_raw, cmtx_all_w)
```

## 4.2 Box Plot: Individuals for Each PFT per Season

```{r boxplots, fig.height=15, fig.width=20}
# ---- avg season line plots
cmtx_avgs_plt <-
  cmtx_l %>%
  nest(.by = c(phyto, names)) %>%
  mutate(
    plt = map2(
      data,
      names,
      ~ box_plt(
        .dat   = .x,
        .var   = "conc",
        .title = .y
      )
    )
  )

cmtx_avgs_plt$plt

```

# 5.0 ---- PFT multi-plots ----


## 5.1 Box Plot: Larger Dynamic Range PFTs


```{r box-lg-dynm, fig.height=15, fig.width=20}
box_lg <-
  cmtx_l %>%
  filter(!phyto %in% c("chloro", "crypto", "diat1", "diat2", "dino", "pras")) %>%
  ggplot(
    aes(
      x    = season,
      y    = conc,
      fill = season
    )
  ) +
  geom_boxplot(outlier.shape = NA) +
  
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.2),
    oob    = scales::squish
  ) +
  labs(
    x = "Season",
    y = "Concentration of Chlorophyll-a (mg m<sup>-3</sup>)"
  ) +
  facet_wrap(facet = ~names, ncol = 2) +
  theme_classic() +
  theme(
    text            = element_text(family = "serif", size = 18),
    axis.text       = element_markdown(size = 10),
    axis.title.y    = element_markdown(size = 10),
    legend.position = "none"
  )

box_lg
```

## 5.2 Box Plot: Smaller Dynamic Ranged PFTs


```{r box-sm-dynm, fig.height=15, fig.width=20}
box_sm <-
  cmtx_l %>%
  filter(!phyto %in% c("cyano2", "chloro", "hapt6")) %>%
  ggplot(
    aes(
      x    = season,
      y    = conc,
      fill = season
      )
  ) +
  geom_boxplot(outlier.shape = NA) +
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.1),
    oob    = scales::squish
  ) +

  # labels
  labs(
    x = "Season",
    y = "Concentration of Chlorophyll-a (mg m<sup>-3</sup>)"
  ) +
  facet_wrap(facet = ~names, ncol = 3) +

  # theme
  theme_classic() +
  theme(
    text            = element_text(family = "serif", size = 18),
    axis.text       = element_text(size = 12),
    axis.title.y    = element_markdown(size = 10),
    legend.position = "none"
  )

box_sm
```

## 5.3 Save: Large and Small Range Boxplots

```{r save-plt}
# save arguments
sv_arg <-
  list(
    sv_loc    = dir_plt_save,
    sv_nm     = str_c("cmtx_boxplot", c("lg", "sm"), sep = "_"),
    overwrite = FALSE
  ) %>%
  c(
    .,
    lg_exist = dir_ls(.$sv_loc, regexp = .$sv_nm[1]) %>% is_empty(),
    sm_exist = dir_ls(.$sv_loc, regexp = .$sv_nm[2]) %>% is_empty()
  )

# save larger dynamic range
if (sv_arg$lg_exist | sv_arg$overwrite) {
  save_gg(
    plt            = box_lg,
    save_location  = sv_arg$sv_loc,
    save_name      = sv_arg$sv_nm[1],
    verbose        = TRUE,
    time_stamp_fmt = "%Y%m%d_%H%M%S",
    device         = "jpeg",
    height         = 6,
    width          = 10,
    dpi            = 600,
    units          = "in",
    bg             = "white"
  )
} else {
  cli::cli_alert_info(
    c(
      "Skipping saving of {.file {sv_arg$sv_nm[1]}} ",
      "because exists ",
      "and/or overwrite is set {.var FALSE}"
    )
  )
}


# save smaller dynamic range
if (sv_arg$sm_exist | sv_arg$overwrite) {
  save_gg(
    plt            = box_sm,
    save_location  = sv_arg$sv_loc,
    save_name      = sv_arg$sv_nm[2],
    verbose        = TRUE,
    time_stamp_fmt = "%Y%m%d_%H%M%S",
    device         = "jpeg",
    height         = 6,
    width          = 10,
    dpi            = 600,
    units          = "in",
    bg             = "white"
  )
} else {
  cli::cli_alert_info(
    c(
      "Skipping saving of {.file {sv_arg$sv_nm[2]} ",
      "because exists ",
      "and/or overwrite is set {.var FALSE}"
    )
  )
}

rm(sv_arg)
```

# 6.0 ---- Perform Kruskal-Wallis and Dunn Test ----
## 6.1 K-W Test with PFT on season

Here Kruskal-Wallis was performed to identify if there was any signficant 
difference between each season and a PFT.

If p-value <= 0.05, then would go to Dunn's test to test pairwise season-phyto 
combination.
```{r kruskal-and-dunn}
# concentration on season grouped by PFT
cmtx_kruskal <-
  cmtx_l %>% 
  group_by(phyto) %>% 
  kruskal_test(conc ~ season)

# extract PFT where p value > 0.05
p_gt_05 <- filter(cmtx_kruskal, p > 0.05)

# Dunn's test
cmtx_dunn <-
  cmtx_l %>%
  # remove PFT with no signficant difference
  filter(!(phyto %in% p_gt_05$phyto)) %>%
  group_by(phyto) %>%
  dunn_test(
    conc ~ season, 
    p.adjust.method = "bonferroni"
    ) 

cmtx_kruskal
p_gt_05
cmtx_dunn %>%
  filter(p.adj <= 0.05) %>% 
  unite("groups", group1, group2, sep = "-") 

```
Based on the results, Diatom 1 did not have any signficant difference between 
each season. 

From the pairwise Dunn's test, only 30 pairs were signficantly different.



# 7.0 ---- Combine PFT Sub Groups ----

## 7.1 Add: PFT Groups Together

Groups to be combined have multiple types but are merged for ease of use
- diatom:
  - diatom 1 
  - diatom 2
- cyanobacteria:
  - cyano 2
  - cyano 4
- haptophyte:
  - hapt 6
  - hapt 8

```{r station-seasonally-yearly-avgs}
# combine same base PFT groups into main group
cmtx_w <-
  cmtx_w %>%
  rowwise() %>%
  mutate(
    total = sum(c_across(chloro:pras), na.rm = TRUE),
    diat  = diat1 + diat2,
    cyano = cyano2 + cyano4,
    hapt  = hapt6 + hapt8
  ) %>%
  ungroup() %>%
  relocate(total, .before = chloro) %T>% 
  print()

# calculate PFT fractions (0 - 100%)
cmtx_fract_w <-
  cmtx_w %>%
  mutate(
    .keep = "none",
    across(c(1:cruise, water_depth:lat)),
    across(
      c(pras:hapt, chloro, crypto, dino),
      (\(x) x / total),
      .names = "frac_{.col}"
    )
  ) %T>% print()

# conver to long format
cmtx_fract_l <- 
  cmtx_fract_w %>%
  pivot_longer(
    contains("frac"),
    names_to     = "phyto",
    values_to    = "frac",
    names_prefix = "frac_"
  ) %>%
    
  # add long names
  left_join(phyto_name, by = c("phyto" = "shrt")) %T>% print()
```

## 7.2 View Averages for Both Seasonal and per Station

```{r view-avgs}
format_pct <- 
  . %>%
  mutate(
    percent_avg = scales::label_percent(accuracy  = 0.01)(frac_avg)
  )

# average by season
cmtx_avg_season_fract_l <-
  cmtx_fract_l %>%
  summarise(
    .by = c(names, phyto, season),
    across(
      .cols  = frac,
      .fns   = list(
          avg = (\(x) mean(x, na.rm = TRUE)),
          sd  = (\(x) sd(x, na.rm = TRUE))
          ),
      .names = "{.col}_{.fn}"
    )
  ) %>%
  mutate(
    percent_avg = scales::label_percent(accuracy  = 0.01)(frac_avg),
    percent_sd  = scales::label_percent(accuracy  = 0.01)(frac_sd)
  ) %>%
 arrange(season) %T>% print()


# average by station
cmtx_fract_l %>%
  mutate(station = fct_reorder(station, lon)) %>%
  arrange(station) %>%
  summarise(
    .by = c(names, phyto, station),
    across(
      .cols  = frac,
      .fns   = (\(x) mean(x, na.rm = TRUE)),
      .names = "{.col}_avg"
    )
  ) %>%
  mutate(
    percent_avg = scales::label_percent(accuracy  = 0.01)(frac_avg)
  ) %>%
 arrange(station) %T>% print()

# average by station and season
cmtx_fract_l %>%
  mutate(station = fct_reorder(station, lon)) %>%
  arrange(station) %>%
  summarise(
    .by = c(station, season, names, phyto),
    across(
      .cols  = frac,
      .fns   = (\(x) mean(x, na.rm = TRUE)),
      .names = "{.col}_avg"
    )
  )  %>%
  mutate(
    percent_avg = scales::label_percent(accuracy  = 0.01)(frac_avg)
  ) %>%
 arrange(season) %T>% print()
```

## 7.3 Plot: Average PFT per Season with Standard Deviation Error Bars

Calculate per PFT:
- average 
- standard deviation

```{r cmtx-summary}
cmtx_w %>%
  summarise(
    .by = season,
    across(
      chloro:hapt,
      list(
        avg = (\(x) mean(x, na.rm = TRUE)),
        sd  = (\(x) sd(x, na.rm = TRUE)),
        var = (\(x) var(x, na.rm = TRUE))
      )
    )
  ) %>%
      

  select(-contains(c("var"))) %>%
  pivot_longer(
    data      = .,
    cols      = -season,
    names_to  = "phyto",
    values_to = "conc", 
    ) %>%
  separate(phyto, into = c("phyto", "type"), sep = "_") %>%
  pivot_wider(
    data         = .,
    names_from   = type, 
    values_from  = c(conc), 
    names_repair = janitor::make_clean_names
    ) %>%
  left_join(phyto_name, by = c("phyto" = "shrt")) %T>% print() %>%
  ggplot(aes(x = season, y = avg, color = season)) +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_point() +
  geom_linerange(aes(ymin = avg - sd, ymax = avg + sd )) +
  scale_y_continuous(breaks = scales::breaks_pretty()) +
  labs(
    x = "Season",
    y = bquote("Concentration"~(mg~L^-1)),
    color = NULL
  ) +
  facet_wrap(~names, ncol = 3, scales = "free_y") +
  theme_bw(base_family = "serif") +
  theme(legend.position = "top")


# ---- save plot
# save arguments
sv_arg <-
  list(
    sv_loc    = dir_plt_save,
    sv_nm     = "pft_avg_per_season",
    overwrite = FALSE
  ) %>%
  c(
    .,
    pft_avg = dir_ls(.$sv_loc, regexp = .$sv_nm) %>% is_empty()
  )

# save avg summary
if (sv_arg$pft_avg | sv_arg$overwrite) {
  save_gg(
    plt            = last_plot(),
    save_location  = sv_arg$sv_loc,
    save_name      = sv_arg$sv_nm[1],
    verbose        = TRUE,
    time_stamp_fmt = "%Y%m%d_%H%M%S",
    device         = "jpeg",
    height         = 6,
    width          = 10,
    dpi            = 600,
    units          = "in",
    bg             = "white"
  )
} else {
  cli::cli_alert_info(
    c(
      "Skipping saving of {.file {sv_arg$sv_nm}} ",
      "because exists ",
      "and/or overwrite is set {.var FALSE}"
    )
  )
}

rm(sv_arg)
```

## 7.4  Plot: Seasonal Fraction of each PFT (Bar)


```{r plt-fracs, fig.width=20, fig.height=10}
cmtx_avg_season_fract_l %>%
  ggplot(
    aes(
      fill  = names,
      color = names,
      y     = frac_avg,
      x     = season
    )
  ) +
  geom_bar(
    position = "fill",
    stat     = "identity"
  ) +
  labs(
    x     = "Season",
    # y     = "Proportion to Total Chl-a",
    y     = "PFT:Total Chlorophyll-a (%)",
    fill  = "Phytoplankton Functional Type",
    color = "Phytoplankton Functional Type"
  ) +
  scale_fill_manual(values  = tol_muted) +
  scale_color_manual(values = tol_muted) +
    scale_y_continuous(
        labels = scales::percent_format(accuracy = 1),
        expand = c(0,0),
        limits = c(0,1)) +
  # theme
  theme_classic() +
  theme(
    text             = element_text(family = "serif", size = 20),
    axis.title       = element_text(size = 20),
    legend.position  = "bottom",
    legend.direction = "horizontal",
    plot.margin = margin(15,10,10,10, "pt")
  )

# ---- save plot
# save arguments
sv_arg <-
  list(
    sv_loc    = dir_plt_save,
    sv_nm     = "pft_season_avg_prcnt",
    overwrite = FALSE
  ) %>%
  c(
    .,
    pft_season_avg = dir_ls(.$sv_loc, regexp = .$sv_nm) %>% is_empty()
  )

# save avg summary
if (sv_arg$pft_season_avg | sv_arg$overwrite) {
  save_gg(
    plt            = last_plot(),
    save_location  = sv_arg$sv_loc,
    save_name      = sv_arg$sv_nm[1],
    verbose        = TRUE,
    time_stamp_fmt = "%Y%m%d_%H%M%S",
    device         = "jpeg",
    height         = 8,
    width          = 16,
    dpi            = 600,
    units          = "in",
    bg             = "white"
  )
} else {
  cli::cli_alert_info(
    c(
      "Skipping saving of {.file {sv_arg$sv_nm}} ",
      "because exists ",
      "and/or overwrite is set {.var FALSE}"
    )
  )
}

rm(sv_arg)
```

## 7.5 Table: PFT Percentages per Season


```{r table-pft-proportions}
shelf(gt)
gt_pft <-
 cmtx_avg_season_fract_l %>%
  mutate(
    names = fct_reorder(names, frac_avg, .fun = mean, .desc = TRUE),  
    percent_avg = str_remove(percent_avg, "%"),
    percent_lbls = glue("{percent_avg} \u00B1 {percent_sd}")
  ) %>%
  arrange(names) %>%
  pivot_wider(
    data         = .,
    id_cols      = c(names, phyto), 
    names_from   = c(season), 
    values_from  = c(percent_lbls)
    )  %>%
          
  # ---- gt table for PFT average +/- std dev per season
  gt(
    data          = .,
    groupname_col = "names"
  ) %>%
  cols_hide(phyto) %>%
  tab_options(
    table_body.hlines.width      = 0,
    table_body.vlines.width      = 0,
    stub.border.width            = 0,
    row_group.as_column          = TRUE,
    row_group.padding.horizontal = 20,
    row_group.padding            = 200,
    stub_row_group.font.weight   = "bold",
    stub_row_group.border.width  = 0,
    row_group.border.top.width   = px(5)
  ) %>%
  cols_align("center") %>%
  tab_style(
    cell_text(
      v_align = "middle",
      align   = "center"
    ),
    locations = cells_row_groups()
  ) %>%
  tab_spanner(
    label   = "Avgerage Percent \u00B1 S.D.", 
    columns = everything()) %>%
  opt_table_font("serif")

gt_pft

# ---- save tables as html and docx
if (FALSE) {
  file_expr(
    loc            = dir_plt_save,
    file_base      = "pft_fraction_seasons",
    exts           = c("html", "docx"),
    time_stamp_fmt = "%Y%m%d_%H%M%S"
  ) %$%
  eval(file_expr) %>%
  walk(
    .,
    \(file_n) {
      gtsave(
        gt_pft,
        filename = file_n
      )
    }
  )

 
}
 
# ----
  # cmtx_fract_w %>%
  # summarise(
  #   .by = season,
  #   across(
  #     contains("frac"),
  #     list(
  #       avg = \(x) mean(x)
  #       # sd = \(x) sd(x)
  #     )
  #   )
  # ) %>%
  # cols_label(
  #   frac_chloro_avg = "Chloro",
  #   frac_crypto_avg = "Crypto",
  #   frac_cyano_avg  = "Cyano",
  #   frac_diat_avg   = "Diat",
  #   frac_dino_avg   = "Dino",
  #   frac_hapt_avg   = "Hapt",
  #   frac_pras_avg   = "Pras"
  # ) %>%
  # tab_options(
  #   table_body.hlines.width = 0,
  #   table_body.vlines.width = 0,
  #   stub.border.width = 0
  # ) %>%
  # # fmt_number(columns = starts_with("frac"), decimals = 4) %>%
  # fmt_percent(columns = starts_with("frac"), decimals = 0) %>%
  # tab_spanner(
  #   label = "Average Fraction",
  #   columns = frac_chloro_avg:frac_pras_avg
  # ) %>%
  # tab_stubhead("Season") %>%
  # opt_table_font("serif") %T>%
  # print()

# if (FALSE) {
#   gtsave(
#     gt_pft,
#     filename = here(
#       "data", "plots",
#       glue(
#         "community_fractions",
#         format(Sys.time(), "_%Y%m%d_%H%M%S"),
#         ".docx"
#       )
#     )
#   )
# }


```



# 8.0 ---- Time Series of 3 Stations with 2 PFTs -----

## 8.1 Plot: Calculate Fraction and Plot 3 Stations with 2 PFTs (Diatom and Cyano)

Stations 10, 16, WS: Plot Cyano and Diat vs time and 

Stations:
- 10
- 16
- WS

PFT:
- cyanobacteria (cyano2 and cyano4)
- diatom (diat1 and diat2)

Shows opposing signals where lower diatoms shows increase in cyano relatively

Issue is this doesn't show abosolute, where cyano could have incrased thus the
ratio is farther off.

```{r plt-cyano-diat, fig.height=8, fig.width=16}
cmtx_fract_l %>%
    
  # filter for 2 PFTs and 3 stations
  filter(
    phyto %in% c("diat", "cyano")
    & station %in% c("WS", "10", "16")
   ) %T>% print() %>%
  
  # plot
  ggplot(aes(
    x     = lubridate::ymd_hms(date_time_utc),
    y     = frac,
    color = names,
    fill  = names
  )) +
  geom_point() +
  geom_line() +
  
  labs(
    x     = NULL,
    # y     = "Proportion to Total Chl-a",
    y     = "PFT:Total Chlorophyll-a (%)",
    color = "Functional Type",
    fill  = "Functional Type"
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     expand = c(0,0),
                     limits = c(0,1)) +
  facet_wrap(facets = "station") +
  theme_classic() +
  theme(
    text            = element_text(family = "serif", size = 40),
    axis.text       = element_text(size = 30),
    axis.text.x     = element_text(angle = 45, hjust = 1), 
    axis.ticks.length.x = unit(10, "pt"),
    legend.position = c(0.5, 0.8),
    panel.spacing = unit(20, "pt") 
  )

# save arguments
sv_arg <-
  list(
    sv_loc    = dir_plt_save,
    sv_nm     = "stn_subset_frac_diat_cyano",
    overwrite = FALSE
  ) %>%
  c(
    .,
    phyto_bl = dir_ls(.$sv_loc, regexp = .$sv_nm) %>% is_empty()
  )

# save
if (sv_arg$phyto_bl | sv_arg$overwrite) {
  save_gg(
    plt            = cmtx_sub_ln_plt,
    save_location  = sv_arg$sv_loc,
    save_name      = sv_arg$sv_nm[1],
    verbose        = TRUE,
    time_stamp_fmt = "%Y%m%d_%H%M%S",
    device         = "jpeg",
    height         = 8,
    width          = 16,
    dpi            = 600,
    units          = "in",
    bg             = "white"
  )
} else {
  cli::cli_alert_info(
    c(
      "Skipping saving of {.file {sv_arg$sv_nm}} ",
      "because exists ",
      "and/or overwrite is set {.var FALSE}"
    )
  )
}

rm(sv_arg)
```

## 8.2 Timeseries with Diatoms
```{r diat-ts}
# time series for diatom at specific stations
cmtx_longer3 <-
  cmtx_w %>%
  filter(str_detect(station, "10|WS|16")) %>%
  mutate(
    diat  = diat1 + diat2,
    cyano = cyano2 + cyano4,
    hapt  = hapt6 + hapt8
  ) %>%
  # remove columns
  select(-c(diat1, diat2, cyano2, cyano4, hapt6, hapt8)) %>%
  pivot_longer(
    cols      = chloro:hapt,
    names_to  = "func_type",
    values_to = "conc"
  ) %>%
  reframe(
    pick(season),
    avg_conc = mean(conc),
    .by      = c(station, func_type, date_time_utc)
  ) %>%
  distinct()
```


```{r plt-stn-16, fig.width=30, fig.height=15}
# station 16 with diat and cyano
cmtx_longer3 %>% 
    filter(str_detect(func_type, "diat|cyano") & station == "16") %>% 
    ggplot(aes(x     = date_time_utc, 
               y     = avg_conc, 
               color = func_type, 
               fill  = func_type)
           ) +
    geom_point() +
    geom_line() +
    facet_wrap(facets = ~ "station") +
    ggthemes::theme_clean()
```

```{r diat-ts1}
# was commented out
aov(dino ~ season * as.factor(year),# + season:as.factor(year), 
    data = cmtx_w) %>%
    summary()

lm(chloro ~ season + year, 
   data = cmtx_w) %>%
    summary()

# this was done in `04_chemtax_analysis`
# cmtx_kruskal2 <- 
    # cmtx_l %>%
    # filter(!is.na(func_type)) %>%
    # group_by(func_type) %>%
    # kruskal_test(conc ~ season_year) %>%
    # arrange(desc(p))
```



