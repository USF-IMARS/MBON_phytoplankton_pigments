---
title: "Seascapes"
author: "Anna Finch"
date: "8/15/2022"
output: html_document
---
# Load Libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
librarian::shelf(
    librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here,
    # broom # optional
    
    # additional
    raster, sp, rgdal, maptools, rgeos, vegan, ggord
)

library("conflicted")

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

# ---- set path variables
seasc_path <- here("data", "raw", "seascape")

# ---- source extract function
source(here("scripts", "seascapes_extract.R"))
```

# Load CHEMTAX and CTD data
env_cmtx created in Rmd/02_ctd_download.Rmd
```{r load-chm-ctd}
# cmtx_avgs <- read.csv(paste0(path_out, "chemtax_with_metadata.csv"))

# ---- CHEMTAX with CTD
env_cmtx <- 
    here("data", "processed", "cmtx_env_data.csv") %>%
    read_csv(show_col_types  = FALSE) %>% 
    mutate(
        season = fct_relevel(season, "Winter", "Spring", "Summer", "Autumn"),
        yr_mth = format(date_time_utc, "%Y.%m")
        ) %>%
    relocate(yr_mth, .after = 2)
```

# Download Seascape Data using `seascapeR`
## Info for versioning of `raster` and `seascapeR`
NOTE: as of March 30, 2023
      - you will need to use the development version of `raster` because of some
        internal code issues with that package that hasn't been released to CRAN
      
      - you will need to update the version of `seascapeR` to "0.4.1" because a 
        function call to `rerddap::griddap` has been updated 
      

If `raster` version is not "3.6-21"     
You will need to restart R and run: pacman::p_install_gh("rspatial/raster") 

If `seasscapeR` version is not "0.4.1"     
You will need to restart R and run: pacman::p_install_gh("marinebon/seascapeR") 
## Download
```{r scp-dwnld}
# ---- set location and temporal scale for each image
map_loc <- "fknms" # FL Keys
dataset <- "global_monthly"  # or global_8day

# ---- download if needed, will return files list as tibble
seascapes_match <- 
    dwnld_seascp(
        map_loc    = map_loc,
        path       = seasc_path, 
        ss_dataset = dataset,   
        ss_var     = "CLASS",         
        date_beg   = floor_date(min(env_cmtx$date_time_utc), 
                                unit = "year"),
        date_end   = ceiling_date(max(env_cmtx$date_time_utc),
                                  unit = "year"),
        del_cache  = FALSE,
        verb       = TRUE
        )  %>%
    mutate(yr_mth = str_extract(files, "[0-9]{4}\\.[0-9]{2}")) %>%
    
    # ---- Filter seascape files to the months of the data
    filter(yr_mth %in% unique(env_cmtx$yr_mth))

seascapes_match
# ---- unzip seascapes file
# get "fknms_global_monthly.zip" from https://shiny.marinebon.app/seascapes/. 
# select "Florida Keys" in the region pull-down tab and click "all grids (.zip)"
# to download Sanctuary files. 
# here(seasc_path, "fknms_global_monthly.zip") %>%
#     unzip(., exdir = seasc_path)
```

# 
```{r }
# making empty data frame to be filled with seascapes values
seascapes_df <-
    as_tibble(matrix(ncol = 4, nrow = 1),
              .name_repair = ~ c('lon', 'lat', 'seascape', "yr_mth"))

# going through each seascapes file and extracting seascapes for each station
# and adding them to a dataframe
# for (i in 1:length(file.sea)) {
# for (i in seq(file.sea)) {
#  filename <- file.sea[i]
for (idx in seascapes_match$yr_mth[[1]]) {
   
    # # extract month and year in format "YYYY.MM" ----
    # yr_mth <-
    #     gsub(pattern     = paste0(seasc_path, "grd_CLASS_"), 
    #          replacement = "", 
    #          x           = filename) %>% 
    #     
    #     gsub(pattern     = ".15.tif", 
    #          replacement = "")
    # ----
    # make temporary dataframe with seascapes, coordinates, 
    # and year + month for cruise
    seascapes_temp <-
        filter(seascapes_match, yr_mth == idx)  %>%
        pull(1) %>%
        extract_seascapes(.,  filter(env_cmtx, yr_mth == idx)) 
    # 
    # # combine the dataframes with seascapes for each cruise
    # seascapes_df <- rbind(seascapes_df, seascapes_temp)
}

# join the chemtax and seascapes data
cmtx_sea2 <- 
    env_cmtx %>% 
    left_join(seascapes_df) %>% 
    drop_na(seascape)
```

# next thing
```{r}
#CAP with Bray-Curtis

seascspec <- cmtx_sea2 %>% 
    select(chloro:pras)

seasc.cap <- capscale(seascspec ~ seascape, cmtx_sea2, dist = "bray")

plot(seasc.cap)
```


```{r seascapes cca}
sea_matrix <- cmtx_sea2 %>% 
    select(chloro:pras)

sea_cca <- cca(sea_matrix ~ temp +sal + par, data = cmtx_sea2, na.action = na.omit)
new.lab <- list(temp = "Temp", sal = "Sal", par = "PAR")

ggord(sea_cca, size = 4, grp_in = cmtx_sea2 %>% drop_na(temp,par:sal) %$% as.character(seascape),
      ellipse = F, ptslab = T, addsize = 6, ylim = c(-6.25, 6.25), xlim = c(-4, 5),
      repel = T, txt = 6, vec_lab = new.lab, grp_title = "Seascape Class"
      ) +
    theme_classic()+
    theme(text=element_text(family="serif", size=20), legend.position = c(0.15, 0.9)) 

cowplot::save_plot(filename = paste0(root,"/data/plots/seascape_cca", 
           format(Sys.time(), '_%Y%m%d_%H%M%S'),
           ".jpg"), 
          plot = last_plot(),
          base_height = 10,
          base_width = 8,
          dpi = 600, units = "in", device='png')

```

```{r seasonal seascapes cca}
seasons <- c("Winter", "Spring", "Summer", "Autumn")
for (i in 1:length(seasons)) {
    temp_sea_df <-  cmtx_sea2 %>% 
        filter(season == seasons[i])
    temp_sea_mat <- temp_sea_df %>% 
        select(chloro:pras)
    
    temp_cca <- cca(temp_sea_mat ~ temp +sal + par, data = temp_sea_df, na.action = na.omit)
    ggord(temp_cca, size = 4, grp_in = temp_sea_df %>% drop_na(temp,par:sal) %$% as.character(seascape),
          ellipse = F, ptslab = T, addsize = 6, ylim = c(-6.25, 6.25), xlim = c(-4, 5),
          repel = T, txt = 6, vec_lab = new.lab, grp_title = "Seascape Class"
          ) +
        theme_classic()+
        theme(text=element_text(family="serif", size=20), legend.position = c(0.15, 0.9))
    
    # cowplot::save_plot(filename = paste0(root,"/data/plots/seascape_cca", seasons[i], 
    #            format(Sys.time(), '_%Y%m%d_%H%M%S'),
    #            ".jpg"), 
    #           plot = last_plot(),
    #           base_height = 10,
    #           base_width = 8,
    #           dpi = 600, units = "in", device='png')
}

```

```{r}
#doing some calculations
#information on the seascapes classes: https://shiny.marinebon.app/seascapes/classes.html

#looking at the number of samples that are dominated by each class
seasc_summary <- cmtx_sea2 %>% 
    group_by(seascape) %>% 
    summarize(n())

#looking at the number of samples that are dominated by each class per season
seasc_summary2 <- cmtx_sea2 %>% 
    group_by(seascape, season) %>% 
    summarize(n())

# too look at what seascape dominated samples with high and low chlorophyll-a values
view(cmtx_sea2 %>% 
         mutate(diat = diat1 + diat2,
           cyano = cyano2 + cyano4,
           hapt = hapt6 + hapt8,
           total = chloro + crypto + diat + dino + hapt + pras + cyano))

#look at what PFTs dominate each seascape class
sea_fract <- cmtx_sea2 %>% 
    mutate(diat = diat1 + diat2,
           cyano = cyano2 + cyano4,
           hapt = hapt6 + hapt8,
           total = chloro + crypto + diat + dino + hapt + pras + cyano) %>% 
    mutate(year = year,
              season = season,
              station = station,
              frac_chloro = chloro/total,
           frac_crypto = crypto/total,
           frac_cyano = cyano/total,
           frac_diat = diat/total,
           frac_dino = dino/total,
           frac_hapt = hapt/total,
           frac_pras = pras/total)%>% 
    select(hplc_gsfc_id:season, seascape, frac_chloro:frac_pras)
```

```{r NDMS}
set.seed(1355453)
nmds <- metaMDS(as.matrix(sea_matrix), distance = "bray")

#extract NMDS scores (x and y coordinates) for sites from newer versions of vegan package
data.scores = as.data.frame(scores(nmds)$sites)

#add columns to data frame 
data.scores$sample   = cmtx_sea2$sample
data.scores$season   = cmtx_sea2$season
data.scores$seascape = cmtx_sea2$seascape
 
head(data.scores)

Tol_muted <- c('#88CCEE', '#44AA99', '#117733', '#332288', '#DDCC77', '#999933',
               '#CC6677', '#882255', '#AA4499', '#BBBBBB', '#FFAABB')

xx <- 
    ggplot(data.scores, aes(x = NMDS1, y = NMDS2)) +
    geom_point(size = 4, aes(shape = season, color = factor(seascape))) +
    # geom_point(size = 4, aes(color = factor(seascape)))+
    # 
    theme(
        axis.text.y = element_text(
            colour = "black",
            size   = 12,
            face   = "bold"
        ),
        axis.text.x = element_text(
            colour = "black",
            face   = "bold",
            size   = 12
        ),
        legend.text = element_text(
            size   = 12,
            face   = "bold",
            colour = "black"
        ),
        legend.position = c(0.87, 0.3),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.title.x = element_text(
            face   = "bold",
            size   = 14,
            colour = "black"
        ),
        legend.title = element_text(
            size   = 14,
            colour = "black",
            face   = "bold"
        ),
        panel.background = element_blank(),
        panel.border     = element_rect(
            colour = "black",
            fill   = NA,
            size   = 1.2
        ),
        legend.key = element_blank()
    ) +
    labs(
        x     = "NMDS1",
        color = "Seascape Class",
        y     = "NMDS2",
        shape = "Season"
    )  +
    scale_shape_manual(values = c(0, 1, 2, 5, 3)) +
    # labs(x = "NMDS1", colour = "Seascape Class", y = "NMDS2") +
    scale_colour_manual(values = Tol_muted) 
 
xx

cowplot::save_plot(
    filename    = here("data", "plots",
                       glue("seascape_nmds",
                        format(Sys.time(), '_%Y%m%d_%H%M%S'),
                        ".jpg")),
    plot        = last_plot(),
    base_height = 8,
    base_width  = 14,
    dpi         = 600,
    units       = "in",
    device      = 'png'
    )
    

```

```{r ANONISM}
ano1 <- anosim(as.matrix(sea_matrix), 
               factor(cmtx_sea2$seascape), 
               distance = "bray", 
               permutations = 100)

ano2 <- anosim(as.matrix(sea_matrix), 
               factor(cmtx_sea2$season), 
               distance = "bray", 
               permutations = 100)
ano1
ano2

```

```{r}
#which functional types dominated each seascape class by season?

sea_type_avgs <- cmtx_sea2 %>% 
    group_by(season, seascape) %>% 
    summarize_at(vars(chloro:pras), mean) %>% 
    mutate(
        total       = chloro + crypto + diat1 + diat2 + dino + hapt6 + hapt8 +
            pras + cyano2 + cyano4,
        frac_chloro = chloro / total,
        frac_crypto = crypto / total,
        frac_cyano2 = cyano2 / total,
        frac_cyano4 = cyano4 / total,
        frac_diat1  = diat1  / total,
        frac_diat2  = diat2  / total,
        frac_dino   = dino   / total,
        frac_hapt6  = hapt6  / total,
        frac_hapt8  = hapt8  / total,
        frac_pras   = pras   / total
    )

sea_type_frac <- sea_type_avgs %>% 
    select(season, seascape, frac_chloro:frac_pras) %>% 
    mutate(sum = frac_chloro + frac_crypto + frac_diat1 + frac_diat2 + 
               frac_dino + frac_hapt6 + frac_hapt8 + 
               frac_pras + frac_cyano2 + frac_cyano4)

sea_type_avgs2 <- cmtx_sea2 %>% 
    group_by(seascape, season) %>% 
    summarize_at(vars(chloro:pras), mean) %>% 
    mutate(diat = diat1 + diat2,
           cyano = cyano2 + cyano4,
           hapt = hapt6 + hapt8,
           total = chloro + crypto + diat + dino + hapt + pras + cyano) %>% 
    mutate(#year = year,
             # season = season,
              #station = station,
        frac_chloro    = chloro/total,
       frac_crypto = crypto/total,
       frac_cyano  = cyano/total,
       frac_diat   = diat/total,
       frac_dino   = dino/total,
       frac_hapt   = hapt/total,
       frac_pras   = pras/total) %>% 
    select(season, seascape, frac_chloro:frac_pras)

```






