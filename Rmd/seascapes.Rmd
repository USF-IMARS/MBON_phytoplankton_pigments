---
title: "Seascapes"
author: "Anna Finch"
date: "8/15/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("ggplot2")
library("tibble")
library("tidyr")
library("readr")
library("purrr")

library("stringr")
library("forcats")
library("lubridate")
library("glue")
library("fs")
library("magrittr")
# library("broom") # optional

library("raster")
library("sp")
library("rgdal")
library("maptools")
library("rgeos")
library("vegan")
library("dplyr")

# ---- set path variables ----
root       <- rprojroot::find_rstudio_root_file()
seasc.path <- paste0(root, "/data/raw/seascapes/")
path_out   <- paste0(root, "/data/processed/")

# ---- source extract function ----
source(paste0(root, "/scripts/seascapes_extract.R"))

# ---- unzip seascapes file ----
# TODO: add documentation on how got it
unzip(paste0(seasc.path, "fknms_global_monthly.zip"), exdir = seasc.path)

# ---- load chemtax data ----
cmtx_avgs  <- read.csv(paste0(path_out, "chemtax_with_metadata.csv"))
```

```{r}
# making new column in df with year and month in format "YYYY.MM" to match how
# the seascapes .tif files are named
cmtx_sea <-
    cmtx_avgs %>%
    mutate(yr_mth = as_date(date_time_utc) %>% format("%Y.%m"))
           
# ---- extract year month col ----
mth_yr_df <- cmtx_sea %>%
    select(yr_mth) %>%
    distinct()


# making df. one column is the file names and the other column is the year and
# month for the file in format "YYYY.MM" to match with the other list
file.seascapes <-
  fs::dir_ls(path = seasc.path,
             # included ^[^~]* to not match ~, means that a file is opened
             regexp = "^[^~]*\\.tif$") %>% 
    as.data.frame() %>%
    # as_tibble() %>% 
    mutate(yr_mth = gsub(pattern = paste0(seasc.path, "grd_CLASS_"), replacement = "", x = .),
           yr_mth = gsub(pattern = ".15.tif", replacement = "", x = yr_mth))

# selecting the file names that correspond to the year and month combos that the 
# cruises had
seascapes_match <- left_join(mth_yr_df,
                             file.seascapes,
                             by = c("yr_mth")) %>%
    na.omit()
file.sea <- seascapes_match$. %>% 
    str_sort()

```

```{r }
# making empty data frame to be filled with seascapes values
seascapes_df <-
    as_tibble(matrix(ncol = 4, nrow = 1),
              .name_repair = ~ c('lon', 'lat', 'seascape', "yr_mth"))


# going through each seascapes file and extracting seascapes for each station
# and adding them to a dataframe
# for (i in 1:length(file.sea)) {
for (i in seq(file.sea)) {
    filename <- file.sea[i]
    
    #extract month and year in format "YYYY.MM"
    yr_mth <- gsub(pattern = paste0(seasc.path, "grd_CLASS_"), replacement = "", x = filename) %>% 
        gsub(pattern = ".15.tif", replacement = "")
    
    #make temporary dataframe with seascapes, coordinates, and year+month for cruise
    seascapes_temp <- extract_seascapes(filename, cmtx_sea) %>% 
        mutate(yr_mth = yr_mth)
    
    #combine the dataframes with seascapes for each cruise
    seascapes_df <- rbind(seascapes_df, seascapes_temp)
}

# join the chemtax and seascapes data
cmtx_sea2 <- cmtx_sea %>% 
    left_join(seascapes_df) %>% 
    drop_na(seascape)


```

```{r}
#CAP with Bray-Curtis

seascspec <- cmtx_sea2 %>% 
    select(chloro:pras)

seasc.cap <- capscale(seascspec ~ seascape, cmtx_sea2, dist = "bray")

plot(seasc.cap)
```




