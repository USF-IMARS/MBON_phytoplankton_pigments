---
title: "Ordination"
author: "Anna Finch"
date: '2022-07-21'
output: html_document
---

# 1.0 ---- Summary of Document ----

# 2.0 ---- Setup ----

## 2.1 Load Libraries
```{r setup, include=FALSE}
if (!nzchar(system.file(package = "librarian"))) 
    install.packages("librarian")

librarian::shelf(
    quiet = TRUE,
    librarian, conflicted, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here,
    # broom # optional
    
    # additional
     vegan, gavinsimpson/ggvegan, fawda123/ggord, jfq3/ggordiplots,
    GGally, cowplot, ggfortify, ape,
    ecodist # not sure if needed
)

conflicts_prefer(
    dplyr::filter(), 
    dplyr::select()
    )

source(here("scripts", "misc_functions.R"))
```

## 2.2 Load Dataset

Load data sets:
- CHEMTAX Seasonal Averages created in `04_chemtax_analysis.Rmd`
- Surface Averaged CTD Data created in `02_ctd_download.Rmd`
- Merge CHETMAX-CTD


The merging process:
1. Remove depths from CHEMTAX that are not near the surface (i.e. < 5m)
2. Remove rows where CTD data is not available

Missing CTD data:
  - WS16130, no CTD data available
  - SV18067, no CTD data available
  - WS18218, only a few exist
  
```{r chemtax-ctd}
dir_data_save <- here("data", "processed", "ordination")
dir_plt_save  <- here("data", "plots", "ordination")

dir_create(here(dir_plt_save))

# set season names and order
szn <- c("Winter", "Spring", "Summer", "Autumn")

# ---- CHEMTAX files
cmtx_dat <- 
  here("data", "processed", "chemtax_analysis", "chemtax_w_meta_wide.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  mutate(season = fct_relevel(season, szn)) %T>% print()

cmtx_dat %>%
    mutate(.by = c(cruise, station),
          stn_samp = n(),
           .before = station) %>%
    filter(
      .by = c(cruise_id, station),
      min(depth) == depth 
      & depth < 20
    ) %>%
      arrange(-depth)

# ---- CTD data
ctd_dat_summary <- 
  here("data", "processed", "ctd", "ctd_all.csv") %>%
  read_csv(show_col_types = FALSE)  %>%
  mutate(time = ymd_hms(time)) %T>% print()


# ---- merge data
env_cmtx <-
  cmtx_dat %>%
  filter(
    .by = c(cruise_id, station),
    min(depth) == depth &
      depth < 20
  ) %>%
  left_join(
    ctd_dat_summary,
    by = join_by(
      "cruise_id" == "cruise_id",
      "station" == "station"
    )
  ) %>%
  distinct(sample, .keep_all = TRUE) %T>% print()

# ---- filter PFT-CTD data for joint pairs without missing data
env_cmtx_filt <-
  env_cmtx  %>%
  drop_na(chloro:pras, pressure, temp, par, sal) %>%
  mutate(group = season) %T>% print()



# ---- show unmatched PFT-CTD rows
naniar::vis_miss(env_cmtx)
naniar::vis_miss(ctd_dat_summary)

filter(env_cmtx, is.na(file)) %>%
  select(cruise_id, station, date_time_utc) %>%
  arrange(date_time_utc) %T>% print() %>% 
  distinct(., cruise_id) %T>% print()


# ---- save CHEMTAX-CTD merged data
save_csv(
    .data          = env_cmtx,
    save_location  = dir_data_save,
    save_name      = "cmtx_env_data",
    overwrite      = FALSE,
    # overwrite      = TRUE,
    verbose        = TRUE,
    time_stamp_fmt = NULL
  )
```

## 2.3 Create Matrix Version of CHEMTAX Seasonal Averages



# 3.0 ---- Run PCoA and PCA on CHEMTAX data ----

## 3.1 Function to Calculate and Plot PCoA

Function to calculate and plot PCoA

This is very basic and no assumption checking was preformed. 

Vectors can be plotted as well.


```{r func-ord-plot}
#' Plot PCoA using `ggplot2`
#'
#' FUNCTION_DESCRIPTION
#'
#' @param data A data.frame or tibble with 1 grouping column and any number of 
#'             numeric columns
#' @param  vector_dat Data to add vectors to plot. Needs to have the same rows 
#'                    of data
#'                    Default: data, but can be other variables.        
#' @param .group_var A grouping variable to add color to plot
#' @param pc The principal components to plot
#' @param level Confidence interval for ellipsis on grouping variable
#' @param dist_meth Distance metric Default: "bray"
#' @param .correct Correction method given to the function `pcoa`
#'                 Default: "none"
#' @param plt_vector Optional: to return plot with vectors
#' 
#' @return RETURN_DESCRIPTION
#' @examples
#' # ADD_EXAMPLES_HERE
#' 
gg_pcoa2 <- function(
    data,
    vector_dat = data,
    .group_var = NULL,
    pc         = c(1, 2),
    level      = 0.68,
    dist_meth  = "bray",
    .correct   = c("none", "lingoes", "caillies"),
    plt_vector = FALSE) {
    

  # load library
  library(ggrepel)
  library(ggpp)
    
  .correct <- match.arg(.correct)

  stopifnot(length(pc) == 2)
  stopifnot(between(pc[1], 1, nrow(data)) & pc[1] != pc[2])
  stopifnot(between(pc[2], 1, nrow(data)) & pc[2] != pc[1])

  # calc distance matrix
  pcoa <-
    vegdist(
      data[, -1],
      method = dist_meth,
      na.rm  = TRUE
    ) %>%
    # run PCoA
    pcoa(correction = .correct, rn = NULL)


  # extract eignvalues
  eig <-
    pcoa$values[, 2] %>%
    tibble(eigen = .) %>%
    mutate(
      eig_pct  = scales::label_percent(0.1)(eigen),
      col_name = glue("PCoA{row_number()}"),
      labels   = glue("{col_name} ({eig_pct})")
    )

  # extract site values
  dat_pcoa <-
    as_tibble(pcoa$vectors) %>%
    bind_cols("group" = data[[.group_var]], .) %>%
    rename_with(
      .cols = contains("Axis"),
      .fn   = \(x) str_replace(x, "Axis\\.", "PCoA")
    )

  # extract column names for x and y axis
  x_var <- eig[pc[1], 3][[1]]
  y_var <- eig[pc[2], 3][[1]]

  

  # plot PCoA
  plt <-
    ggplot(
      data = dat_pcoa,
      aes(
        x     = .data[[x_var]],
        y     = .data[[y_var]],
        color = group
      )
    ) +
    geom_vline(
      xintercept = 0,
      color      = "grey70",
      linetype   = "dashed",
      alpha      = 0.5
    ) +
    geom_hline(
      yintercept = 0,
      color      = "grey70",
      linetype   = "dashed",
      alpha      = 0.5
    )

  # add vectors
  if (plt_vector) {
      
    vector_dat   <- select(vector_dat, -{{ .group_var }})

    pr_coo       <- pcoa$vectors
    pr_coo[, pc] <- pr_coo[, pc] %*% diag(pc)

    n <- nrow(vector_dat)
    points.stand <- scale(pr_coo[, pc])
    S <- cov(vector_dat, points.stand)

    U <- S %*% diag((pcoa$values$Eigenvalues[pc] / (n - 1))^(-0.5))
    colnames(U) <- colnames(pr_coo[, pc])
    U <-
      as.data.frame(U) %>%
      rownames_to_column(var = "pft") %>%
      rename(
        "axis_x" = 2,
        "axis_y" = 3
      )

    vect_list <-
      list(
      geom_segment(
        data = U,
        aes(
          x = 0, xend = axis_x,
          y = 0, yend = axis_y,
        ),
        alpha = 0.5,
        arrow = arrow(),
        inherit.aes = FALSE
      ),
      geom_text_repel(
        data = U,
        aes(
          x = axis_x,
          y = axis_y,
          label = pft
        ),
        position = position_nudge_center(
            x = 0.01,
            y = 0.01,
            center_x = 0,
            center_y = 0
            ),
        # label.size = NA,
        # label.padding = 0.1,
        inherit.aes = FALSE
        )
      )
  }
  
  # plot PCoA sites 
  plt <-
    plt +
    vect_list[[1]] +
    geom_point(
      aes(color = group),
      size = 1.5,
      alpha = 1
    ) +
    stat_ellipse(
      aes(fill = group),
      level = level,
      linetype = 3,
      geom = "polygon",
      alpha = 0.02,
      show.legend = FALSE
    ) +
    vect_list[[2]] +
    labs(
      x = eig$labels[pc[1]],
      y = eig$labels[pc[2]]
    ) +

    scale_color_discrete(name = "Season") +

    # theme
    theme_classic(base_family = "serif", base_size = 12) +
    theme(
      legend.position = "top"
    )

  return(
    list(
      "plt"         = plt,
      "eigenvalues" = eig,
      "pcoa_data"   = dat_pcoa,
      "U_vector"    = U
    )
  )

  # ---- end of function gg_pcoa2
}
```

## 3.2 Calculate and Plot 

Perform PCoA using "Bray-Curtis" dissimilarity on PFTs

Two different data can be used:
1. Filtered PFT data that matches to CTD. There are no duplicates nor multiple 
   depths since the CTD data was only average at the surface
2. Unfiltered PFT data with both surface and depth at some stations

Perform PCA on CTD Data

Very simple, no vectors plotted
```{r plt-pcoa-pca, fig.width=10, fig.height=6}
# ---- PCoA on PFT groups
## calc and plot
pcoa_dat <-
  # select(cmtx_dat, season, chloro:pras) %>% # using all data
   select(env_cmtx, season, chloro:pras) %>% # using filtered data with CTD
  gg_pcoa2(
    pc         = c(1, 2),
    .correct   = "none",
    .group_var = "season",
    plt_vector = TRUE
  )

# ---- PCA on environmental CTD
# temp, par and sal

## calc
env_pca <- 
  select(env_cmtx_filt,  temp, sal, par, sal) %>%
  prcomp(., scale. = TRUE)




## plot PCA
pca_plt <-
  autoplot(
    env_pca,
    data   = select(env_cmtx_filt,  season, temp, sal, par, sal),
    colour = "season"
  ) +
  scale_colour_discrete(name = "Season") +
  theme_classic() +
  theme(
    text = element_text(family = "serif", size = 12),
    legend.position = "top"
  )

pcoa_dat$plt    
pca_plt


# Save PCA and PCoA
save_gg(
  plt            = pca_plt,
  save_location  = dir_plt_save,
  save_name      = "pft_pca",
  verbose        = TRUE,
  overwrite      = FALSE,
  time_stamp_fmt = "%Y%m%d_%H%M%S",
  device         = "jpeg",
  height         = 9.7,
  width          = 19,
  dpi            = 600,
  units          = "in",
  bg             = "white"
)

save_gg(
  plt            = pcoa_dat$plt,
  save_location  = dir_plt_save,
  save_name      = "pft_pcoa",
  verbose        = TRUE,
  overwrite      = FALSE,
  time_stamp_fmt = "%Y%m%d_%H%M%S",
  device         = "jpeg",
  height         = 10,
  width          = 10,
  dpi            = 600,
  units          = "in",
  bg             = "white"
)

```

# 4.0 ---- Pairwise Permanova Test ----


## 4.1 Perform Permuatation MANOVA

- CTD vars (temp, par and sal) vs season
- PFTs vs season
  - pairwise seasons

Notes about PERMANOVA (use `betadisper`):
- homogeniety of dispersion:
  - needs to be check under the assumption of PERMANOVA
  - dispersion per grouping factor (i.e. variance within groups) is not 
    significantly different
  - however, this may be able to be ignored if when plotted, there is clear 
    group separation
  - if there is a significant difference, then you can use the "strata" argument
    in the `adonis2` function to account for this
  - this test is to check if the differences we see between groups is due to 
    differences in dispersion and not due to differences in the mean 
    (i.e. centroid, or "location")     
    - we want it to be non-significant so we can check differences between 
      groups
    
- R-squared:
  - this shows an effect size, and this will tell you the proportion of total 
    variance explained by the grouping factor
    
- the p-value
  - the probability of observing the effect size by chance
  
- pairwise comparison:
  - performed if the p-value is significant to determine which groups are 
    significantly different from each other

### 4.1.1 Check Homogeneity of Dispersion


```{r dispersion}
set.seed(1082002)
# PFT vs season
vegdist(
  select(env_cmtx_filt, chloro:pras),
  method = "bray"
  ) %>%
  betadisper(
    group = env_cmtx_filt$season  
  ) %T>% print() %>%
  anova()

# CTD vs season
ctd_perm_test <- 
  select(env_cmtx_filt, season, temp, sal, par) %>%
  mutate(across(where(is.numeric), scale)) 

ctd_perm_test %>%
  select(-season) %>%
  dist(
    method = "euclidean"
  ) %>%
  betadisper(
    group = env_cmtx_filt$season  
  ) %T>% print() %>%
  anova()


```

### 4.1.2 Perform Permanova

```{r permanova}
#' Pairwise Permutation MANOVA
#'
#' FUNCTION_DESCRIPTION
#'
#' @param .data DESCRIPTION.
#' @param pair_col DESCRIPTION.
#' @param pairs DESCRIPTION.
#' @param formula DESCRIPTION.
#' @param dist_method DESCRIPTION.
#' @param strata DESCRIPTION.
#'
#' @return RETURN_DESCRIPTION
#' @examples
#' # ADD_EXAMPLES_HERE
szn_adonis2 <- function(
        .data, 
        pair_col, 
        pairs, 
        formula = NULL, # something like "season * station" 
        dist_method = "bray",
        strata = NULL) {

    dat_pair  <- filter(.data, str_detect( {{ pair_col }}, pairs))
    value     <- select(dat_pair, chloro:pras) 
    
    if (!is.null(strata)) strata <- dat_pair[[strata]]
    
    permanova_results <- 
      adonis2(
        formula  = as.formula(paste("value ~", formula)), 
        data     = dat_pair, 
        method   = dist_method,
        strata   =  strata 
        )   
    
    
    return(
      list(
        "r_squared"  = permanova_results[["R2"]][1],
        "pairwise_p" = permanova_results[["Pr(>F)"]][1],
        "results"    = permanova_results
        )
    )
    
  # ---- end of szn_adonis2 function    
}

set.seed(1082002)
# CTD vs season
adonis2(
  select(ctd_perm_test, -season) ~ season,
  data   = ctd_perm_test,
  method = "euclidean"
)

# PFT vs season
adonis2(
  select(env_cmtx_filt, chloro:pras) ~ season,
  data   = select(env_cmtx_filt, season),
  method = "bray"
)

# pairwise test
permanova_r <-
  combn(szn, 2) %>%
  t() %>%
  as_tibble() %>%
  set_colnames(c("szn1", "szn2")) %>%
  unite(season_pairs, szn1, szn2, sep = "|") %>%
  mutate(
    pairwise_p =
      map(
        .x = season_pairs,
        .f =
          ~ szn_adonis2(
            .data    = cmtx_dat,
            pairs    = .x,
            pair_col = season,
            formula  = "season",
            strata   = NULL
            # strata   = "station"
          )
      ),
  ) %>%
  unnest_wider(pairwise_p) %>%
    
  # ---- correct p-values
  mutate(
    p_adjust = p.adjust(pairwise_p, method = "bonferroni"),
    .before = results
  ) %T>% print()

permanova_r$results

```



# 5.0 ---- CCA Analysis ----

Perform CCA and Plot:

PFTs vs CTD (temp, sal, PAR)

```{r cca, fig.height=9.7, fig.width=19}
cmtx_cca <- 
  cca(
    select(env_cmtx_filt, chloro:pras) ~ temp + sal + par, 
    data      = env_cmtx_filt, 
    na.action = na.omit
    )

plot(cmtx_cca, scaling = 1)

new_lab <- 
  list(
    temp = "Temp",
    sal  = "Sal", 
    par  = "PAR"
    )

tol_muted2 <- c('#88CCEE', '#44AA99', '#117733', '#332288')

cca_plt <-
  ggord(
    cmtx_cca,
    size      = 4,
    grp_in    = factor(env_cmtx_filt$season, szn), # season
    ellipse   = FALSE,
    ptslab    = TRUE,
    addsize   = 6,
    ylim      = c(-6.25, 6.25),
    xlim      = c(-4, 5),
    repel     = TRUE,
    txt       = 6,
    vec_lab   = new_lab,
    grp_title = "Season"
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5, color = "grey") +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5, color = "grey") +
  theme_classic() +
  theme(
    text = element_text(family = "serif", size = 20),
    legend.position = "bottom"
  )

cca_plt

gg_ordiplot(
  ord     = cmtx_cca,
  groups  = factor(env_cmtx_filt$season, szn), # season
  scaling = 1
  ) + 
  theme_bw() 



# ---- save cca plot
save_gg(
  plt            = cca_plt, # edit if want specific plot
  save_location  = dir_plt_save,
  save_name      = "pft_cca",
  verbose        = TRUE,
  overwrite      = FALSE,
  # overwrite      = TRUE,
  time_stamp_fmt = "%Y%m%d_%H%M%S",
  device         = "jpeg",
  height         = 9.7,
  width          = 19,
  dpi            = 600,
  units          = "in",
  bg             = "white"
  )
```


