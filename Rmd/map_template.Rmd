---
title: "Template for Mapping"
author: "Sebastian DiGeronimo"
date: '2022-06-14'
output: html_document
---

## Creates map of site locations for IMaRS MBON
Uses topography and coastline data from NOAA.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
librarian::shelf(
    librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here, conflicted,
    # broom # optional
     
    # additional 
    fields, cowplot, metR, rgdal, ncdf4, sf, 
    raster
)

# prefer select and filter 
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

# fixes issue with reading file
sf::sf_use_s2(FALSE)

# path for map to find/download to, they can be different depending on
# your computer
path_land <- here("data", "map")
path_topo <- here("data", "map")

# Region of Interest Bounding Box                   ======== edit this if needed
# Change the spatial extent
exnt <- c(xmin = -82, # West
          xmax = -80, # East
          ymin = 24.25,# South
          ymax = 25.75   # North 
        )

# inset extent (i.e. smaller map on top)            ======== edit this if needed
exnt2 <-  c(-90, # West
            -75, # East
            20,  # South
            35   # North
            ) 

names(exnt2) <- names(exnt)
```

# Load Combined Pigment Data
```{r load-pigment-data}
pig_dat  <- read.csv(here("data", "processed", "combined_pig_dat.csv")) %>%
    select(-c(pi, 
              bottle, indicate_if_filters_are_replicates, volfilt,
              filter_type:filter_storage_before_shipment_to_gfsc,
              comments:other, collected_with_positive_pressure_or_vaccuum,
              date_extracted_month_day_year,
              cruise, vx_ml))
```


# Download bathymetry and coastline files
**Note:** this will be done automatically if files **do not exists**

Topography, ETOPO1, 0.0166667 degrees, Global (longitude -180 to 180), (Ice Sheet Surface) from https://coastwatch.pfeg.noaa.gov/erddap/griddap/

Global Self-consistent, Hierarchical, High-resolution Geography Database (GSHHG) from https://www.ngdc.noaa.gov/mgg/shorelines/
```{r download-maps}
# source map download function
source(here("scripts", "map_files_dwnlod.R"))

world_download(
    # path_land = path_land,
    path_land = path_land,
    path_topo = path_topo,
    extent = exnt
)

rm(world_download)
```

# Load coastline and topography data
```{r load-shapefiles}
# select and read coastline file from GSHHS then crop
world2   <- fs::dir_ls(path = path_land,
                       recurse = TRUE ,
                       regexp = "GSHHS_h_L1.shp") %>%
                       st_read(.) %>%
                       st_crop(., st_bbox(exnt2))

# read state lines and crop
state    <- fs::dir_ls(path = path_land,
                       recurse = TRUE ,
                       regexp = "WDBII_border_h_L2.shp") %>%
                       st_read(.) %>%
                       st_crop(., st_bbox(exnt2))

# TODO: remove?
# bathy    <- nc_open(here(path_topo, "etopo1.nc"))
# topo     <- ncvar_get(bathy, 'altitude')
# topo_lat <- ncvar_get(bathy, 'latitude')
# topo_lon <- ncvar_get(bathy, 'longitude')
# nc_close(bathy)

# read topography data
bathy <- raster::raster(here(path_topo,"etopo1.nc")) %>%
  as.data.frame(xy = TRUE)

rm(path_topo, path_land)
```

# Plot FL Keys stations on map
```{r plt-fl-keys, fig.height=6, fig.width=10}
lat_lon_dat <- pig_dat %>%
    filter(name_of_water_body == "Florida Keys" & 
           !str_detect(station, "60")) %>%
    select(station, lat, lon) %>% 
    distinct(station, lat, lon)

base_map <-
    ggplot() +
    geom_contour2(data = bathy, 
                  aes(x = x, 
                      y = y, 
                      z = -Altitude), 
                  col = "grey40",
                  breaks = c(100, 50, 25, 10, 0)
                  ) +
    geom_sf(data = world2) +

    scale_x_continuous(expand = c(0,0)) + 
    scale_y_continuous(expand = c(0,0), 
                       breaks = seq(floor(exnt[3]), ceiling(exnt[4]), 0.5)
                       ) +

    labs(
      x = NULL,
      y = NULL
      ) +
    theme_bw() +
    theme(text = element_text(family = "serif", size = 20),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank()
          )

stn.map <- 
    base_map +
    geom_point(data = lat_lon_dat,
               aes(
                   x = lon,
                   y = lat
                   # shape = station,
                   ),
              size = 2,
              # alpha = 0.5,
              stroke = 1.5,
              show.legend = FALSE) +
    
    labs(
        shape = "Station",
        fill = "Station") +
    coord_sf(xlim = exnt[1:2], ylim = exnt[3:4]) +
     scale_shape_manual(values = c(24,25,21)) 

stn.map
```
# Zoomed out map 
```{r plt-large, fig.width=8, fig.height=10}
east.map <- 
      
    ggplot() +
    geom_sf(data = world2) +  
    geom_sf(data = state, color = "grey40", linewidth = 0.2) +
  
    # create red box on map to show sampling locations
    geom_rect(                  
        aes(
          xmin = min(lat_lon_dat$lon) - 0.25, # West
          xmax = max(lat_lon_dat$lon) + 0.25, # East
          ymin = min(lat_lon_dat$lat) - 0.25, # South
          ymax = max(lat_lon_dat$lat) + 0.25  # North
        ),
        color = "red",
        fill = NA
    ) +
    
    scale_x_continuous(expand = c(0,0)) + 
    scale_y_continuous(expand = c(0,0)) +
    coord_sf(xlim = exnt2[1:2], ylim = exnt2[3:4], 
            ) +
    
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          plot.margin = grid::unit(c(0,0,0,0), "in"),
          panel.border = element_rect(linetype = "solid", 
                                      color = "black", 
                                      fill = NA)
        )

east.map
```

# putting both of the maps together
May need to play with draw_plot(east.map, x, y, width and height)
```{r plt-lg-sm, fig.height=6, fig.width=10}
ggdraw() +
  draw_plot(stn.map) +
  draw_plot(east.map, x = 0.04, y = 0.57, width = 0.19, height = 0.4)
```
```{r save-plt-map}
if (FALSE) {
    save_plot(
        filename = here("data", "plots",
                        glue::glue("map",
                                   format(Sys.time(), '_%Y%m%d_%H%M%S'),
                                   ".jpeg")), 
        plot = last_plot(),
        base_height = 6,
        base_width = 10,
        dpi = 600, 
        units = "in", 
        device = 'jpeg')
    
    save_plot(
        filename = here("data", "plots",
                        glue::glue("map",
                                   format(Sys.time(), '_%Y%m%d_%H%M%S'),
                                   ".svg")), 
        plot = last_plot(),
        base_height = 6,
        base_width = 10,
        dpi = 600, 
        units = "in", 
        device = 'svg')
}

# clean up workspace
suppressWarnings(rm(stn.map, east.map, lat_lon_dat, state, exnt, exnt2, bathy,
                    world2))
```

# ---- Kriging for All Pigments ----
Test to see if it works
```{r map-pigments}
source("../scripts/krig_fun.R")

# filter for pigment and season
loc       <- "Florida Keys"

pigm_dat <-
    pig_dat %>%
    pivot_longer(
        tot_chl_b:dp,
        names_to  = "conc_name", 
        values_to = "conc"
        ) %>%
    filter(str_detect(name_of_water_body, loc)) %>%
    select(
        hplc_gsfc_id, sample,                   # id
        station, lat, lon, name_of_water_body,  # spatial
        year, date_time_utc, season,            # temporal
        tot_chl_a, conc_name, conc) %>%         # measurements
    group_by(conc_name, season) %>%
    nest() %>%
    ungroup() %>%
    
    # calc ratio of each pigment to total chlor-a
    mutate(data = pmap(list(season, conc_name, data),
                       function(x, y, z) {
                           z  %>%
                               mutate(ratio  = conc / tot_chl_a) %>%
                               group_by(station) %>%
                               summarise(across(
                                   c(ratio, conc, tot_chl_a),
                                   .fn = list(avg = mean),
                                   na.rm = TRUE
                               ),
                               across(c(lat, lon), .fn = mean)) %>%
                               ungroup()  %>%
                               mutate(season    = x,
                                      conc_name = y,
                                      .before   = 1)
                       }),
           szn_name = case_when(
              str_detect(season, "(?i)sp") ~ "Spring",
              str_detect(season, "(?i)su") ~ "Summer",
              str_detect(season, "^(?i)f") ~ "Autumn",
              str_detect(season, "^(?i)w") ~ "Winter",
              TRUE ~ season),
           title    = glue("{szn_name}: {conc_name}:TChla"),
           title2   = glue("{szn_name}: Average {conc_name}"),
           sv_name  = glue("MBON_pigm_{conc_name}_{str_to_lower(szn_name)}")
           ) 

pigm_dat1 <-
    pigm_dat %>%
    # slice_sample(n = 2) %>% # TODO: delete
    # slice_head(n = 1) %>% # TODO: delete
    mutate(
        krig = pmap(list(data, conc_name, szn_name, title, sv_name),
        # krig = pmap(list(data, conc_name, szn_name, title2, sv_name), 
                    ~ map.data(
                               .data     = ..1,
                               conc_name = ..2,
                               col_name  = "ratio_avg",
                               # col_name  = "conc_avg",
                               loc_name  = ..3,
                               .title    = ..4,
                               base_map  = base_map,
                               sav       = TRUE,
                               sv_name   = ..5)
                   )
    ) %>%
     unnest_wider(krig) 
pigm_dat1$map
pigm_dat1$dat
```

# ---- ERROR: tot_chl_a doesn't exist in chemtax_with_metadata ----
```{r}
#Longer chemtax dataframe with combined functional types 
cmtx_longer3 <-
    fs::dir_ls(here(), 
               regexp  = "chemtax_with_metadata", 
               recurse = TRUE) %>% 
    read.csv() %>%
    
    mutate(diat  = diat1 + diat2,
           cyano = cyano2 + cyano4,
           hapt  = hapt6 + hapt8,
           .keep = "unused"
              ) #%>% 
    cmtx_longer3 
    pivot_longer(cols = chloro:hapt, 
                 names_to = "conc_name", 
                 values_to = "conc") %>%
    
    filter(station != 60) #%>%
  
  
      select(
       hplc_gsfc_id, sample, station, lat, lon, season, year, date_time_utc,
                  conc_name, conc, tot_chl_a 
    )
```

# Don't Use: Old plotting method
```{r base-plot-fuco}
# if (FALSE) {
# png(file, height = 11, width = 4, units = "in", res = 300)
# par(
#     mfrow = c(3, 1),
#     mar = c(4.5, 4, 2, 1),
#     oma = c(4, 1, 4, 1)
# )
# 
# imagePlot(
#     ratio_kriged_fuco$x,
#     ratio_kriged_fuco$y,
#     ratio_kriged_fuco$z,
#     col = cols_fuco,
#     breaks = breaks_fuco,
#     asp = 1,
#     xlab = '',
#     ylab = '',
#     las = 1,
#     xlim = xlims_fuco,
#     ylim = ylims_fuco,
#     nlevel = length(cols_fuco),
#     legend.width = 1,
#     legend.mar = 3
# )
# 
# contour(
#     ratio_kriged_fuco$x,
#     ratio_kriged_fuco$y,
#     ratio_kriged_fuco$z,
#     levels = breaks_fuco,
#     add = TRUE
# )
# 
# image(
#     ratio_SE_fuco,
#     add = TRUE,
#     breaks = quantile(ratio_SE_fuco$z, c(1, 1), na.rm = TRUE),
#     col = 'white'
# )
# 
# image(
#     topo_lon,
#     topo_lat,
#     topo,
#     breaks = c(-1, 100),
#     col = 'white',
#     add = TRUE
# )
# 
# # plot(FL,col='gray70',add=TRUE)
# plot(world2, col = 'gray70', add = TRUE)
# contour(
#     topo_lon,
#     topo_lat,
#     topo,
#     add = TRUE,
#     levels = c(-100, -50, -25, -10),
#     col = 'gray40'
# )
# 
# points(df_fuco$lon,
#        df_fuco$lat,
#        pch = 20,
#        col = 'yellow')
# 
# mtext(expression(paste('Longitude (\u00B0W)')), 1, line = 3, cex = 0.75)
# 
# mtext(expression(paste('Latitude (\u00B0N)')), 2, line = 3, cex = 0.75)
# mtext('Fucoxanthin:TChla: Winter', adj = 1, cex = 0.75)
# }
```