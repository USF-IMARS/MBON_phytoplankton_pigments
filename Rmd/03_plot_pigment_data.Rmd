---
title: "Plotting Data"
author: "Anna Finch"
date: "6/16/2022"
output: html_document
fig_width: 19 
fig_height: 9.7 
---

# What is produced here:
+ setup 
  - load libraries and data

: concentration-vs-time 
  - one pigment through time for each region, colored by season, 
  - TODO: generalize to all pigments 

: scatter-plot-pigment-tchlor-a 
  - scatter plot of pigment x to Tchlor-a per region
  
: hist-viol 
  - function to make plots for histogram or violin
  - hist and viol plots for all pigments and regions
  
: chla-boxplot
  - boxplot for each region of chlor-a for each season
  
: size-fractionation-boxplots
  - boxplot for fraction of each size class, separeted by season and region
  - boxplot for concentration of each size class, separeted by season and region
  - boxplot for fraction of each size class
  
: size-frac-stack-bar
  - stacked bar charts separated by region with each season broken into average for stations
  

: size-frac-table
  - table for seasonal average fraction for each size class 

+ chemtax-data
  - data manipulation

: plotting-chemtax-data
  - hist plots for all PFTs for Florida Keys, colored by season

+ chemtax-add_labels
  - add labels to variable and add missing season for years
  
: chemtax-stacked-bar
  - stacked bar chart for PFT fraction for each stations and separated by season
  
: chemtax-stacked-bar-year-season
  - stacked bar chart for PFT fraction for each stations and separated by year and season

: chemtax-stacked-bar-conc-year-season
  - stacked bar chart for PFT concentration for each stations and separated by year and season
  
: pft-ts-loess
  - plot time series for each PFT concentration
  - separate by PFT and add GAM smoother
  - facets: full time series, day of year avg, month avg
  
: diat-ts-plt
  - plot time series for each PFT concentration
  - separate by PFT and add GAM smoother
  - facets: full time series, day of year avg, month avg
  
: diat-ts
  - data manipulation to compine diatom grp, cyano grp and hapt grp
  - avg conc by station, PFT and date time

: plt-stn-16
  - plot cyano and diat across time
  
+ diat-ts1
  - TODO: needs work
  - linear model
    * dino = season * year
  - kruskal wallis on conc and year grouped by PFT
  
+ manova
  - dunn test on conc and season/year per PFT
  - MANOVA on PFT community and season
  
: photoprotective-index
  - calc ppc/tchlor-a
  - plot PI index against time and separate regions
  - boxplot of PI for seaon and separate regions with jitter axis
  
+ kruskal-dunn-pi
  - kruskal wallis on PI per season
  - dunn test 
  - kruskal wallis on PI per year
  - dunn test
  
: photoprotective-photosynthetic
  - plot PPC vs PSC and add linear regression for each season and region
  
+ station-seasonally-yearly-avgs

+ lat-lon-table
  - lat lon table for stations
  

# ---- Load Libraries ----
```{r setup, include=FALSE}
librarian::shelf(
    librarian, conflicted, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here,
    # broom # optional
    
    # additional
    scales, ggthemes, ggtext, huxtable, gt, cowplot, ggthemes, vegan, rstatix,
    patchwork, 
    quiet = TRUE
)

conflicts_prefer(
    dplyr::filter(),
    dplyr::select()
)

# set size options of figures
knitr::opts_chunk$set(fig.width = 19, fig.height = 9.7)

# set ggplot theme
theme_set(theme_calc(base_size = 12, base_family = "serif"))
```


```{r load-date, include=FALSE}
# set season names and order
szn <- c("Winter", "Spring", "Summer", "Autumn")

# load data
pig_dat <-
  here("data", "processed", "load_data", "combined_pig_dat.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  mutate(season = fct(season, levels = szn)) %T>%
  print()
```

```{r concentration-vs-time, fig.height=15, fig.width=30}
ggplot(
  pig_dat,
  aes(
    x = date_time_utc,
    y = allo,
    color = season,
    shape = name_of_water_body
  )
) +
  geom_point(size = 2) +
  labs(
    x = "Year",
    y = "Concentration (mg m<sup>-3</sup>)",
    color = "Season",
    shape = "Region"
  ) +
  scale_y_continuous(expand = c(0, 0), na.value = 0) +
  scale_x_datetime(
    date_breaks = "3 month",
    date_labels = "%B\n%Y"
  ) +
  facet_wrap(~name_of_water_body,
    nrow = 3,
    scales = "free_y"
  ) +
  theme(axis.title.y = element_markdown(margin = margin(r = 30, l = 15)))
```

```{r scatter-plot-pigment-tchlor-a}
ggplot(
  pig_dat,
  aes(
    x = tot_chl_a,
    y = fuco,
    fill = name_of_water_body,
    shape = name_of_water_body
  )
) +
  geom_abline(slope = 1) +
  geom_point(alpha = 0.50) +
  labs(
    x = "Total Chlorophyll-a",
    y = "Fucoxanthin",
    fill = "Region",
    shape = "Region"
  ) +
  scale_y_continuous(expand = c(0, 0), na.value = 0) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_shape_manual(values = c(21, 22, 24)) +
  coord_cartesian(ylim = c(0, NA)) +
  facet_grid(name_of_water_body ~ season, scales = "free") +
  theme_bw(base_family = "serif", base_size = 12)
```

# ---- Plot Histogram and Violin Plot ----
Plot all pigments for each season
```{r hist-viol, fig.height=9.7, fig.width=30}
pig_long <-
  pig_dat %>%
  pivot_longer(
    cols      = tot_chl_a:tchl_a_tpg,
    names_to  = "pigment",
    values_to = "conc"
  ) %>%
  select(season, pigment, conc, name_of_water_body, year) %>%
  nest(.by = pigment) %>%
  mutate(
    hist = map2(
      .x = data,
      .y = pigment,
      ~ .x %>%
        ggplot(aes(conc,
          fill = season
        )) +
        geom_histogram(
          position = "stack",
          bins = 40,
          na.rm = TRUE
        ) +
        labs(
          title = .y,
          x     = "Log<sub>\u0065</sub>([Pigment] + 1)",
          y     = "Frequency",
          fill  = "Season"
        ) +
        scale_x_continuous(
          trans = log1p_trans(),
          expand = c(0, 0)
        ) +
        scale_y_continuous(expand = c(0, 0)) +
        coord_cartesian(xlim = c(0, NA)) +
        # facet_wrap(facet = ~ name_of_water_body) +
        facet_grid(
          name_of_water_body ~ as.character(year) + season,
          scales = "free_x"
        ) +
        theme(
          axis.title.x =
            element_markdown(margin = margin(t = 20, b = 5))
        )
    ),
    viol = map2(
      .x = data,
      .y = pigment,
      ~ .x %>%
        ggplot(aes(x = season, y = conc, color = season)) +
        geom_violin(
          trim = TRUE,
          na.rm = TRUE
        ) +
        geom_jitter(
          width = 0.1,
          size = 0.5,
          alpha = 0.5,
          color = "gray",
          na.rm = TRUE
        ) +
        labs(
          title = .y,
          y     = "Concentration",
          x     = "Season"
        ) +
        scale_y_continuous(expand = c(0, 0)) +
        coord_cartesian(ylim = c(0, NA)) +
        facet_wrap(~ name_of_water_body) +
        theme(legend.position = "none")
    )
  )

# show subset of plots
pig_long %>%
    slice_sample(n = 5) %T>%
    walk(.x = .$hist,
         .f = ~ print(.x))  %>% 
    walk(.x = .$viol,
         .f = ~ print(.x)) 
```

```{r chla-boxplot}
chl_a_box <-
  pig_dat %>%
  nest(.by = name_of_water_body) %>%
  mutate(
    plt = map2(
      .x = data,
      .y = name_of_water_body,
      function(.x, .y) {
        ylims <- c(0, quantile(.x[["tot_chl_a"]], 0.99, na.rm = TRUE))

        .x %>%
          ggplot(aes(
            x = season,
            y = tot_chl_a
          )) +
          geom_boxplot(outlier.shape = NA, na.rm = TRUE) +
          stat_summary(
            fun   = mean,
            geom  = "point",
            shape = 20,
            size  = 8,
            na.rm = TRUE
          ) +
          geom_jitter(width = 0.1, size = 0.5, alpha = 0.5, na.rm = TRUE) +
          labs(
            title = glue("{.y}: [Chlorophyll-a]"),
            x     = "Season",
            y     = "Concentration (mg m<sup>-3</sup>)"
          ) +
          scale_y_continuous(expand = c(0, 0)) +
          coord_cartesian(y = ylims) +

          theme(
            axis.title.y = element_markdown(
              margin = margin(
                r = 30,
                l = 15
              )
            ),
            axis.title.x = element_markdown(margin = margin(
              t = 20,
              b = 5
            )),
            axis.text.x = element_text(color = "black"),
            axis.text.y = element_text(color = "black"),
            axis.ticks.x = element_blank()
          )
      }
    )
  )

chl_a_box$plt

# Save Chl-a Boxplot
if (FALSE) {
  chl_a_box %$%
    walk2(
      .x = name_of_water_body,
      .y = plt,
      .f = \(.x, .y) {
      .x %>%
        str_to_lower() %>%
        str_replace_all("\\s", "_") %>%
        glue(., "_chla{format(Sys.time(), '_%Y%m%d_%H%M%S')}.jpeg") %>%
        save_plot(
          filename    = .,
          path        = here("data", "plots", "plotting_pigment"),
          plot        = .y,
          base_height = 9.7,
          base_width  = 19,
          dpi         = 600,
          units       = "in",
          device      = "jpeg",
          bg          = "white"
        )
      }
    )
}
```

## Size Classes using Diagnostic Biomarker
```{r size-class-boxplots}
shelf(patchwork)

size_frac_plt <-
  pig_dat %>%
  pivot_longer(
    cols      = f_micro:pico,
    names_to  = "size_frac",
    values_to = "conc"
  ) %>%
  select(name_of_water_body, season, size_frac, conc) %>%
  nest(.by = size_frac) %>%
  mutate(
    labels = case_when(
      str_detect(size_frac, "micro") ~ "Microplankton (>20 &mu;m)",
      str_detect(size_frac, "pico") ~ "Picoplankton (<2 &mu;m)",
      str_detect(size_frac, "nano") ~ "Nanoplankton (2 - 20 &mu;m)"
    ),
    labels = if_else(str_detect(size_frac, "f_"),
      str_c("Fraction of ", labels),
      labels
    ),
    plt = map2(
      .x = data,
      .y = labels,
      function(.x, .y) {
        if (str_detect(.y, "Frac")) {
          y_name <- "Percent (%)"
          y_lim <- c(0, 1)
        } else {
          y_name <- "Concentration (mg m<sup>-3</sup>)"
          y_lim <- c(0, quantile(.x[["conc"]], 0.99, na.rm = TRUE))
        }

        .x %>%
          ggplot(
            aes(
              x = season,
              y = conc,
              fill = name_of_water_body
            )
          ) +
          geom_boxplot(na.rm = TRUE, linewidth = 0.2) +
          {
            if (str_detect(y_name, "Percent")) {
              scale_y_continuous(
                labels = scales::label_percent(),
                expand = c(0, 0)
              )
            } else {
              scale_y_continuous(expand = c(0, 0))
            }
          } +
          labs(
            title = .y,
            x     = "Season",
            y     = y_name,
            fill  = "Location",
            color = "Location"
          ) +
          scale_fill_brewer(palette = "Dark2") +
          coord_cartesian(ylim = y_lim) +
          theme(
            plot.title   = element_markdown(),
            axis.text.x  = element_text(color = "black"),
            axis.text.y  = element_text(color = "black"),
            axis.title.y = element_markdown(
              margin = margin(
                r = 30,
                l = 15
              )
            ),
            axis.title.x = element_markdown(
              margin = margin(
                t = 20,
                b = 5
              )
            )
          )
      }
    )
  )

size_frac_plt$plt

size_frac_plt$plt[[1]] /
  size_frac_plt$plt[[2]] /
  size_frac_plt$plt[[3]]

unshelf(patchwork)
```

```{r size-frac-stack-bar}
plt_stack <-
  pig_dat %>%
  pivot_longer(
    cols      = f_micro:f_pico,
    names_to  = "size_frac",
    values_to = "frac"
  ) %>%
  nest(.by = name_of_water_body) %>%
  mutate(plt = map2(
    .x = data,
    .y = name_of_water_body,
    function(.x, .y) {
      .x %>%
        mutate(
          water_name = .y,
          station    = if_else(
            str_detect(water_name, "(?i)keys"),
            fct_reorder(station, lon),
            fct_reorder(station, lat)
          )
        ) %>%
        ggplot(aes(
          x    = station,
          y    = frac,
          fill = size_frac
        )) +
        geom_bar(
          position = "fill",
          stat     = "identity",
          na.rm    = TRUE,
          # position = position_dodge(width = 0.9)
        ) +

        # labels
        labs(
          title = .y,
          x     = "Station",
          y     = "Percent (%)",
          fill  = "Phytoplankton Size Class"
        ) +
        scale_fill_brewer(
          palette = "Dark2",
          labels  = c(
            "*f*<sub>micro</sub> (>20 &mu;m)",
            "*f*<sub>nano</sub> (2 - 20 &mu;m)",
            "*f*<sub>pico</sub> (<2 &mu;m)"
          )
        ) +
        scale_y_continuous(
          labels = label_percent(),
          expand = c(0, 0)
        ) +
        scale_x_discrete(guide = guide_axis(n.dodge = 1, angle = 90)) +
        facet_wrap(~season) +
        theme(
          legend.text = element_markdown(),
          panel.spacing.x = unit(25, "pt"),
          panel.border = element_rect(fill = NA)
        )
    }
  ))

plt_stack$plt

# save plots
if (FALSE) {
  plt_stack %>%
    ungroup() %>%
    walk2(
      .x = .$name_of_water_body,
      .y = .$plt,
      .f = \(.x, .y) {
        .x %>%
          str_to_lower() %>%
          str_replace_all(" ", "_") %>%
          glue(., "_frac_bar{format(Sys.time(), '_%Y%m%d_%H%M%S')}.jpeg") %>%
          save_plot(
            filename    = .,
            path        = here("data", "plots", "plot_pigment"),
            plot        = .y,
            base_height = 9.7,
            base_width  = 19,
            dpi         = 600,
            units       = "in",
            device      = "jpeg",
            bg          = "white"
          )
      }
    )
}

```
TODO: add absolute coverage
```{r size-frac-table}
frac_gt <-
  pig_dat %>%
  pivot_longer(
    cols      = f_micro:f_pico,
    names_to  = "size_frac",
    values_to = "frac"
  ) %>%
  summarise(
    across(
      .cols = frac,
      .fns  = list(avg = mean, sd = sd),
    ),
    .by = c(season, size_frac)
  ) %>%
  mutate(
    .keep = "none",
    season,
    size_frac,
    f = glue::glue("{round(frac_avg, 2)}\u00B1{round(frac_sd, 2)}"),
  ) %>%
  pivot_wider(names_from = "size_frac", values_from = "f") %>%
  gt(
    rowname_col   = "season",
    groupname_col = NULL
  ) %>%
  cols_label(
    f_micro = md("***f*<sub>micro</sub>** (>20 &mu;m)"),
    f_nano  = md("***f*<sub>nano</sub>** (2 - 20 &mu;m)"),
    f_pico  = md("***f*<sub>pico</sub>** (<2 &mu;m)")
  ) %>%
  tab_options(
    table_body.hlines.width = 0,
    table_body.vlines.width = 0,
    stub.border.width = 0
  ) %>%
  opt_table_font("serif")

frac_gt

if (FALSE) {
  frac_gt %>%
    gtsave(
      filename = here(
        "data", "plots", Sys.Date(),
        glue(
          "fract_table",
          "{format(Sys.time(), '_%Y%m%d_%H%M%S')}.html"
        )
      )
    )
}
```

# Photoprotective Index

$$
\begin{align}
& PI~=~\frac{PPC}{\text{Tchl-a}} \\
& PPC~=~\text{photoproective carotenoids} \\
& \text{Tchl-a}~=~\text{Total chlorophyll-a (Chl-a + MV-Chl-a)}

\end{align}
$$
When PI < 1, means phyto are not being photoinhibited (?) because the total 
chlorophyll-a is higher, but if PI > 1, then photoinhibited

TODO: correlate temperature with PPC and maybe PI ratio?
```{r photoprotective-index}
shelf(ggbeeswarm)

pigm_pi <- mutate(pig_dat, pi = ppc/tot_chl_a)

plt_pi <- 
  ggplot(pigm_pi, 
    aes(x = date_time_utc, 
        y = pi, 
        color = season,
        shape = name_of_water_body)) +
  geom_point() +
  labs(color = "Season",
       shape = "Water Body")

plt_pi /
(
  plt_pi + 
  facet_grid(name_of_water_body ~ .) +
  guides(color = "none",
         shape = "none")
 )

# with SeaBass calculation for PPC
test2 <- 
  ggplot(
    pigm_pi, 
    aes(
      y = pi,
      # fill = season
      )) +
    
    # geom_boxplot() +
    labs(
        x = "Season",
        y = "Photoprotection Index (PI)") +
    geom_hline(yintercept = 1, color = "gray", linetype = "dashed") +
    theme_classic(base_family = "serif", base_size = 12) +
    theme(legend.position = "none")

# top plot
(
 test2 +  
 geom_boxplot(aes( x = season, fill = season))
) /
# bottom plot separated by water body
(
  test2 + 
  geom_boxplot(
    aes(x    = name_of_water_body, 
        fill = name_of_water_body)) +
  geom_beeswarm(
    aes(x     = name_of_water_body, 
        fill  = name_of_water_body,
        color = as.factor(year))) +
  facet_grid( ~ season)
)


if (FALSE) {
  save_plot(
    filename = here(
      "data", "plots",
      glue(
        "pi_bar",
        "{format(Sys.time(), '_%Y%m%d_%H%M%S')}.jpeg"
      )
    ),
    plot        = last_plot(),
    base_height = 6,
    base_width  = 10,
    dpi         = 600,
    units       = "in",
    device      = "jpeg"
  )
}
```
## PI vs Season
```{r kruskal-dunn-pi}
# season factor
kruskal_test(pi ~ season, data = pigm_pi)
dunn_test( # pairwise with adj
  data = pigm_pi,
  pi ~ season, 
  p.adjust.method = "bonferroni") %>%
  mutate(
      p = num(p, digits = 3),
      p.adj = num(p.adj, digits = 3)
  ) %>%
  arrange(desc(p.adj))            

# year factor
kruskal_test(data = pigm_pi, pi ~ year)
dunn_test( # pairwise with adj
  pigm_pi,
  pi ~ year, 
  p.adjust.method = "bonferroni") %>%
  mutate(
    p = num(p, digits = 3),
    p.adj = num(p.adj, digits = 3)
  ) %>%
  arrange(desc(p.adj))
```


```{r photoprotective-photosynthetic, fig.height=15, fig.width=30}
# TODO: separate plots by region 
pigm_pi %>%
  filter(
      !(str_detect(season, "Winter")
      & str_detect(name_of_water_body, "Keys")
      & ppc > 2)
               ) %>%
  ggplot(
  aes(
    x = psc,
    y = ppc,
    # shape = season,
    # color = season
    # color = name_of_water_body
  )
) +
  geom_point(size = 4, alpha = 0.3, aes(color = as.factor(year))) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(
    aes(color = as.factor(year)),
    se        = FALSE,
    method    = "lm",
    formula   = y ~ x,
    linetype  = "dashed",
    linewidth = 1.5
  ) +
  geom_smooth(
    se        = FALSE,
    color     = "red",
    method    = "lm",
    formula   = y ~ x,
    linetype  = "dashed",
    linewidth = 2
  ) +
  labs(
    y = "PPC",
    x = "PSC",
    color = NULL
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) +
  facet_wrap(name_of_water_body ~ season,
             scales = "free") +
  guides(color = guide_legend(nrow = 1, byrow = TRUE)) +
  theme(
    text = element_text(family = "serif", size = 20),
    strip.text.y = element_blank(),
    legend.position = "bottom"
  ) 

if (FALSE) {
  save_plot(
    filename = here(
      "data", "plots",
      glue(
        "psc_vs_ppc",
        "{format(Sys.time(), '_%Y%m%d_%H%M%S')}.jpeg"
      )
    ),
    plot        = last_plot(),
    base_height = 6,
    base_width  = 10,
    dpi         = 600,
    units       = "in",
    device      = "jpeg"
  )
}
```
Autumn has the most scatter, but looks to have more PSC relating to more
production
Summer has areas with more PSC and PPC, but cannot distinquish as to where
Winter is also mostly PSC heavy, with a couple of points with high PPC
Spring is the season with the most PPC promience







```{r}
stop()
```

















# -----------------------------------------------------------------------------
# ----- This may be better in another file
# -----------------------------------------------------------------------------
# TODO: move to another file

```{r chemtax-data}
#season_year order vector
# seasonyr_order <- c("Spring 2016", "Summer 2016 (No Data)", "Autumn 2016", "Winter 2016-2017 (No Data)", "Spring 2017", 
#                     "Summer 2017", "Autumn 2017", "Winter 2017-2018", "Spring 2018",
#                     "Summer 2018", "Autumn 2018", "Winter 2018-2019", "Spring 2019", 
#                     "Summer 2019", "Autumn 2019", "Winter 2019-2020", "Spring 2020 (No Data)",
#                     "Summer 2020", "Autumn 2020", "Winter 2020-2021", "Spring 2021")

cmtx_avgs <-
    here("data", "processed", "chemtax_w_meta_rm_dup.csv") %>%
    read_csv(show_col_types = FALSE) %>%
    filter(!str_detect(station, "60")) %>%
    mutate(
        season = fct_relevel(season, ~ c("Winter","Spring", 
                                         "Summer", "Autumn")),
        season = fct_relevel(season, ~ szn),
        station = fct_reorder(station, lon)
        ) %>%
    select(-c(hplc_gsfc_id, pi, cruise:bottle, filter_type:comments,
              cluster_code)) %>%
    
    # add PFT concentrations to get total chlorophyll-a
    rowwise() %>%
    mutate(total_chl_a = sum(c_across(chloro:pras)), 
           .before     = chloro) %>%
    ungroup()
```


```{r plotting-chemtax-data}
shelf(ggridges)
cmtx_long <-
  cmtx_avgs %>%
  pivot_longer(
    cols      = chloro:last_col(),
    names_to  = "func_type",
    values_to = "conc"
  ) %>%
  nest(.by = func_type) %>%
  ungroup() %>%
  mutate(
    hist = map2(
      .x = data,
      .y = func_type,
      ~ .x %>%
        ggplot(aes(conc, fill = season)) +
        geom_histogram(
          position = "stack",
          bins = 40,
          na.rm = TRUE
        ) +
        labs(
          title = .y,
          x     = "Log<sub>\u0065</sub>([PFT] + 1)",
          y     = "Frequency",
          fill  = "Season"
        ) +
        scale_x_continuous(trans = log1p_trans()) +
        facet_grid(
          facet  = season ~ .,
          scales = "free_x",
        ) +
        theme(
          axis.title.x = element_markdown(margin = margin(t = 20, b = 5))
        )
    ),
    dens = map2(
      .x = data,
      .y = func_type,
      ~ .x %>%
        ggplot(aes(conc, y = season, fill = season)) +
        geom_density_ridges(
          na.rm = TRUE,
          alpha = 0.25
        ) +
        labs(
          title = .y,
          x     = "Log<sub>\u0065</sub>([PFT] + 1)",
          y     = "Frequency",
          fill  = "Season"
        ) +
        scale_x_continuous(trans = log1p_trans()) +
        theme(
          axis.title.x = 
            element_markdown(margin = margin(t = 20, b = 5))
        )
      
    )
  )

cmtx_long$dens
cmtx_long$hist
```


```{r chemtax-add_labels}
cmtx_long <-
  cmtx_long %>%
  select(-last_col()) %>%
  unnest(data) %>%
  mutate(
    season_year = case_when(
      str_detect(season, "Aut|Spr|Sum") ~ glue("{season} {year}"),
      str_detect(month, "Jan|Feb") ~ glue("{season} {year-1}-{year}"),
      str_detect(month, "Dec") ~ glue("{season} {year}-{year+1}"),
    ),
    season_year = fct_inorder(season_year),
    season_year = fct_expand(
      season_year, "Summer 2016 (No Data)",
      "Winter 2016-2017 (No Data)", "Spring 2020 (No Data)"
    ),
    season_year = fct_relevel(season_year,
      "Summer 2016 (No Data)",
      after = 1
    ),
    season_year = fct_relevel(season_year,
      "Winter 2016-2017 (No Data)",
      after = 3
    ),
    season_year = fct_relevel(season_year,
      "Spring 2020 (No Data)",
      after = 16
    ),
    .after = season
  ) %>%
  # added rows with the missing seasons so that the facet grid will have
  # seasons by column
  complete(season_year, season) %>%
  mutate(station = fct_na_value_to_level(station, "3"))
```


```{r chemtax-stacked-bar}
# CHEMTAX stacked bar graph
cmtx_long  %>% 
    filter(!is.na(conc)) %>%
    ggplot(
       aes(
           x     = station,
           y     = conc,
           fill  = func_type,
           color = func_type
       )) +
    
    geom_bar(position = "fill", 
             stat     = "identity",
             na.rm    = TRUE) +
    
    labs(x     = "Station", 
         y     = "Percent (%)", 
         fill  = "Phytoplankton Functional Type",
         color = "Phytoplankton Functional Type"
         ) +
    scale_y_continuous(labels = scales::label_percent(),
                       expand = c(0, 0)) +
    
    facet_wrap(~ season) 
```
```{r chemtax-stacked-bar-year-season}
tol_muted <- c('#88CCEE', '#44AA99', '#117733', '#332288', '#DDCC77', '#999933',
               '#CC6677', '#882255', '#AA4499', '#BBBBBB', '#FFAABB')


# CHEMTAX stacked bar graph with ratio to chlor-a, organized by station
cmtx_long %>% 
    # mutate(station = fct_reorder(station, lon, .na_rm = FALSE)) %>% 
    # filter(!is.na(station)) 
    ggplot(aes(
        fill  = func_type,
        color = func_type,
        y     = conc,
        x     = station,
    )) +
    geom_bar(position = "fill", 
             stat     = "identity",
             na.rm    = TRUE) +
    
    labs(x     = "Station",
         y     = "Relative Ratio",
         fill  = "Phytoplankton Functional Type",
         color = "Phytoplankton Functional Type") +
    
    scale_fill_manual(values  = tol_muted) +
    scale_color_manual(values = tol_muted) +
    scale_y_continuous(labels = label_percent(),
                       expand = c(0, 0)) +
    
    facet_wrap( ~ season_year, ncol = 4) +
    
    # theme
    theme(
      axis.title       = element_text(size = 18),
      legend.position  = c(0.6, 0.05),
      legend.direction = "horizontal"
    ) 

if (FALSE) {
    save_plot(
        filename    = here("data", "plots", Sys.Date(),
                           glue("phyto_func_type_bar_ratio", 
                             "{format(Sys.time(), '_%Y%m%d_%H%M%S')}.jpeg")
                           ),
        plot        = last_plot(),
        base_height = 9.7,
        base_width  = 19,
        dpi         = 600,
        units       = "in",
        device      = "jpeg")
    }
```


```{r chemtax-stacked-bar-conc-year-season}
# chemtax stacked bar graph (not ratio), organized by station
cmtx_long %>% 
    summarize(conc = mean(conc, na.rm = TRUE),
              .by  = c(season_year, station, func_type)) %>% 
    ggplot(aes(
        fill  = func_type,
        color = func_type,
        y     = conc,
        x     = station
    )) +
    geom_bar(stat = "identity") +
    labs(
        x     = "Station",
        y     = "Concentration of Chlorophyll-a (mg m<sup>-3</sup>)",
        fill  = "Phytoplankton Functional Type",
        color = "Phytoplankton Functional Type"
    ) +
    
    scale_fill_manual(values  = tol_muted) +
    scale_color_manual(values = tol_muted) +
    scale_y_continuous(expand = c(0, 0)) +
    facet_wrap( ~ season_year, ncol = 4) +
    
    # theme
    theme(
      axis.title.y     = element_markdown(),
      legend.position  = c(0.6, 0.05),
      legend.direction = "horizontal"
          )

if (FALSE) {
    save_plot(
        filename    = here("data", "plots", Sys.Date(),
                            glue("phyto_func_type_bar", 
                             "{format(Sys.time(), '_%Y%m%d_%H%M%S')}.jpeg")
                           ),
        base_height = 9.7,
        base_width  = 19,
        dpi         = 600,
        units       = "in",
        device      = "jpeg")
    }
```
# Timeseries Plots
## Timesseries PFT with LOESS Smoother
 
```{r pft-ts-loess, fig.width=30, fig.height=15}
# point plot with smoothing line for 1 functional group, colored by season
plt_smooth <-
  cmtx_avgs %>%
  pivot_longer(
    cols      = chloro:pras,
    names_to  = "func_type",
    values_to = "conc"
  ) %>%
  mutate(conc_ratio = conc / total_chl_a) %>%
  ggplot(aes(
    y     = conc_ratio,
    color = func_type
  )) +
  geom_point(show.legend = FALSE) +
  # geom_smooth(
  #   formula     = y ~ s(x),
  #   method      = "gam",
  #   se          = FALSE,
  #   show.legend = FALSE
  # ) +
  geom_smooth(
    formula     = y ~ x,
    method      = "loess",
    span = 0.3,
    se          = FALSE,
    show.legend = FALSE
  ) +
  labs(
    y     = "Pigment:Chlorophyll-a",
    color = NULL
  ) +
  # scale_x_datetime(breaks = "1 year",
  #                  labels = label_date("%Y")) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Paired") +
  facet_grid(func_type ~ ., 
             # scales = "free_y"
             scales = "fixed"
             ) +
  theme_calc()

(plt_smooth +
  aes(x = date_time_utc) +
        labs(x = "Date")
    ) +
  (plt_smooth +
    aes(x = yday(date_time_utc)) +
    labs(y = NULL,
         x = "Day of Year")
   ) +
  (plt_smooth +
    aes(x = month(date_time_utc)) +
    labs(y = NULL,
         x = "Month")
   ) 
```
```{r diat-ts-plt, fig.width=30, fig.height=15}
# point plot with smoothing line for all functional groups
plt_smooth2 <- 
  cmtx_long %>%
  filter(year < 2019) %>%
  mutate(conc_ratio = conc / total_chl_a) %>%
  ggplot(aes(
    y = conc_ratio,
    color = func_type
  )) +
  geom_point(show.legend = FALSE) +
  geom_smooth(
    formula = y ~ s(x),
    method = "gam",
    # span = 1,
    se = FALSE,
    show.legend = FALSE
  ) +
  labs(
    x = NULL,
    y = "Pigment:Chlorophyll-a",
    color = NULL
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Paired") +
  facet_grid(func_type ~ ., 
             # scales = "free_y"
             scales = "fixed"
             ) +
  theme_calc()

# (test2 +  # in PI chunk
#  geom_boxplot(aes( x = season, fill = season))) + 
 (plt_smooth2 +
  aes(x = date_time_utc)) +
  (plt_smooth +
    aes(x = yday(date_time_utc)) +
    labs(y = NULL)) +
  (plt_smooth +
    aes(x = month(date_time_utc)) +
    labs(y = NULL)) +
    patchwork::plot_layout(ncol = 4)
```

## Timeseries with Diatoms
```{r diat-ts}
# time series for diatom at specific stations
cmtx_longer3 <-
  cmtx_avgs %>%
  filter(str_detect(station, "10|WS|16")) %>%
  mutate(
    diat  = diat1 + diat2,
    cyano = cyano2 + cyano4,
    hapt  = hapt6 + hapt8
  ) %>%
  # remove columns
  select(-c(diat1, diat2, cyano2, cyano4, hapt6, hapt8)) %>%
  pivot_longer(
    cols      = chloro:hapt,
    names_to  = "func_type",
    values_to = "conc"
  ) %>%
  reframe(
    pick(season),
    avg_conc = mean(conc),
    .by      = c(station, func_type, date_time_utc)
  ) %>%
  distinct()
```


```{r plt-stn-16, fig.width=30, fig.height=15}
# station 16 with diat and cyano
cmtx_longer3 %>% 
    filter(str_detect(func_type, "diat|cyano") & station == "16") %>% 
    ggplot(aes(x     = date_time_utc, 
               y     = avg_conc, 
               color = func_type, 
               fill  = func_type)
           ) +
    geom_point() +
    geom_line() +
    facet_wrap(facets = ~ "station") +
    ggthemes::theme_clean()
```





```{r diat-ts1}
# was commented out
aov(dino ~ season * as.factor(year),# + season:as.factor(year), 
    data = cmtx_avgs) %>%
    summary()

lm(chloro ~ season + year, 
   data = cmtx_avgs) %>%
    summary()

# this doesnt exists here `cmtx_longer`
# cmtx_kruskal2 <- 
    cmtx_long %>%
    filter(!is.na(func_type)) %>%
    group_by(func_type) %>%
    kruskal_test(conc ~ season_year) %>%
    arrange(desc(p))
```


```{r manova}
# cmtx_dunn2 <- 
    cmtx_long %>%
    group_by(func_type) %>%
    dunn_test(
        conc ~ season_year, 
        p.adjust.method = "bonferroni",
        detailed = TRUE
        ) %>%
    mutate(
        p     = num(p, digits = 3),
        p.adj = num(p.adj, digits = 3),
    ) %>%
    nest(.by = func_type) %$%
    walk2(
        .x = func_type,
        .y = data,
        (\(x, y) mutate(y, func_type = x,
                        .before = 1) %>%
             filter(p < 0.1) %>%
             # arrange(p) %>%
           print())
    )


# MANOVA test
cmtx_man <- 
  cmtx_avgs %>%
  select(chloro:last_col()) %>%
  as.matrix() 

manova(cmtx_man ~ season, data = cmtx_avgs) %>%
    summary()

cmtx_avgs %>%
  mutate(season_year = str_c(season, year(date_time_utc), sep = " "),
         .before = 2) %>%
  manova(cmtx_man ~ season_year, data = .) %>%
  summary()
```






```{r station-seasonally-yearly-avgs}
cmtx_avgs_new <-
  cmtx_avgs %>%
  mutate(
    diat  = diat1 + diat2,
    cyano = cyano2 + cyano4,
    hapt  = hapt6 + hapt8,
    total = chloro + crypto + diat + dino + hapt + pras + cyano
  )

cmtx_stat <-
  cmtx_avgs_new %>%
  summarise(
    across(
      chloro:hapt,
      list(
        avg = (\(x) mean(x, na.rm = TRUE)),
        sd  = (\(x) sd(x,   na.rm = TRUE)),
        var = (\(x) var(x,  na.rm = TRUE))
      )
    ),
    .by = c(year, season, station)
  )

cmtx_fract <-
  cmtx_avgs_new %>%
  mutate(
    season,
    station,
    across(chloro:hapt, ~ .x / total, .names = "frac_{.col}")
  ) %>%
  select(date_time_utc:season, frac_chloro:frac_pras) %>%
  pivot_longer(
    frac_chloro:frac_pras,
    names_to     = "func_type",
    values_to    = "frac",
    names_prefix = "frac_"
  )

max_fract <-
  cmtx_fract %>%
  summarise(
    max_frac = max(frac),
    .by = sample
  ) %>%
  left_join(cmtx_fract,
    by = c("max_frac" = "frac")
  )
```

# Table for Latitudes and Longitude
Not sure what this is used for?
```{r lat-lon-table}
lat_lon_dat <-
  pig_dat %>%
  filter(name_of_water_body == "Florida Keys") %>%
  distinct(station, lat, lon)

lat_lon_tbl <- 
  lat_lon_dat %>%
  gt(
    rowname_col   = "station",
    groupname_col = NULL
  ) %>%
  cols_label(
    lat = md("Latitude (&deg;)"),
    lon = md("Longitude (&deg;)")
  ) %>%
  tab_options(
    table_body.hlines.width = 0,
    table_body.vlines.width = 0,
    stub.border.width       = 0
  ) %>%
  opt_table_font("serif")

lat_lon_tbl

if (FALSE) {
  gtsave(
    lat_lon_tbl,
    filename = here(
      "data", "plots",
      glue(
        "lat_lon_table",
        "{format(Sys.time(), '_%Y%m%d_%H%M%S')}.html"
      )
    )
  )
}
```
