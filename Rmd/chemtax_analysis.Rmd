---
title: "Chemtax Analysis"
author: "Anna Finch"
date: '2022-06-24'
output: html_document
---
# ---- Setup ----
## Load libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
librarian::shelf(
    librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here,
    # broom # optional
    
    # additional
    rstatix, readxl, ggtext
    )

library("conflicted")

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

phyto_name <- 
    tibble(
        names = c("Chlorophytes", "Cryptophytes", "Cyanobacteria 2", 
                  "Cyanobacteria 4", "Diatoms 1", "Diatoms 2", 
                  "Dinoflagellates", "Haptophytes 6","Haptophytes 8", 
                  "Prasinophytes")
        )

file.chem <-
  fs::dir_ls(path    = here("data", "raw"),
             recurse = TRUE,
             regexp  = "mbonpig.*\\.xls$") %>% 
  str_sort() %>%
  tibble(files = .)
```

## Custom Plotting Functions 
```{r functions}
# line plot
line_plt <- function(.dat, .var, .title) {
    
    # set limits
    ylims <- c(0, max(.dat[[.var]]) * 1.05)
    brake <- pretty(ylims, 5)
    
    # plot
    .dat %>%
    ggplot(aes_string(x = "season", y = .var)) +
    geom_point(size = 2) +
    geom_line(group = 1, 
              size  = 1) +
    
    # labels
    labs(title = glue("Average Concentration per Season of {.title}"),
         x     = "Season",
         y     = "Concentration of Chlorophyll-a (mg m<sup>-3</sup>)"
         ) +
     
    # scale setup   
    scale_y_continuous(breaks = brake,
                       limits = ylims,
                       expand = expand_scale(mult = c(0, 0))
                       ) +
    
    # theme setup   
    theme_bw(base_family = "serif") +
    theme(
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      plot.title         = element_text(size = 15),
      axis.ticks.length  = unit(-0.05, "in"),
      axis.text.y       = element_text(margin = unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.title.y      = element_markdown(size = 10),
      axis.text.x       = element_text(margin = unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.ticks.x      = element_blank(),
      legend.background = element_rect(color = "black", fill = "white")
    )
}

# box plot
box_plt <- function(.dat, .var, .title) {
    
    # limits for plot
    ylims <-  c(0, quantile(.dat[[.var]], 0.99))
    brake <- pretty(ylims, 6)

    # plotting
    .dat %>%
    ggplot() +
    geom_boxplot(
                 aes_string(x = "season", y = .var),
                 outlier.shape = NA) +
    geom_jitter(
            aes_string(x = "season", y = .var, color = "year"),
            width = 0.4,
            size = 0.5
        ) +
    
    # labels
    labs(title = glue("Concentration of {.title} per Season "),
         x     = "Season",
         y     = "Concentration (mg m<sup>-3</sup>)",
         color = "Year") +

    # scale settings
    scale_color_binned(type = "viridis") +
    
    scale_y_continuous(breaks = brake,
                       expand = expand_scale(mult = c(0, 0)),
                       oob = scales::squish,
                       limits = ylims
                       ) +
    
    # theme settings
    theme_bw(base_family = "serif") +
    theme(
      panel.grid        = element_blank(),
      plot.title        = element_text(size = 15),
      axis.ticks.length = unit(-0.05, "in"),
      axis.text.y       = element_text(margin = unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.title.y      = element_markdown(size = 10),
      axis.text.x       = element_text(margin = unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.ticks.x      = element_blank(),
      legend.background = element_rect(color = "black", fill = "white")
    )
}
```


# ---- Line Plot ----
## Load Average Phytoplankton Concentrations from CHEMTAX 
```{r load-avg-phyto-data}
cmtx_all <- 
    file.chem %>%
    filter(str_detect(files, "cluster")) %>%
    mutate(
      filename = basename(files) %>% tools::file_path_sans_ext(),
      ranges   = c("D177:N178", "D273:N274", "D241:N242", "D305:N306"),
      cluster  = str_trunc(filename, 1, "left", ellipsis = ""),
      season   = fct_inorder(c("Winter", "Spring", "Summer", "Autumn")),
      data     = map2(files, ranges, 
                      ~ read_xls(
                          path = .x,
                          sheet = 2,
                          range = .y,
                          .name_repair = janitor::make_clean_names
                          ))
      ) %>%
  select(-c(1:ranges))  %>%
  unnest(data)

# ---- phyto full names ----
phyto_name <- 
    phyto_name %>%
    bind_cols(shrt = names(cmtx_all)[-c(1:3)]) %>%
    # add rows for combined name
    add_row(shrt  = c("cyano", "diat", "hapt"),
            names = c("Cyanobacteria", "Diatom", "Haptophyte"))
```

```{r line-plt}
# ---- avg season line plots ----
cmtx_all <- cmtx_all %>%
    select(-rms) %>%
    pivot_longer(
                 cols      = -c(1:2),
                 names_to  = "phyto",
                 values_to = "avg_conc"
    )  %>%
    group_by(phyto) %>%
    nest() %>%
    left_join(phyto_name, by = c("phyto" = "shrt")) %>%
    mutate(
        plt = map2(data, names, ~ line_plt(.dat = .x, 
                                           .var = "avg_conc", 
                                           .title = .y))
    )

cmtx_all$plt
rm(cmtx_all)
```
# ---- Box Plots ----
## Load All Phytoplankton Concentrations
```{r load-comb-data}
cmtx_avgs_raw <- 
    pull(file.chem, files)[5] %>%
    readxl::read_xls(.,
                     sheet = 1,
                     .name_repair = janitor::make_clean_names
                     )

meta_data <-
    here("data", "processed", "combined_pig_dat.csv") %>%
    read.csv() %>% 
    select(
        hplc_gsfc_id:filter_storage_before_shipment_to_gfsc,
        comments, season
        ) %>%
    filter(name_of_water_body == "Florida Keys") %>%
    mutate(
        season = fct_inorder(season),
        season = fct_relabel(season, ~ c("Winter", 
                                         "Spring", 
                                         "Summer", 
                                         "Autumn"))
    )
    

cmtx_avgs <-
    full_join(meta_data, cmtx_avgs_raw, by = c("sample" = "sample_id")) 

# removing duplicates
cmtx_avgs_no_dupes <- 
    cmtx_avgs %>%
    
    group_by(date_time_utc, station, depth) %>%
    summarise(
        across(1:cluster_code),
        across(chloro:pras,mean, na.rm = TRUE)) %>%
    distinct(date_time_utc, station, depth, .keep_all = TRUE) %>%
    ungroup()


if (!fs::file_exists(here("data", "processed", "chemtax_w_meta.csv")) |
    !fs::file_exists(here("data", "processed", "chemtax_w_meta_rm_dup.csv"))) {
    
    cmtx_avgs <- cmtx_avgs %>%
    
        # pivot longer
        pivot_longer(
                     cols = chloro:pras,
                     names_to = "phyto",
                     values_to = "conc"
        ) %>%
        left_join(phyto_name, by = c("phyto" = "shrt"))
    
    write_csv(cmtx_avgs, 
              here("data", "processed", "chemtax_w_meta.csv"))
    
    write_csv(cmtx_avgs_no_dupes, 
              here("data", "processed", "chemtax_w_meta_rm_dup.csv"))
    
    
} else {
    cli::cli_alert_info(c("Skipping saving of ",
                        "{.file chemtax_with_metadata.csv} ", 
                        "because already exists!"))
}

cmtx_avgs <- cmtx_avgs_no_dupes %>%
    # pivot longer
    pivot_longer(
                 cols = chloro:pras,
                 names_to = "phyto",
                 values_to = "conc"
    ) %>%
    left_join(phyto_name, by = c("phyto" = "shrt"))

cmtx_avgs_w <- cmtx_avgs_no_dupes

rm(file.chem, meta_data, cmtx_avgs_raw, cmtx_avgs_no_dupes)
```

## Plot
```{r boxplots}
# ---- avg season line plots ----
cmtx_avgs_plt <-
    cmtx_avgs %>%
    group_by(phyto, names) %>%
    nest() %>%
    
    mutate(
        plt = map2(data, names, ~ box_plt(.dat = .x, 
                                          .var = "conc", 
                                          .title = .y))
    ) 

cmtx_avgs_plt$plt
```

# ---- PFT multi-plots ----
## PFTs with a more dynamic range of values
```{r box-lg-dynm, fig.height=6, fig.width=10}
box_lg <- cmtx_avgs %>%
    filter(!phyto %in% c("chloro", "crypto", "diat1", "diat2", "dino", "pras")) %>%
    ggplot(aes(x    = season, 
               y    = conc, 
               fill = season)) +
    geom_boxplot(outlier.shape = NA) +
    

    scale_y_continuous(expand = c(0,0), 
                       limits = c(0, 0.2),
                       oob    = scales::squish) +
    labs(x = "Season",
         y = "Concentration of Chlorophyll-a (mg m<sup>-3</sup>)"
         ) +
    
    facet_wrap(facet = ~ names, ncol = 2) +
    
    theme_classic() +
    theme(text            = element_text(family = "serif", size = 18),
          axis.text       = element_markdown(size = 10),
          axis.title.y    = element_markdown(size = 10),
          legend.position = "none") 

box_lg
```

## PFTs with a more dynamic range of values
```{r box-sm-dynm, fig.height=6, fig.width=10}
box_sm <-
    cmtx_avgs %>%
    filter(!phyto %in% c("cyano2", "chloro", "hapt6")) %>%
    
    ggplot(aes(x    = season, 
               y    = conc, 
               fill = season)) +
    
    geom_boxplot(outlier.shape = NA) +
    
    scale_y_continuous(expand = c(0,0), 
                       limits = c(0, 0.1),
                       oob    = scales::squish) +
    
    # labels
    labs(x = "Season",
         y = "Concentration of Chlorophyll-a (mg m<sup>-3</sup>)"
         ) +
    
    facet_wrap(facet = ~ names, ncol = 3) +
    
    # theme
    theme_classic() +
    theme(text            = element_text(family = "serif", size = 18),
          axis.text       = element_text(size = 12),
          axis.title.y    = element_markdown(size = 10),
          legend.position = "none") 

box_sm
```

## Save Large and Small Range Boxplots
```{r save-plt}
if (FALSE) {
    save_plot(
    filename    = here("data", "plots", "boxplots",
                    glue("cmtx_boxplots_lg", 
                         format(Sys.time(), '_%Y%m%d_%H%M%S'),
                          ".jpg")), 
    plot        = box_lg,
    base_height = 6,
    base_width  = 10,
    dpi         = 600, 
    units       = "in", 
    device      = "png")

   save_plot(
        filename    = here("data", "plots", "boxplots",
                           glue(
                               "cmtx_boxplot_sm",
                               format(Sys.time(), '_%Y%m%d_%H%M%S'),
                               ".jpg"
                           )),
        plot        = box_sm,
        base_height = 6,
        base_width  = 10,
        dpi         = 600,
        units       = "in",
        device      = "png"
    )
} else {
    cli::cli_alert_info(c("Skipping saving of {.file cmtx_boxplot} ",
                          "because set to {.var FALSE}"))
}
```

# ---- Perform Kruskal-Wallis and Dunn Test ----
PFT on season
```{r kruskal-and-dunn}
cmtx_kruskal <-
    cmtx_avgs %>% 
    group_by(phyto) %>% 
    kruskal_test(conc ~ season)

    filter(cmtx_kruskal, p > 0.05) %>%
    pull(phyto)

p_gt_05 <- filter(cmtx_kruskal, p > 0.05) %>% pull(phyto)

cmtx_dunn <-
    cmtx_avgs %>%
    filter(!(phyto %in% p_gt_05)) %>% 
    group_by(phyto) %>%
    dunn_test(conc ~ season, 
              p.adjust.method = "bonferroni") 
p_gt_05
cmtx_kruskal
cmtx_dunn
```

```{r station-seasonally-yearly-avgs}
cmtx_avgs_w <- cmtx_avgs_w %>%
     # combine group into main group
    mutate(diat  = diat1 + diat2,
           cyano = cyano2 + cyano4,
           hapt  = hapt6 + hapt8,
           total = chloro + crypto + diat + dino + hapt + pras + cyano
           ) 

```
# ---- Plot Cyano and Diat vs time and station (10, 16, WS) ----
```{r plt-cyano-diat, fig.height=8, fig.width=16}
cmtx_season_avgs <- cmtx_avgs_w %>%
    group_by(season) %>% 
    summarise_at(vars(chloro:hapt),
                 list(avg = mean, 
                      sd  = sd, 
                      var = var),
                 na.rm = TRUE)

cmtx_fract <- 
    cmtx_avgs_w %>% 
    transmute(
        date_time_utc, year, season, station,
        across(1:season),
        across(c(pras:hapt, chloro, crypto, dino), ~ ./total,
               .names = "frac_{.col}")) 

cmtx_fract %>%
    pivot_longer(
        contains("frac"),
        names_to     = "phyto",
        values_to    = "frac",
        names_prefix = "frac_"
    ) %>%
    left_join(phyto_name, by = c("phyto" = "shrt")) %>%
    filter(phyto %in% c("diat", "cyano")) %>%
    filter(station %in% c("WS", "10", "16")) %>% 
    
    # plot  
    ggplot(aes(
        x = lubridate::ymd_hms(date_time_utc),
        y = frac,
        color = names,
        fill = names
    )) +
    geom_point() +
    geom_line() +
    facet_wrap(facets = "station") +
    theme_classic() +
    theme(text = element_text(family = "serif", size = 40),
          axis.text = element_text(size = 30),
          legend.position = c(0.5, 0.8)) +
    labs(x     = NULL, 
         y     = "Proportion to Total Chl-a",
         color = "Functional Type", 
         fill  = "Functional Type"
         )
```
```{r save-dia-cyano}
if (FALSE) {
    cowplot::save_plot(
        filename    = here("data", "plots", glue("phyto_bloom", ".jpg")), 
        plot        = last_plot(),
        base_height = 8,
        base_width  = 16,
        dpi         = 600, 
        units       = "in", 
        device      = "png")
} else {
    cli::cli_alert_info(c("Skipping saving of {.file cmtx_boxplot} ",
                          "because set to {.var FALSE}"))
}
```

# ---- View means of season and stations per PFT ----
```{r view-avgs}
# by season
cmtx_fract %>% 
    group_by(season) %>% 
    select(season, contains("frac")) %>%
    summarise(
        across(.cols  = contains("frac"), 
               mean, na.rm = TRUE,
               .names = "{.col}_avg"))  %>%
    View(title = "phyto_avg_by_season")

# by station
cmtx_fract %>% 
    mutate(station = forcats::fct_reorder(station, lon)) %>% 
    group_by(station) %>%
    summarise(
        across(.cols  = contains("frac"), 
               mean, na.rm = TRUE,
               .names = "{.col}_avg")) %>%
    View(title = "phyto_avg_by_station") 
```
# ---- PFT Fractions Plot ----
```{r config-frac}
cmtx_fract2 <- 
    cmtx_fract %>%
    group_by(season) %>%
    summarise(
         across(.cols = contains("frac"), mean, .names = "{.col}_avg")) %>%
    
    pivot_longer(
        contains("frac"),
        names_to     = "phyto",
        names_prefix = "frac_",
        values_to    = "avg_frac"
    ) %>%
    mutate(
        phyto = str_remove(phyto, "_avg")
    ) %>%
   left_join(phyto_name, by = c("phyto" = "shrt"))

cmtx_fract2
```

## Plot: Seasonal Fraction of each PFT
```{r plt-fracs, fig.width=16, fig.height=8}
# alternate color palette
# tol_muted <- c('#88CCEE', '#44AA99', '#117733', '#332288', '#DDCC77', '#999933',
#                '#CC6677', '#882255', '#AA4499')

tol_muted <- khroma::color("muted", names = FALSE)(9)

cmtx_fract2 %>% 
    ggplot(aes(
               fill  = names,
               color = names,
               y     = avg_frac,
               x     = season
    )) +
    geom_bar(position = "fill", 
             stat     = "identity") +
    
     labs(x    = "Season",
         y     = "Proportion to Total Chl-a",
         fill  = "Phytoplankton Functional Type",
         color = "Phytoplankton Functional Type") +
   
    scale_fill_manual(values  = tol_muted) +
    scale_color_manual(values = tol_muted) +
    
    # theme
    theme_classic() +
    theme(
        text             = element_text(family = "serif", size = 20),
        axis.title       = element_text(size = 20),
        legend.position  = "bottom",
        legend.direction = "horizontal"
    ) 
```
## Save seasonal faction of each PFT
```{r save-season-frac}
if (FALSE) {
    cowplot::save_plot(
        filename    = here("data", "plots", 
                           glue("phyto_func_type_bar_ratio_reason", 
                           format(Sys.time(), '_%Y%m%d_%H%M%S'),
                           ".jpg")), 
        plot        = last_plot(),
        base_height = 8,
        base_width  = 16,
        dpi         = 600, 
        units       = "in", 
        device      = "png")
} else {
    cli::cli_alert_info(c("Skipping saving of ",
                          "{.file phyto_func_type_bar_ratio_reason} ",
                          "because set to {.var FALSE}"))
}
```

# NOT USED: Table Test
```{r}
    # gt(
    #     rowname_col = NULL,
    #     groupname_col = NULL
    # ) %>% 
    # cols_label(
    #     frac_chloro_avg = "Chloro",
    #     frac_crypto_avg = "Crypto",
    #     frac_cyano_avg = "Cyano",
    #     frac_diat_avg = "Diat",
    #     frac_dino_avg = "Dino",
    #     frac_hapt_avg = "Hapt",
    #     frac_pras_avg = "Pras") %>% 
    # tab_options(
    #     table_body.hlines.width = 0,
    #     table_body.vlines.width = 0,
    #     stub.border.width = 0
    # ) %>%
    # # fmt_number(columns = starts_with("frac"), decimals = 4) %>% 
    # fmt_percent(columns = starts_with("frac"), decimals = 0) %>% 
    # tab_spanner(label = "Average Fraction",
    #             columns = frac_chloro_avg:frac_pras_avg) %>% 
    # tab_stubhead("Season") %>% 
    # opt_table_font("serif") %>% 
    # gtsave(filename = here("data", "plots", glue("community_fractions", 
    #        format(Sys.time(), '_%Y%m%d_%H%M%S'),
    #        ".html")))

```

