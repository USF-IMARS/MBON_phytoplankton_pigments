---
title: "Ordination"
author: "Anna Finch"
date: '2022-07-21'
output: html_document
---

# 1.0 ---- Summary of Document ----

# 2.0 ---- Setup ----

## 2.1 Load Libraries
```{r setup, include=FALSE}

librarian::shelf(
    librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here,
    # broom # optional
    
    # additional
    vegan, gavinsimpson/ggvegan, fawda123/ggord, jfq3/ggordiplots,
    GGally, cowplot, ggfortify, ape,
    ecodist # not sure if needed
)

library("conflicted")

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

source(here("scripts", "misc_functions.R"))
```

## 2.2 Load Dataset

Load data sets:
- CHEMTAX Seasonal Averages
- Surface Averaged CTD Data
- Merge CHETMAX-CTD

```{r chemtax-ctd}
dir_data_save <- here("data", "processed", "ordination")
dir_plt_save <- here("data", "plots", "ordination")

dir_create(here(dir_plt_save))

# set season names and order
szn <- c("Winter", "Spring", "Summer", "Autumn")

# CHEMTAX files
cmtx_avgs <- 
  here("data", "processed", "chemtax_analysis", "chemtax_w_meta_wide.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  mutate(season = fct_relevel(season, szn)) %T>% print()

# CTD data
ctd_dat_summary <- 
  rstudioapi::selectFile() %>%
  # here("data", "processed", "ctd_all.csv") %>%
  read_csv(show_col_types = FALSE) %T>% print()

# merge data
env_cmtx <-
  cmtx_avgs %>% 
  mutate(
    cruise_code = str_remove(sample, "(_|-).*"),
    .before = cruise) %>%
  left_join(
    ctd_dat_summary, 
    by = join_by(
      "cruise_code" == "cruise_id", 
      "station" == "stations"
      )
  ) %T>% print()

# find ones not matched
naniar::vis_miss(env_cmtx)
filter(env_cmtx, is.na(temp))


# ---- save CHEMTAX-CTD merged data
save_csv(
    .data          = env_cmtx,
    save_location  = dir_data_save,
    save_name      = "cmtx_env_data",
    overwrite      = FALSE,
    verbose        = TRUE,
    time_stamp_fmt = NULL
  )
```

# Create Matrix Version of CHEMTAX Seasonal Averages
```{r cmtx-convert-matrix}
cmtx_avgs <-
  cmtx_avgs %>%
  rownames_to_column(var = "row_num") %>%
  unite(
    "sample_code",
    row_num,
    season,
    remove = FALSE
  )

# convert to matrix
cmtx_data_matrix <-
  cmtx_avgs %>%
  select(sample_code, chloro:pras) %>%
  column_to_rownames(var = "sample_code")
```



# NOT USED: ---- PCoA ----
```{r Bray-Curtis-Dissimilarity-Matrix}
# cmtx_bray <- vegdist(cmtx_data_matrix, method = "bray")
# 
# cmtx_pcoa <- cmdscale(cmtx_bray, eig = TRUE)
# 
# ggords::ggpcoa(cmtx_pcoa, cmtx_data_matrix, )
#     
# 
# 
# pcoa <- pco(cmtx_bray, negvals = "zero", dround = 0)
# 
# plot(pcoa$vectors[,1], pcoa$vectors[,2], type = "p", xlab = "PCoA1", ylab = "PCoA2",
#  axes = TRUE, main = "PCoA on CHEMTAX data")
# 
# text(pcoa$vectors[,1], pcoa$vectors[,2], labels(cmtx_bray), 
#  cex = 0.9, xpd = TRUE)
# 
# 
# pcoa.var.per <- round(pcoa$value/sum(pcoa$value)*100, 1)
# 
# cmtx_val <-pcoa$vectors
# 
# pcoa.data <- data.frame(Sample = rownames(cmtx_val),
#                        X=cmtx_val[,1],
#                        Y=cmtx_val[,2]) %>% 
#     separate(Sample, c("row_num", "season"))
# 
# barplot(mds.var.per)
# 
# ggplot(data=pcoa, aes(x=vectors[,1], y=vectors[,2], color=season)) +
#   geom_point() +
#   theme_bw() +
#   xlab(paste("MDS1 - ", mds.var.per[1], "%", sep="")) +
#   ylab(paste("MDS2 - ", mds.var.per[2], "%", sep="")) +
#   ggtitle("MDS plot using avg(logFC) as the distance") 
# 
# pcoaVS$values # eigenvalue for each component. This is a measure of the variance explained by each dimension
# pcoaVS$vectors # eigenvectors. Each column contains the scores for that dimension.

# cmtx_data_matrix2 <- cmtx_avgs2 %>%
#     mutate(group = season) %>%
#     select(group, chloro:pras)
# ggpca::ggPCoA(cmtx_data_matrix2) +
#     theme_classic() +
#     theme(text=element_text(family="serif", size=20))

```


# ---- Run PCoA and PCA on CHEMTAX data ----

## Function to Calculate and Plot PCoA
Doesn't work too well
```{r func-ord-plot}
ggPCoA2 <- function(
        data, 
        pc = 12, 
        level = 0.68, 
        dist_meth = "bray"
        ) {
  
  # calc distance matrix  
  dis  <- 
    vegdist(
      data[, -1], 
      method = dist_meth, 
      na.rm  = TRUE)
  
  # PCoA
  pcoa <- pcoa(dis, correction = "none", rn = NULL)
  
  # Extract eignvalues
  eig  <- round(100 * pcoa$values[1:3, 2], 2)
  
  # site info?
  site <- pcoa$vectors[, 1:3]
  
  if (all(rownames(site) == rownames(data))) {
      
    pca.data <- data.frame(group = data$group, site)
    
    colnames(pca.data)[2:4] <- glue("PCoA{1:3}")
  }
  
  label <- data.frame(min = apply(pca.data[, 2:4], 2, min),
                      max = apply(pca.data[, 2:4], 2, max))
  
  label$mean <- (label$min + label$max)/2
  
  if (pc == 12) {
      x      <- "PCoA1"
      y      <- "PCoA2"
      x.posi <- label[1, 3]
      y.posi <- label[2, 2]
      x.lab  <- glue("{x} ({eig[1]}%)")
      y.lab  <- glue("{y} ({eig[2]}%)")
  } else if (pc == 13) {
      x      <- "PCoA1"
      y      <- "PCoA3"
      x.posi <- label[1, 3]
      y.posi <- label[3, 2]
      x.lab  <- glue("{x} ({eig[1]}%)")
      y.lab  <- glue("{y} ({eig[3]}%)")
  } else if (pc == 23) {
      x      <- "PCoA2"
      y      <- "PCoA3"
      x.posi <- label[2, 3]
      y.posi <- label[3, 2]
      x.lab  <- glue("{x} ({eig[2]}%)")
      y.lab  <- glue("{y} ({eig[3]}%)")
  }
  
  p <- 
      ggplot(
          data = pca.data, 
          aes(
              x     = x,
              y     = y, 
              color = group)
          ) +
      geom_point(
          aes(color = group),
          size  = 1.5, 
          alpha = 1
        ) +
      stat_ellipse(
          level       = level, 
          linetype    = 3, 
          geom        = "polygon", 
          alpha       = 0.02, 
          aes(fill = group), 
          show.legend = FALSE
          ) + 
      labs(
          x = x.lab,
          y = y.lab
      ) + 
       
      scale_color_discrete(name = "Season") +
      
      # theme
      theme_classic() +
      theme(
          text = element_text(family = "serif", size = 20),
          legend.position = c(0.1, 0.85)
          )
      
  return(p)
}
```

## Calculate and Plot 
```{r plt-pcoa-pca}
# ---- PCoA on PFT groups
cmtx_data_matrix2 <- 
    cmtx_avgs %>%
    mutate(group = season) %>%
    select(group, chloro:pras)

## calc and plot PCoA
pcoa_plt <- ggPCoA2(cmtx_data_matrix2)

# ---- PCA on environmental CTD
# temp, par and sal
env_data_matrix <- 
    env_cmtx %>% 
    # mutate(group = season) %>% 
    select(temp, par, sal, season) %>% 
    na.omit()

## calc PCA 
env_pca <- prcomp(env_data_matrix[1:3], scale. = TRUE)

## plot PCA
pca_plt <-
  autoplot(
    env_pca,
    data   = env_data_matrix,
    colour = "season"
  ) +
  scale_colour_discrete(name = "Season") +
  theme_classic() +
  theme(
    text = element_text(family = "serif", size = 20),
    legend.position = "bottom"
  )

    
pcoa_plt   
pca_plt
```

## Save PCA and PCoA
```{r save-pcoa-pca}
# save arguments
sv_arg <-
  list(
    sv_loc    = dir_plt_save,
    sv_nm     = c("pca", "pcoa"),
    overwrite = FALSE
  ) %>%
  c(
    .,
    pca = dir_ls(.$sv_loc,
                 regexp = .$sv_nm[1]) %>% is_empty(),
    pcoa = dir_ls(.$sv_loc,
                 regexp = .$sv_nm[2]) %>% is_empty()
  )

# ---- save PCA
if (sv_arg$pca | sv_arg$overwrite) {
  save_gg(
    plt            = pca_plt, # edit if want specific plot
    save_location  = sv_arg$sv_loc,
    save_name      = sv_arg$sv_nm[1],
    verbose        = TRUE,
    time_stamp_fmt = "%Y%m%d_%H%M%S",
    device         = "jpeg",
    height         = 9.7,
    width          = 19,
    dpi            = 600,
    units          = "in",
    bg             = "white"
  )
} else {
  cli::cli_alert_info(
    c(
      "Skipping saving of {.file {sv_arg$sv_nm}} ",
      "because exists ",
      "and/or overwrite is set {.var FALSE}"
    )
  )
}

rm(sv_arg)


# ---- save PCoA
if (sv_arg$pcoa | sv_arg$overwrite) {
  save_gg(
    plt            = pcoa_plt, 
    save_location  = sv_arg$sv_loc,
    save_name      = sv_arg$sv_nm[2],
    verbose        = TRUE,
    time_stamp_fmt = "%Y%m%d_%H%M%S",
    device         = "jpeg",
    height         = 9.7,
    width          = 19,
    dpi            = 600,
    units          = "in",
    bg             = "white"
  )
 )
} else {
    cli_alert_info(
        c(
          "Skipping saving of ",
          "{.file {sv_arg$sv_nm[2]}} ",
          "because exists ",
          "and/or overwrite = {.var FALSE}"
        )
    )
}
rm(sv_arg)
```

# ---- Pairwise Permanova Test ----
```{r permanova}
set.seed(1082002)
all_test_env <-
  adonis2(
    env_data_matrix[1:3] ~ season,
    data   = env_data_matrix,
    method = "bray"
  )

all_test <-
  adonis2(
    cmtx_data_matrix ~ season,
    data   = cmtx_avgs,
    method = "bray"
  )
   
# ---- function
# run adonis2 on
szn_adonis2 <- function(
        .data, 
        pair_col, 
        pairs, 
        formula = NULL, # something like "season * station" 
        dist_method = "bray") {
    # browser()
    pair_name <- str_flatten(pairs, collapse = "|")
    
    dat_pair  <- 
        filter(
            .data, 
            str_detect( !!sym(pair_col),
            pair_name))
    
    value <- select(dat_pair, chloro:pras)

    adon_test <- adonis2(
        formula = as.formula(paste("value ~", formula)), 
        data   = dat_pair, 
        method = dist_method
        # strata = # should probably add something here
        )   
    
    pairwise_p <- adon_test[["Pr(>F)"]][1]
    pairwise_p
}

# create combinations of season to pairwise test
cross_pairs <- 
    cmtx_avgs %>%
    select(season) %$%
    combn(unique(as.character(season)), 2) %>%
    t()

colnames(cross_pairs) <- c("szn1", "szn2")

cross_pairs <- 
    cross_pairs %>% 
    as_tibble() %>%
    unite(season_pairs, szn1, szn2, sep = "|")

set.seed(1234)
cross_pairs %>%
    mutate(
       pairwise_p = map_dbl(
           .x = season_pairs,
           # .data = cmtx_avgs,
           .f = ~ szn_adonis2(.data = cmtx_avgs, "season", pairs = .x, "season"),
           .data = cmtx_avgs
       ),
       
      # ---- correct p-values
      p_adjust = p.adjust(pairwise_p, method = "bonferroni")     
    )


```

# CCA Analysis 
```{r cca, fig.height=9.7, fig.width=19}
# extrafont::font_import()
cca_matrix <- select(env_cmtx, chloro:pras)

cmtx_cca <- cca(cca_matrix ~ temp +sal + par, 
                data      = env_cmtx, 
                na.action = na.omit)

plot(cmtx_cca, scaling = 1)

new_lab <- list(temp = "Temp",
                sal  = "Sal", 
                par  = "PAR")

tol_muted2 <- c('#88CCEE', '#44AA99', '#117733', '#332288')

cca_plt <-
    ggord(
        cmtx_cca,
        size      = 4,
        grp_in    = env_cmtx %>% drop_na(temp, par:sal) %$% as.factor(season),
        ellipse   = FALSE,
        ptslab    = TRUE,
        addsize   = 6,
        ylim      = c(-6.25, 6.25),
        xlim      = c(-4, 5),
        repel     = TRUE,
        txt       = 6,
        vec_lab   = new_lab,
        grp_title = "Season"
        ) +
    theme_classic() +
    theme(text = element_text(family = "serif", size = 20),
          legend.position = "bottom")

cca_plt

gg_ordiplot(
  ord     = cmtx_cca,
  groups  = # extract seasons
    env_cmtx %>%
      drop_na(temp, par:sal) %$% 
      as.factor(season),
  scaling = 1
)

if (FALSE) {
        save_plot(
        filename = 
            here("data", "plots",
                 glue("cca",
                      format(Sys.time(), "_%Y%m%d_%H%M%S"),
                      ".jpeg")),
        plot        = cca_plt,
        base_height = 9.7,
        base_width  = 19,
        dpi         = 600, 
        units       = "in", 
        device      = "jpeg")
}
```


```{r ctd-plt}
ggplot(env_cmtx) +
    geom_boxplot(aes(y = par)) +
    facet_wrap(facet =  ~ season)


ggplot(env_cmtx) +
    geom_point(aes(x = date_time_utc, y = par, 
                   color = season)) 
# env_cmtx %>%
#     # select(-c(cruise_code, indx, cruise.y)) %>%
#     ggpairs(columns = 27:41, 
#             mapping = aes(color = season))
```





# STOP: Not sure what's beyond






```{r func-ord-plot}

neword <- function(ord_in, grp_in = NULL, axes = c("1", "2"), ...) {
    axes       <- glue("CCA {axes}")
    obs        <- data.frame(ord_in$CCA$wa[, axes])
    obs$Groups <- grp_in
    addpts     <- data.frame(ord_in$CCA$v[, axes])
    constr     <- data.frame(ord_in$CCA$biplot[, axes])
    exp_var    <- summary(ord_in, scaling = 1)$concont$importance[2, axes]
    axes       <- glue("{axes} ({round(100 * exp_var, 2)}%)")
    
    names(obs)[1:2] <- axes
    ggord:::ggord.default(obs, 
                          vecs = constr, 
                          axes, 
                          addpts = addpts, ...)
}

neword(cmtx_cca)
```
# ??? This function doesn't have a name
```{r}
function(ord,
         groups,
         scaling     = 1,
         choices     = c(1, 2),
         kind        = c("sd", "se", "ehull"),
         conf        = NULL,
         show.groups = "all",
         ellipse     = TRUE,
         label       = FALSE,
         hull        = FALSE,
         spiders     = FALSE,
         pt.size     = 3,
         plot        = TRUE) {
    
    groups <- as.factor(groups)
    if (show.groups[1] == "all") {
        show.groups <- as.vector(levels(groups))
    }
    
    df_ord <- vegan::scores(ord, display = "sites", scaling = scaling, 
        choices = choices)
    
    axis.labels <- ord_labels(ord)[choices]
    
    df_ord <- data.frame(x     = df_ord[, 1], 
                         y     = df_ord[, 2], 
                         Group = groups)
    
    df_mean.ord <- aggregate(df_ord[, 1:2], 
                             by = list(df_ord$Group), 
                             mean)
    
    colnames(df_mean.ord) <- c("Group", "x", "y")
    
    df_mean.ord <- df_mean.ord[df_mean.ord$Group %in% show.groups, ]
    
    if (is.null(conf)) {
        rslt <- vegan::ordiellipse(
            ord, 
            groups      = groups, 
            display     = "sites", 
            scaling     = scaling, 
            choices     = choices, 
            kind        = kind, 
            show.groups = show.groups, 
            draw        = "none", 
            label       = label)
    } else {
        rslt <- vegan::ordiellipse(
            ord, 
            groups      = groups, 
            display     = "sites", 
            scaling     = scaling,
            choices     = choices, 
            kind        = kind, 
            show.groups = show.groups, 
            draw        = "none", 
            conf        = conf, 
            label       = label)
    }
    
    df_ellipse <- data.frame()
    
    for (g in show.groups) {
        
        df_ellipse <- rbind(
            df_ellipse,
            cbind(as.data.frame(with(df_ord[df_ord$Group == g, ], 
            vegan:::veganCovEllipse(rslt[[g]]$cov, 
                                    rslt[[g]]$center, 
                                    rslt[[g]]$scale
                                    ))), 
            Group = g))
    }
    colnames(df_ellipse) <- c("x", "y", "Group")
    
    df_ellipse <- df_ellipse[, c(3, 1, 2)]
    
    rslt.hull <- vegan::ordihull(
        ord, 
        groups      = groups, 
        scaling     = scaling, 
        choices     = choices, 
        show.groups = show.groups, 
        draw        = "none")
    
    df_hull <- data.frame()
    df_temp <- data.frame()
    
    for (g in show.groups) {
        x       <- rslt.hull[[g]][, 1]
        y       <- rslt.hull[[g]][, 2]
        Group   <- rep(g, length(x))
        df_temp <- data.frame(Group = Group, 
                              x     = x, 
                              y     = y)
        df_hull <- rbind(df_hull, df_temp)
    }
    
    df_spiders        <- df_ord
    df_spiders$cntr.x <- NA
    df_spiders$cntr.y <- NA
    
    for (g in show.groups) {
        df_spiders[which(df_spiders$Group == g), 4:5] <- df_mean.ord[which(df_mean.ord == g), 2:3]
    }
    
    df_spiders <- df_spiders[, c(3, 4, 5, 1, 2)]
    df_spiders <- df_spiders[order(df_spiders$Group), ]
    df_spiders <- df_spiders[df_spiders$Group %in% show.groups, ]
    
    xlab <- axis.labels[1]
    ylab <- axis.labels[2]
    
    plt <- 
        ggplot() + 
        geom_point(data = df_ord, 
                   aes(x     = x, 
                       y     = y, 
                       color = Group), 
                   size = pt.size) + 
        labs(
            x = xlab,
            y = ylab
        )

    if (ellipse == TRUE) {
        plt <- 
            plt + 
            geom_path(data = df_ellipse, 
                      aes(x     = x, 
                          y     = y, 
                          color = Group), 
                      show.legend = FALSE)
    }
    
    if (label == TRUE) {
        plt <- 
            plt + 
            geom_text(data = df_mean.ord, 
                      aes(x = x, 
                          y = y, 
                          label = Group, 
                          color = Group), 
                      show.legend = FALSE)
    }
    
    if (hull == TRUE) {
        plt <- 
            plt + 
            geom_path(data = df_hull, 
                      aes(x = x, 
                          y = y, 
                          color = Group),
                      show.legend = FALSE)
    }
    if (spiders == TRUE) {
        plt <- plt + 
            geom_segment(data = df_spiders, 
                         aes(x     = cntr.x,
                             xend  = x, 
                             y     = cntr.y, 
                             yend  = y, 
                             color = Group), 
                         show.legend = FALSE)
    }
    
    plt <- plt + coord_fixed(ratio = 1)
    
    if (plot) {
        print(plt)
    }
    
    invisible(list(
        df_ord      = df_ord, 
        df_mean.ord = df_mean.ord, 
        df_ellipse  = df_ellipse, 
        df_hull     = df_hull, 
        df_spiders  = df_spiders, 
        plot        = plt
        ))
}
```


```{r}
cca_new <- vegan::scores(
    cmtx_cca, 
    display = "sites", 
    scaling = 1, 
    choices = c(1, 2))

ggord(cca_new, size = 1.5, 
      grp_in = env_cmtx %>% drop_na(temp,par:sal) %$% as.factor(season),
      ellipse = FALSE, 
      ptslab = TRUE, 
      addsize = 4, 
      ylim = c(-6.25, 6.25), 
      xlim = c(-5, 5))
```