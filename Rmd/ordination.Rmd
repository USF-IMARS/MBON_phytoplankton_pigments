---
title: "Ordination"
author: "Anna Finch"
date: '2022-07-21'
output: html_document
---

# 1.0 ---- Summary of Document ----

# 2.0 ---- Setup ----

## 2.1 Load Libraries
```{r setup, include=FALSE}
if (!nzchar(system.file(package = "librarian"))) 
    install.packages("librarian")

librarian::shelf(
    quiet = TRUE,
    librarian, conflicted, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here,
    # broom # optional
    
    # additional
     vegan, gavinsimpson/ggvegan, fawda123/ggord, jfq3/ggordiplots,
    GGally, cowplot, ggfortify, ape,
    ecodist # not sure if needed
)

conflicts_prefer(
    dplyr::filter(), 
    dplyr::select()
    )

source(here("scripts", "misc_functions.R"))
```

## 2.2 Load Dataset

Load data sets:
- CHEMTAX Seasonal Averages created in `04_chemtax_analysis.Rmd`
- Surface Averaged CTD Data created in `02_ctd_download.Rmd`
- Merge CHETMAX-CTD

```{r chemtax-ctd}
dir_data_save <- here("data", "processed", "ordination")
dir_plt_save  <- here("data", "plots", "ordination")

dir_create(here(dir_plt_save))

# set season names and order
szn <- c("Winter", "Spring", "Summer", "Autumn")

# CHEMTAX files
cmtx_avgs <- 
  here("data", "processed", "chemtax_analysis", "chemtax_w_meta_wide.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  mutate(season = fct_relevel(season, szn)) %T>% print()

# CTD data
ctd_dat_summary <- 
  here("data", "processed", "ctd", "ctd_all.csv") %>%
  read_csv(show_col_types = FALSE)  %>%
  mutate(time = ymd_hms(time)) %T>% print()

# merge data
env_cmtx <-
  cmtx_avgs %>% 
  left_join(
    ctd_dat_summary, 
    by = join_by(
      "cruise_id" == "cruise_id", 
      "station" == "station"
      )
  ) %T>% print()

env_cmtx %>%
    janitor::get_dupes(cruise_id, station) #%>%
    # filter(!str_detect(station, "MR|LK|WS"))

# find unmatched PFT rows
# WS16130 doesnt exists
# SV18067 - no CTD data available
# WS18218 - only a few exist
naniar::vis_miss(env_cmtx)

filter(env_cmtx, is.na(file)) %>%
  arrange(date_time_utc) %T>% print() %>% 
  distinct(., cruise_id) %T>% print()

# ---- save CHEMTAX-CTD merged data
save_csv(
    .data          = env_cmtx,
    save_location  = dir_data_save,
    save_name      = "cmtx_env_data",
    overwrite      = FALSE,
    # overwrite      = TRUE,
    verbose        = TRUE,
    time_stamp_fmt = NULL
  )
```

# Create Matrix Version of CHEMTAX Seasonal Averages
```{r cmtx-convert-matrix}
cmtx_avgs <-
  cmtx_avgs %>%
  rowid_to_column() %>%
  unite(
    "sample_code",
    rowid,
    season,
    remove = FALSE
  ) %>%
  select(-rowid)


# convert to matrix
cmtx_data_matrix <-
  cmtx_avgs %>%
  select(sample_code, chloro:pras) %>%
  column_to_rownames(var = "sample_code") %T>% print()
```



# NOT USED: ---- PCoA ----
```{r Bray-Curtis-Dissimilarity-Matrix}
# cmtx_bray <- vegdist(cmtx_data_matrix, method = "bray")
# 
# cmtx_pcoa <- cmdscale(cmtx_bray, eig = TRUE)
# 
# ggords::ggpcoa(cmtx_pcoa, cmtx_data_matrix, )
#     
# 
# 
# pcoa <- pco(cmtx_bray, negvals = "zero", dround = 0)
# 
# plot(pcoa$vectors[,1], pcoa$vectors[,2], type = "p", xlab = "PCoA1", ylab = "PCoA2",
#  axes = TRUE, main = "PCoA on CHEMTAX data")
# 
# text(pcoa$vectors[,1], pcoa$vectors[,2], labels(cmtx_bray), 
#  cex = 0.9, xpd = TRUE)
# 
# 
# pcoa.var.per <- round(pcoa$value/sum(pcoa$value)*100, 1)
# 
# cmtx_val <-pcoa$vectors
# 
# dat_pcoa <- data.frame(Sample = rownames(cmtx_val),
#                        X=cmtx_val[,1],
#                        Y=cmtx_val[,2]) %>% 
#     separate(Sample, c("rowid", "season"))
# 
# barplot(mds.var.per)
# 
# ggplot(data=pcoa, aes(x=vectors[,1], y=vectors[,2], color=season)) +
#   geom_point() +
#   theme_bw() +
#   xlab(paste("MDS1 - ", mds.var.per[1], "%", sep="")) +
#   ylab(paste("MDS2 - ", mds.var.per[2], "%", sep="")) +
#   ggtitle("MDS plot using avg(logFC) as the distance") 
# 
# pcoaVS$values # eigenvalue for each component. This is a measure of the variance explained by each dimension
# pcoaVS$vectors # eigenvectors. Each column contains the scores for that dimension.

# cmtx_data_matrix2 <- cmtx_avgs2 %>%
#     mutate(group = season) %>%
#     select(group, chloro:pras)
# ggpca::ggPCoA(cmtx_data_matrix2) +
#     theme_classic() +
#     theme(text=element_text(family="serif", size=20))

```


# ---- Run PCoA and PCA on CHEMTAX data ----

## Function to Calculate and Plot PCoA
Doesn't work too well
```{r func-ord-plot}
#' Plot PCoS using `ggplot2`
#'
#' FUNCTION_DESCRIPTION
#'
#' @param data A data.frame or tibble with 1 grouping column and any number of 
#'             numeric columns
#' @param .group_var A grouping variable to add color to plot
#' @param pc The principal components to plot
#' @param level Confidence interval for ellipsis on grouping variable
#' @param dist_meth Distance metric Default: "bray"
#' @param .correct Correction method given to the function `pcoa`
#'                 Default: "none"
#'
#' @return RETURN_DESCRIPTION
#' @examples
#' # ADD_EXAMPLES_HERE
#' 
gg_pcoa2 <- function(
  data, 
  Y = data,
  .group_var = "group",
  pc        = c(1, 2),
  level     = 0.68, 
  dist_meth = "bray",
  .correct = c("none", "lingoes", "caillies")
  ) {
 
  .correct <- match.arg(.correct)    
       
  stopifnot(length(pc) == 2)  
  stopifnot(between(pc[1], 1, nrow(data)) & pc[1] != pc[2])
  stopifnot(between(pc[2], 1, nrow(data)) & pc[2] != pc[1]) 
 
  # calc distance matrix  
  pcoa <- 
    vegdist(
      data[, -1], 
      method = dist_meth, 
      na.rm  = TRUE) %>%
  
    # run PCoA
    pcoa( correction = .correct, rn = NULL)
  

  # extract eignvalues
  eig  <- 
    pcoa$values[, 2] %>%
    tibble(eigen = .) %>%
    mutate(
      eig_pct  = scales::label_percent(0.1)(eigen),
      col_name = glue("PCoA{row_number()}"),
      labels   = glue("{col_name} ({eig_pct})")
    )

  # extract site values
  dat_pcoa <- 
    as_tibble(pcoa$vectors) %>%
    bind_cols("group" = data[[.group_var]], .) %>%
    rename_with(
      .cols = contains("Axis"),
      .fn   = \(x) str_replace(x, "Axis\\.", "PCoA")
    )
       
  # extract column names for x and y axis
  x_var <- eig[pc[1], 3][[1]]
  y_var <- eig[pc[2], 3][[1]]
 
  Y <- select(Y, -{{.group_var}})

    pr.coo <- pcoa$vectors
    # if (x$correction[2] > 1) 
    #     pr.coo <- x$vectors.cor
    k <- ncol(pr.coo)
    diag.dir <- diag(c(dir.axis1 = pc[1], dir.axis2 = pc[2]))
    plot.axes <- pc
    pr.coo[, plot.axes] <- pr.coo[, plot.axes] %*% diag.dir
        
    n <- nrow(Y)
    points.stand <- scale(pr.coo[, plot.axes])
    S <- cov(Y, points.stand)
    
    U <- 
      S %*% diag((x$values$Eigenvalues[plot.axes]/(n - 1))^(-0.5))
    
    colnames(U) <- colnames(pr.coo[, plot.axes])
    
   # browser()
  
  # plot PCoA
  plt <- 
      ggplot(
          data = dat_pcoa, 
          aes(
              x     = .data[[x_var]],
              y     = .data[[y_var]], 
              color = group)
          ) +
      geom_vline(
        xintercept = 0, 
        color      = "grey70", 
        linetype   = "dashed", 
        alpha      = 0.5
        ) +
      geom_hline(
        yintercept = 0, 
        color      = "grey70", 
        linetype   = "dashed", 
        alpha      = 0.5
        ) +
      geom_point(
          aes(color = group),
          size  = 1.5, 
          alpha = 1
        ) +
      stat_ellipse(
          aes(fill = group), 
          level       = level, 
          linetype    = 3, 
          geom        = "polygon", 
          alpha       = 0.02, 
          show.legend = FALSE
          ) + 
      labs(
        x = eig$labels[pc[1]],
        y = eig$labels[pc[2]]
      ) + 
       
      scale_color_discrete(name = "Season") +
      
      # theme
      theme_classic(base_family = "serif", base_size = 20) +
      theme(
          legend.position = "top"
          ) +
      geom_segment(data = as.data.frame(U), 
                   aes(
                       x = 0, xend = Axis.1,
                       y = 0, yend = Axis.2,
                       ),
                   inherit.aes = FALSE)
    
   return(plt)
  return(
    list(
      "plt"         = plt,
      "eigenvalues" = eig,
      "pcoa_data"   = dat_pcoa,
      "other"       = pcoa
      )
    )
  
  # ---- end of function gg_pcoa2
}
```

## Calculate and Plot 
```{r plt-pcoa-pca}
# ---- PCoA on PFT groups
cmtx_data_matrix2 <-
    env_cmtx %>%
    drop_na(chloro:pras, pressure:sal) %>% 
    # filter(if_any(all_of(chloro:pras, pressure:sal), ~ !is.na))
    distinct(sample, .keep_all = TRUE)  %>%
    mutate(group = season) 



## calc and plot PCoA
# pcoa_plt <-
  select(cmtx_data_matrix2, group, chloro:pras) %>%
  gg_pcoa2(
                    pc = c(1, 2),
            .correct = "none")

env_scaled <- 
cmtx_data_matrix2 %>%
    drop_na(chloro:pras, temp:sal) %>%
    select(pressure:sal) %>%
    mutate(
      across(everything(), ~ scale(.)  %>% as.vector())
    ) %>%
    vegdist(., method = "euclidean")


pcoa_plt$other %>%
  ape::biplot.pcoa(
    plot.axes = c(1, 2),
    Y = cmtx_data_matrix2 %>%
      drop_na(chloro:pras, temp:sal) %>%
      select(chloro:pras) #%>%
      # mutate(across(everything(), ~ scale(.) %>% as.vector()))
  )

    Y = cmtx_data_matrix2 %>%
      drop_na(chloro:pras, temp:sal) %>%
      select(chloro:pras) #%>%
x <- pcoa_plt$other

    pr.coo <- x$vectors
    # if (x$correction[2] > 1) 
    #     pr.coo <- x$vectors.cor
    k <- ncol(pr.coo)
    diag.dir <- diag(c(dir.axis1 = 1, dir.axis2 = 2))
    plot.axes <- c(1, 2)
    pr.coo[, plot.axes] <- pr.coo[, plot.axes] %*% diag.dir
        
    n <- nrow(Y)
    points.stand <- scale(pr.coo[, plot.axes])
    S <- cov(Y, points.stand)
    
    U <- 
      S %*% diag((x$values$Eigenvalues[plot.axes]/(n - 1))^(-0.5))
    
    colnames(U) <- colnames(pr.coo[, plot.axes])
    
    
    par(mai = c(1, 0.5, 1.4, 0))
    
    # plot using stats::biplot
    biplot(pr.coo[, plot.axes], U)#, xlab = labels[1], ylab = labels[2])
    
    
    # title
    if (is.null(main)) {
        title(main = c("PCoA biplot", "Response variables projected", 
            "as in PCA with scaling 1"), line = 4)
    } else {
        title(main = main, family = "serif")
    }
    # if (k < 2) 
    #     stop("There is a single eigenvalue. No plot can be produced.")
    # if (k < plot.axes[1]) 
    #     stop("Axis", plot.axes[1], "does not exist.")
    # if (k < plot.axes[2]) 
    #     stop("Axis", plot.axes[2], "does not exist.")
    # if (!is.null(rn)) 
    #     rownames(pr.coo) <- rn
    # labels = colnames(pr.coo[, plot.axes])
    # if (is.null(Y)) {
    #     limits <- apply(pr.coo[, plot.axes], 2, range)
    #     ran.x <- limits[2, 1] - limits[1, 1]
    #     ran.y <- limits[2, 2] - limits[1, 2]
    #     xlim <- c((limits[1, 1] - ran.x/10), (limits[2, 1] + 
    #         ran.x/5))
    #     ylim <- c((limits[1, 2] - ran.y/10), (limits[2, 2] + 
    #         ran.y/10))
    #     par(mai = c(1, 1, 1, 0.5))
    #     plot(pr.coo[, plot.axes], xlab = labels[1], ylab = labels[2], 
    #         xlim = xlim, ylim = ylim, asp = 1)
    #     text(pr.coo[, plot.axes], labels = rownames(pr.coo), 
    #         pos = 4, cex = 1, offset = 0.5)
    #     if (is.null(main)) {
    #         title(main = "PCoA ordination", line = 2)
    #     }
    #     else {
    #         title(main = main, family = "serif", line = 2)
    #     }
    # }
    # else {
    # }
    # invisible()



# ---- PCA on environmental CTD
# temp, par and sal
env_data_matrix <- 
    env_cmtx %>% 
    # mutate(group = season) %>% 
    select(temp, par, sal, season) %>% 
    na.omit()

## calc PCA 
env_pca <- prcomp(env_data_matrix[1:3], scale. = TRUE)

## plot PCA
pca_plt <-
  autoplot(
    env_pca,
    data   = env_data_matrix,
    colour = "season"
  ) +
  scale_colour_discrete(name = "Season") +
  theme_classic() +
  theme(
    text = element_text(family = "serif", size = 20),
    legend.position = "bottom"
  )

pcoa_plt$plt    
# pcoa_plt   
pca_plt
```

## Save PCA and PCoA
```{r save-pcoa-pca}
save_gg(
  plt            = pca_plt, # edit if want specific plot
  save_location  = dir_plt_save,
  save_name      = "pft_pca",
  verbose        = TRUE,
  overwrite      = FALSE,
  time_stamp_fmt = "%Y%m%d_%H%M%S",
  device         = "jpeg",
  height         = 9.7,
  width          = 19,
  dpi            = 600,
  units          = "in",
  bg             = "white"
)

save_gg(
  plt            = pcoa_plt,
  save_location  = dir_plt_save,
  save_name      = "pft_pcoa",
  verbose        = TRUE,
  overwrite      = FALSE,
  time_stamp_fmt = "%Y%m%d_%H%M%S",
  device         = "jpeg",
  height         = 9.7,
  width          = 19,
  dpi            = 600,
  units          = "in",
  bg             = "white"
)
# save arguments
# sv_arg <-
#   list(
#     sv_loc    = dir_plt_save,
#     sv_nm     = c("pca", "pcoa"),
#     overwrite = FALSE
#   ) %>%
#   c(
#     .,
#     pca = dir_ls(.$sv_loc,
#                  regexp = .$sv_nm[1]) %>% is_empty(),
#     pcoa = dir_ls(.$sv_loc,
#                  regexp = .$sv_nm[2]) %>% is_empty()
#   )

# # ---- save PCA
# # if (sv_arg$pca | sv_arg$overwrite) {
#   save_gg(
#     plt            = pca_plt, # edit if want specific plot
#     save_location  = sv_arg$sv_loc,
#     save_name      = sv_arg$sv_nm[1],
#     verbose        = TRUE,
#     time_stamp_fmt = "%Y%m%d_%H%M%S",
#     device         = "jpeg",
#     height         = 9.7,
#     width          = 19,
#     dpi            = 600,
#     units          = "in",
#     bg             = "white"
#   )
# 
# # } else {
#   cli::cli_alert_info(
#     c(
#       "Skipping saving of {.file {sv_arg$sv_nm}} ",
#       "because exists ",
#       "and/or overwrite is set {.var FALSE}"
#     )
#   )
# # }
# 
# rm(sv_arg)
# 
# 
# # ---- save PCoA
# if (sv_arg$pcoa | sv_arg$overwrite) {
#   save_gg(
#     plt            = pcoa_plt, 
#     save_location  = sv_arg$sv_loc,
#     save_name      = sv_arg$sv_nm[2],
#     verbose        = TRUE,
#     time_stamp_fmt = "%Y%m%d_%H%M%S",
#     device         = "jpeg",
#     height         = 9.7,
#     width          = 19,
#     dpi            = 600,
#     units          = "in",
#     bg             = "white"
#   )
# 
# } else {
#     cli_alert_info(
#         c(
#           "Skipping saving of ",
#           "{.file {sv_arg$sv_nm[2]}} ",
#           "because exists ",
#           "and/or overwrite = {.var FALSE}"
#         )
#     )
# }
# rm(sv_arg)
```

# ---- Pairwise Permanova Test ----
```{r permanova}
# ---- function
# run adonis2 on

#' Pairwise Permutation MANOVA
#'
#' FUNCTION_DESCRIPTION
#'
#' @param .data DESCRIPTION.
#' @param pair_col DESCRIPTION.
#' @param pairs DESCRIPTION.
#' @param formula DESCRIPTION.
#' @param dist_method DESCRIPTION.
#'
#' @return RETURN_DESCRIPTION
#' @examples
#' # ADD_EXAMPLES_HERE
szn_adonis2 <- function(
        .data, 
        pair_col, 
        pairs, 
        formula = NULL, # something like "season * station" 
        dist_method = "bray") {
    # browser()
    pair_name <- str_flatten(pairs, collapse = "|")
    
    dat_pair  <- 
        filter(
            .data, 
            str_detect( !!sym(pair_col),
            pair_name))
    
    value <- select(dat_pair, chloro:pras)

    adon_test <- adonis2(
        formula = as.formula(paste("value ~", formula)), 
        data   = dat_pair, 
        method = dist_method
        # strata = # should probably add something here
        )   
    
    pairwise_p <- adon_test[["Pr(>F)"]][1]
    pairwise_p
}


# ---

set.seed(1082002)
all_test_env <-
  adonis2(
    env_data_matrix[1:3] ~ season,
    data   = env_data_matrix,
    method = "bray"
  )

all_test <-
  adonis2(
    cmtx_data_matrix ~ season,
    data   = cmtx_avgs,
    method = "bray"
  )
   

# create combinations of season to pairwise test
cross_pairs <- 
    cmtx_avgs %>%
    select(season) %$%
    combn(unique(as.character(season)), 2) %>%
    t()

colnames(cross_pairs) <- c("szn1", "szn2")

cross_pairs <- 
    cross_pairs %>% 
    as_tibble() %>%
    unite(season_pairs, szn1, szn2, sep = "|")

set.seed(1234)
cross_pairs %>%
    mutate(
       pairwise_p = map_dbl(
           .x = season_pairs,
           # .data = cmtx_avgs,
           .f = ~ szn_adonis2(.data = cmtx_avgs, "season", pairs = .x, "season"),
           .data = cmtx_avgs
       ),
       
      # ---- correct p-values
      p_adjust = p.adjust(pairwise_p, method = "bonferroni")     
    )


```

# CCA Analysis 
```{r cca, fig.height=9.7, fig.width=19}
# extrafont::font_import()
cca_matrix <- select(env_cmtx, chloro:pras)

cmtx_cca <- cca(cca_matrix ~ temp +sal + par, 
                data      = env_cmtx, 
                na.action = na.omit)

plot(cmtx_cca, scaling = 1)

new_lab <- list(temp = "Temp",
                sal  = "Sal", 
                par  = "PAR")

tol_muted2 <- c('#88CCEE', '#44AA99', '#117733', '#332288')

cca_plt <-
    ggord(
        cmtx_cca,
        size      = 4,
        grp_in    = env_cmtx %>% drop_na(temp, par:sal) %$% as.factor(season),
        ellipse   = FALSE,
        ptslab    = TRUE,
        addsize   = 6,
        ylim      = c(-6.25, 6.25),
        xlim      = c(-4, 5),
        repel     = TRUE,
        txt       = 6,
        vec_lab   = new_lab,
        grp_title = "Season"
        ) +
    theme_classic() +
    theme(text = element_text(family = "serif", size = 20),
          legend.position = "bottom")

cca_plt

gg_ordiplot(
  ord     = cmtx_cca,
  groups  = # extract seasons
    env_cmtx %>%
      drop_na(temp, par:sal) %$% 
      as.factor(season),
  scaling = 1
)


# ---- save cca plot
save_gg(
  plt            = cca_plt, # edit if want specific plot
  save_location  = dir_plt_save,
  save_name      = "pft_cca",
  verbose        = TRUE,
  overwrite      = FALSE,
  time_stamp_fmt = "%Y%m%d_%H%M%S",
  device         = "jpeg",
  height         = 9.7,
  width          = 19,
  dpi            = 600,
  units          = "in",
  bg             = "white"
  )
```


```{r ctd-plt}
ggplot(env_cmtx) +
    geom_boxplot(aes(y = par)) +
    facet_wrap(facet =  ~ season)


ggplot(env_cmtx) +
    geom_point(aes(x = date_time_utc, y = par, 
                   color = season)) 
# env_cmtx %>%
#     # select(-c(cruise_code, indx, cruise.y)) %>%
#     ggpairs(columns = 27:41, 
#             mapping = aes(color = season))
```





# STOP: Not sure what's beyond






```{r func-ord-plot}

neword <- function(ord_in, grp_in = NULL, axes = c("1", "2"), ...) {
    axes       <- glue("CCA {axes}")
    obs        <- data.frame(ord_in$CCA$wa[, axes])
    obs$Groups <- grp_in
    addpts     <- data.frame(ord_in$CCA$v[, axes])
    constr     <- data.frame(ord_in$CCA$biplot[, axes])
    exp_var    <- summary(ord_in, scaling = 1)$concont$importance[2, axes]
    axes       <- glue("{axes} ({round(100 * exp_var, 2)}%)")
    
    names(obs)[1:2] <- axes
    ggord:::ggord.default(obs, 
                          vecs = constr, 
                          axes, 
                          addpts = addpts, ...)
}

neword(cmtx_cca)
```
# ??? This function doesn't have a name
```{r}
function(ord,
         groups,
         scaling     = 1,
         choices     = c(1, 2),
         kind        = c("sd", "se", "ehull"),
         conf        = NULL,
         show.groups = "all",
         ellipse     = TRUE,
         label       = FALSE,
         hull        = FALSE,
         spiders     = FALSE,
         pt.size     = 3,
         plot        = TRUE) {
    
    groups <- as.factor(groups)
    if (show.groups[1] == "all") {
        show.groups <- as.vector(levels(groups))
    }
    
    df_ord <- vegan::scores(ord, display = "sites", scaling = scaling, 
        choices = choices)
    
    axis.labels <- ord_labels(ord)[choices]
    
    df_ord <- data.frame(x     = df_ord[, 1], 
                         y     = df_ord[, 2], 
                         Group = groups)
    
    df_mean.ord <- aggregate(df_ord[, 1:2], 
                             by = list(df_ord$Group), 
                             mean)
    
    colnames(df_mean.ord) <- c("Group", "x", "y")
    
    df_mean.ord <- df_mean.ord[df_mean.ord$Group %in% show.groups, ]
    
    if (is.null(conf)) {
        rslt <- vegan::ordiellipse(
            ord, 
            groups      = groups, 
            display     = "sites", 
            scaling     = scaling, 
            choices     = choices, 
            kind        = kind, 
            show.groups = show.groups, 
            draw        = "none", 
            label       = label)
    } else {
        rslt <- vegan::ordiellipse(
            ord, 
            groups      = groups, 
            display     = "sites", 
            scaling     = scaling,
            choices     = choices, 
            kind        = kind, 
            show.groups = show.groups, 
            draw        = "none", 
            conf        = conf, 
            label       = label)
    }
    
    df_ellipse <- data.frame()
    
    for (g in show.groups) {
        
        df_ellipse <- rbind(
            df_ellipse,
            cbind(as.data.frame(with(df_ord[df_ord$Group == g, ], 
            vegan:::veganCovEllipse(rslt[[g]]$cov, 
                                    rslt[[g]]$center, 
                                    rslt[[g]]$scale
                                    ))), 
            Group = g))
    }
    colnames(df_ellipse) <- c("x", "y", "Group")
    
    df_ellipse <- df_ellipse[, c(3, 1, 2)]
    
    rslt.hull <- vegan::ordihull(
        ord, 
        groups      = groups, 
        scaling     = scaling, 
        choices     = choices, 
        show.groups = show.groups, 
        draw        = "none")
    
    df_hull <- data.frame()
    df_temp <- data.frame()
    
    for (g in show.groups) {
        x       <- rslt.hull[[g]][, 1]
        y       <- rslt.hull[[g]][, 2]
        Group   <- rep(g, length(x))
        df_temp <- data.frame(Group = Group, 
                              x     = x, 
                              y     = y)
        df_hull <- rbind(df_hull, df_temp)
    }
    
    df_spiders        <- df_ord
    df_spiders$cntr.x <- NA
    df_spiders$cntr.y <- NA
    
    for (g in show.groups) {
        df_spiders[which(df_spiders$Group == g), 4:5] <- df_mean.ord[which(df_mean.ord == g), 2:3]
    }
    
    df_spiders <- df_spiders[, c(3, 4, 5, 1, 2)]
    df_spiders <- df_spiders[order(df_spiders$Group), ]
    df_spiders <- df_spiders[df_spiders$Group %in% show.groups, ]
    
    xlab <- axis.labels[1]
    ylab <- axis.labels[2]
    
    plt <- 
        ggplot() + 
        geom_point(data = df_ord, 
                   aes(x     = x, 
                       y     = y, 
                       color = Group), 
                   size = pt.size) + 
        labs(
            x = xlab,
            y = ylab
        )

    if (ellipse == TRUE) {
        plt <- 
            plt + 
            geom_path(data = df_ellipse, 
                      aes(x     = x, 
                          y     = y, 
                          color = Group), 
                      show.legend = FALSE)
    }
    
    if (label == TRUE) {
        plt <- 
            plt + 
            geom_text(data = df_mean.ord, 
                      aes(x = x, 
                          y = y, 
                          label = Group, 
                          color = Group), 
                      show.legend = FALSE)
    }
    
    if (hull == TRUE) {
        plt <- 
            plt + 
            geom_path(data = df_hull, 
                      aes(x = x, 
                          y = y, 
                          color = Group),
                      show.legend = FALSE)
    }
    if (spiders == TRUE) {
        plt <- plt + 
            geom_segment(data = df_spiders, 
                         aes(x     = cntr.x,
                             xend  = x, 
                             y     = cntr.y, 
                             yend  = y, 
                             color = Group), 
                         show.legend = FALSE)
    }
    
    plt <- plt + coord_fixed(ratio = 1)
    
    if (plot) {
        print(plt)
    }
    
    invisible(list(
        df_ord      = df_ord, 
        df_mean.ord = df_mean.ord, 
        df_ellipse  = df_ellipse, 
        df_hull     = df_hull, 
        df_spiders  = df_spiders, 
        plot        = plt
        ))
}
```


```{r}
cca_new <- vegan::scores(
    cmtx_cca, 
    display = "sites", 
    scaling = 1, 
    choices = c(1, 2))

ggord(cca_new, size = 1.5, 
      grp_in = env_cmtx %>% drop_na(temp,par:sal) %$% as.factor(season),
      ellipse = FALSE, 
      ptslab = TRUE, 
      addsize = 4, 
      ylim = c(-6.25, 6.25), 
      xlim = c(-5, 5))
```