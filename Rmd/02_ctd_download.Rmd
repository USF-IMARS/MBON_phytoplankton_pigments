---
title: "CTD download from ERDDAP"
author: "Sebastian DiGeronimo"
date: "2023-01-10"
output: html_document
---

# Steps:
1. Make sure to download libraries if you don't have
  i.e. install.packages("purrr")
2. Check database URL
3. Change folder location if needed
  - the code will add cruise specific folders within that location and their 
    station files
4. Create folders
5. Run function on cruise IDs


# Load libraries
```{r setup}
librarian::shelf(
    librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here,
    # broom # optional
    
    # additional
    rerddap # used to access different ERDDAPs
    )

library("conflicted")

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

# Set database
Once you find an ERDDAP with the data you want, you can change the location here
```{r set-database}
# this database contains CTD data from Walton Smith Cruises
database <- "https://gcoos5.geos.tamu.edu/erddap/"
database <- "https://upwell.pfeg.noaa.gov/erddap/"
Sys.setenv(RERDDAP_DEFAULT_URL = database)
rm(database)
```

# Set folder location and create vector of cruise IDs
```{r loc-ids}
# folder location
loc      <- here("data", "raw", "ctd")

# cruise IDs
cruiseID <- c("WS16074", "WS16130", "WS16263", "WS16319", "WS17086", "WS17170",
              "WS17282", "WS18008", "SAV1803", "WS18120", "SAV18173", "WS18218",
              "WS18285", "WS18351", "WS19028", "WS19119", "WS19210", "WS19266",
              "WS19322", "WS20006", "WS20231", "WS20278", "WS20342", "WS21032",
              "WS21093")

# create folder if doesn't exist
here(loc, cruiseID) %>%
  dir_create()
```

# Function to query and download CTD data from each cruise
This takes in cruise IDs and queries the ERDDAP to find data. Next, it will
download if CTD files don't exist
```{r query-function}
ctd_downloads <- function(IDS, path, verbose = TRUE) {
  
  message(paste("Starting cruise:", IDS))
  
  # query cruise ID 
  results <- tryCatch({
    ed_search_adv(query = IDS)
  }, error = function(e) {
    if (verbose) message("Did not find any files!")
    invisible(return())
    break
  })
  
  # show results of cruise
  if (verbose) print(results)

  # loop through each station for the cruise and download if doesn't exist
  for (j in seq(results$info$dataset_id)) {
      
      # extract filename from query
      filename  <- results$info$dataset_id[j]
      
      # create out file path
      file_path <- here(path, IDS, glue("{filename}.csv"))
      
      # skip already downloaded files
      if (fs::file_exists(file_path)) {
        if (verbose) cat("Skipping file:", filename, "\n--------\n\n")
        next
      }
      
      if (verbose) cat("Downloading file:", filename, "\n--------\n\n")
      
      # get data
      out      <- info(filename)

      ctd_data <- tabledap(out, url = eurl(), store = disk())
      
      # save data
      write.csv(ctd_data, file_path)
  }
  
  if (verbose) {
  cat("Finished cruise", IDS, "\n\n---------------------------------------\n\n")
  }
}
```

# Run ctd_downloads function and try each cruise ID for existing data
This will take some time, ~ 30 - 60 min
```{r download-ctd-data}
for (i in seq(cruiseID)) {
    try(ctd_downloads(cruiseID[i], loc, TRUE), silent = TRUE)
    }
rm(i, cruiseID)
```

# Read CTD files and average top 5 meters
```{r query-ctd-files}
# get all CTD file names
file_ctd <- 
    dir_ls(loc,
           recurse = TRUE,
           regexp = "\\.csv$") %>% 
    str_sort() %>%
    tibble(file = .) %>%
    filter(!str_detect(file, "(?i)(deck|test|tst)")) %>%
    # extract cruise and station names from files
    mutate(
        cruise_id = dirname(file) %>% basename(.),
        station   = basename(file)  %>%                      # extract file name
                    path_ext_remove() %>%                    # rm extension
                    str_remove(., ".*((?i)stn|(?i)sta)") %>% # rm sta/stn
                    str_remove(., "Savannah_SAV1803_SAV1803") %>%
                    str_remove(., "^_") %>%                  # rm leading "_"
                    str_remove(., "^0+")  %>%                # rm leading zeros
                    str_replace(., "21LK", "LK") %>% 
                    str_replace(., "215", "21.5"), 
        
        # fix cruise IDs
        cruise_id = case_when(
            cruise_id == "SAV18173" ~ "SV18173",
            cruise_id == "SAV1803" ~ "SV18067",
            cruise_id == "WS20231" ~ "WS20230",
            .default = cruise_id)
            )
```
```{r load-ctd-data}
# read all files and average columns
ctd_dat_summary <-
    file_ctd %>%
    mutate(
        data = map(
            .progress = TRUE,
            file,
            function(x) {
                cruise <- 
                    basename(x) %>%
                    path_ext_remove()   
                
                cli::cli_alert_info("Cruise File: {cruise}")
                
                read_csv(
                    x,
                    show_col_types = FALSE,
                    name_repair = "unique_quiet")  %>%
                    
                    # filter depth
                    filter(depth <= 5) %>% 
                        
                    # select cols and rename
                    select(
                      time, 
                      lat = latitude, 
                      lon = longitude, depth,
                      pressure = sea_water_pressure,
                      temp = sea_water_temperature, 
                      o_sat = oxygen_saturation, do = dissolved_oxygen,
                      par = any_of("photosynthetically_available_radiation"), 
                      sal = sea_water_salinity) %>%
                
                    # calc average
                    summarise(across(.fn = \(x) mean(x, na.rm = TRUE)))
                }
            )
        ) %>%
    unnest(cols = data)
    
```
```{r save-ctd-all}
if (FALSE) {
    ctd_dat_summary %>%
        select(-1) %>%
        arrange(time) %>%
        write_csv(
            here("data", "processed", 
                 glue("ctd_all_", 
                      "{Sys.Date()}",
                      ".csv")
                 )
            )
    }
```


# TODO: remove to another location
the cmtx_avgs variable doesn't exists here
```{r chemtax-ctd}
if (FALSE) {
    
    cmtx_avgs <- 
        here("data", "processed", "chemtax_w_meta_rm_dup.csv")  %>%
        read_csv(show_col_types = FALSE) %>%
        mutate(cruise_id = str_extract(sample, "[A-Z]{2,3}[0-9]{4,5}"), 
               season    = as.character(season)) %>%
        relocate(cruise_id, .before = 1)
    
    env_cmtx <- 
        cmtx_avgs %>% 
        left_join(ctd_dat_summary, 
                  by = join_by(
                      "cruise_id", 
                      "station")
                  )
    
    write_csv(env_cmtx, 
              file = here("data", "processed", "cmtx_env_data.csv"))
    }
```

