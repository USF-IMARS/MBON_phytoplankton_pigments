---
title: "HPLC Microscopy Match-up"
author: "Sebastian DiGeronimo"
date: '2022-06-30'
output: html_document
---

```{r}
library("ggplot2")
library("tibble")
library("tidyr")
library("readr")
library("purrr")
library("dplyr")
library("stringr")
library("forcats")
library("lubridate")
library("glue")
library("fs")
library("blandr")
library("magrittr")


root <- rprojroot::find_rstudio_root_file()

dir3 <- "//data//raw//"
path_in = paste0(root,dir3)
```

```{r}
df_pig <-
    readr::read_csv(paste0(root, "/data/processed/combined_pig_dat.csv")) %>%
    mutate(date_time_utc = replace(
        date_time_utc,
        station == "MR" &
            as_date(date_time_utc) == "2018-01-08",
        ymd_hms("2018-01-09 00:52:00")
    ))
```

```{r microscopy}
micro_path <-
    fs::dir_ls(
        paste0(root, "/data/raw/"),
               regexp = "Sample overview.+FWRI\\.xlsx$",
               recurse = T
        )

df_micro <-
    readxl::read_excel(
        micro_path,
        skip = 2,
        sheet = 2,
        .name_repair = janitor::make_clean_names
    ) %>%
    
    rename(lat = latitude,
           lon = longitude) %>%
           
    mutate(
        sample_time = hms::as_hms(strftime(sample_time, format = "%H:%M:%S", 
                                           tz = "utc")),
        date_time = ymd_hms(paste(sample_date, sample_time),
                            tz = "utc"),
        .before = time_zone
    ) %>%
    # removes rows without station IDs
    filter(!is.na(station_id)) %>%
    
    # extracts station #, removing 
   mutate(station = str_remove(station_id, "^(Keys MBON |NOAA-AOML )"),
          station = str_replace_all(station, "/|\\s", "_"),
          station = str_replace(station, "21_LK", "LK"),
           .after = station_id
    ) %>%
    
    # replaces NA values to 0 for count data
    mutate(across(achnanthes_sp:last_col(), ~ replace_na(., 0))) %>%

    # filter rows for full counts only
    filter(str_detect(count_details, "Full.*"))

   

rm(micro_path)
```

```{r create-index}
# create columns for surface and depth
sm_mic <- 
    df_micro %>%
    rename(depth = sample_depth_m) %>%
    select(habid, date = sample_date, date_time, station, depth)  %>%
    group_by(station, date_time) %>%
    mutate(depth_id = case_when(
        n() > 1 & depth  == min(depth) ~ "SUR",
        n() > 1 & depth == max(depth) ~ "BOT",
        depth > 5 ~ "BOT",
        TRUE ~ "SUR"
    )) %>%
       ungroup()

sm_pig <- 
    df_pig %>%
    select(sample, date_time_utc,  station, depth) %>%
    # filters duplicates at same depth
    distinct(station, date_time_utc, depth, .keep_all = T) %>%

    group_by(station, date_time_utc) %>%
    mutate(depth_id = case_when(
        n() > 1 & depth  == min(depth) ~ "SUR",
        n() > 1 & depth > min(depth) ~ "BOT",
        depth > 5 ~ "BOT",
        TRUE ~ "SUR"
    ),
    # time varies slightly, date does not
    date = as.Date(date_time_utc)) %>%
       ungroup()

# index to be added to each dataframe to reference later
indx_match <-
    inner_join(sm_pig, sm_mic, by = c("station", "date", "depth_id")) %>%
    select(sample, habid) %>%
    mutate(
        indx = paste0(row_number(), "-", str_split(sample, "_|-", 2, simplify = T)[, 2])
    )

rm(sm_pig, sm_mic)
```
```{r}
df_micro_filt <-
    df_micro %>%
    filter(habid %in% indx_match$habid) %>%
    mutate(indx = indx_match$indx, .before = 1)

df_pig_filt <-
    df_pig %>%
    filter(sample %in% indx_match$sample) %>%
    mutate(indx = indx_match$indx, .before = 1)

rm(df_micro, df_pig, indx_match)
```

```{r grouping-microscopy-taxa}
taxa_df <- readxl::read_xlsx(
    path = paste0(path_in,"Sample overview 7_29_20_FWRI.xlsx"),
    sheet = 3,
    skip = 1
    ) %>% 
    na.omit() %>% 
    rename(taxa = 1) 
taxa_df$taxa <- gsub("Pseudo_nitzschia", "Pseudonitzschia", taxa_df$taxa)

# temp <- 
#     as.data.frame(stringr::str_split_fixed(taxa_df$taxa, "_", 2))
# colnames(temp) <- c("genus", "species")
# taxa_df <- taxa_df %>% 
#     bind_cols(temp) %>%
#     filter(!(genus %in% c("Copepods", "Detritus", "Zooplankton", "Foraminifera",
#                           "Globigerinidae", "Nauplii", "Choanoflagellate"
#                           )))

taxa_df <- taxa_df %>% 
    mutate(genus = stringr::str_split(taxa, "_", 2, simplify = T)[,1],
           species = stringr::str_split(taxa, "_", 2, simplify = T)[,2]) %>% 
    filter(!(genus %in% c("Copepods", "Detritus", "Zooplankton", "Foraminifera",
                          "Globigerinidae", "Nauplii", "Choanoflagellate"
                          )))

taxa_id_all <- taxa_df  %>% 
    distinct(genus) %$% 
    obistools::match_taxa(genus, ask = T)  %>%
    dplyr::mutate(idnum = gsub("urn:lsid:marinespecies.org:taxname:", "", scientificNameID)) %>% 
    as_tibble()

taxa_nt_mt <- bind_cols(taxa_df%>% 
    distinct(genus), taxa_id_all) %>% 
    filter(is.na(scientificName)) %>% 
    select(1)

taxa_id <- taxa_id_all %>% 
    distinct(idnum) %>% 
    tidyr::drop_na()

df <- list()
 
for (i in 1:nrow(taxa_id)) {
    temp <- robis::taxon(taxa_id[i,])
    df[[i]] <- temp
}

taxa_info <- map_dfr(df, ~as_data_frame(.))
```

categorize taxa into functional types and make a list of genera/taxa for each functional type
make new columns in df_micro_filt for each functional type through summing the columns that contribute to that functional type
```{r}
df_class <- taxa_df %>%
    full_join(taxa_info, by = "genus") %>%
    mutate(func_type = case_when(class == "Bacillariophyceae" ~ "diat",
                                  class == "Dinophyceae" ~ "dino",
                                  class == "Cyanophyceae" ~ "cyano",
                                  class == "Chlorophyceae" ~ "chloro",
                                  class == "Cryptophyceae" ~ "crypto",
                                  class == "Pyramimonadophyceae" ~ "pras",
                                  genus == "Chlorophyte" ~ "chloro",
                                  genus == "Coccolithophorid" ~ "hapt",
                                  genus %in% c("Dinocyst", "Dinoflagellate",
                                               "Warnowioid", "Gymnodinoid",
                                               "Scrippsielloid", "Polykrikoid"
                                               ) ~ "dino",
                                  genus %in% c("Microdiatoms", "Nanodiatoms",
                                               "Nitzschioid", "Naviculoid", 
                                               "Diatom", "Pleurosigmataceae"
                                               ) ~ "diat",
                                 genus == "Cryptomonad" ~ "crypto",
                                 genus %in% c("Cyanobacteria", "Johannebaptista") ~ "cyano",
                                  TRUE ~ "other"
                                  ),
           .before = 3) %>% 
    drop_na(taxa) %>% 
    mutate(taxa = str_to_lower(taxa))

# column name into taxa 
micro_longer <- df_micro_filt %>%
    pivot_longer(cols = achnanthes_sp:zooplankton, names_to = "taxa", values_to = "count") %>% 
    mutate( 
        taxa = gsub("pseudo_nitzschia", "pseudonitzschia", taxa)
        ) %>% 
    left_join(df_class %>% select(taxa,func_type), by = "taxa")

# diat_sum <- sum(filter(micro_longer, func_type == "diat")$count)
# sum_func_type <- function(.name, .idx) {
#     temp <- filter(micro_longer, func_type == .name & indx == .idx) 
#     ct <- sum(temp$count)
#     return(ct)
# }

df_type_counts <- 
    micro_longer %>%
    group_by(indx, func_type) %>%
    summarise(micro_count = sum(count))

df_pig_filt2 <- df_pig_filt %>% 
    left_join(cmtx_avgs_raw, by=c("sample"="sample_id")) %>%
    filter(name_of_water_body =="Florida Keys") %>% 
    #combine diat, cyano, hapt concentrations
    mutate(diat = diat1+diat2,
           cyano = cyano2+cyano4,
           hapt = hapt6+hapt8) %>%
    select(indx,cruise,station, depth, date_time_utc, lon, lat, 
           chloro, crypto, dino, pras.y, diat, cyano, hapt) %>%
    rename(pras=pras.y) %>%
    pivot_longer(cols = chloro:hapt, names_to = "func_type", values_to = "cmtx_conc")
```


```{r}
conv_facts <- df_pig_filt2 %>% 
    #join the longer chemtax and microscopy data
    left_join(df_type_counts, by =c("indx", "func_type")) %>%
    #select desired columns
    select(indx, func_type, cmtx_conc, micro_count) %>% 
    filter(cmtx_conc >= 0 & micro_count >= 0)

cf_avgs <- conv_facts %>% 
    #filter out rows where count or concentration == 0 
    filter(cmtx_conc > 0 & micro_count > 0) %>%
    #calculate conversion factors 
    mutate(cf=cmtx_conc/micro_count) %>% 
    # group by func_type
    group_by(func_type) %>% 
    # average the conversion factors
    summarize(avg_cf = mean(cf))

cmtx_micro <- conv_facts %>% 
    left_join(cf_avgs, by = "func_type") %>%
    # multiply conversion factors by microscopy counts to get T chla of counted functional type
    mutate(micro_conc = micro_count * avg_cf) %>% 
    pivot_wider(id_cols = c(indx), names_from= func_type, values_from = c(cmtx_conc, micro_conc))
```

```{r cmtx-vs-micro-plots}
relation <- lm(cmtx_conc_diat~micro_conc_diat, cmtx_micro)
print(summary(relation))

ggplot(cmtx_micro, aes(x=cmtx_conc_cyano, y=micro_conc_cyano)) +
    geom_point() +
    geom_smooth(method = "lm", se=FALSE)+
    labs(title="Cyano")
ggplot(cmtx_micro, aes(x=cmtx_conc_crypto, y=micro_conc_crypto)) +
    geom_point() +
    geom_smooth(method = "lm", se=FALSE)+
    labs(title="Crypto")
ggplot(cmtx_micro, aes(x=cmtx_conc_chloro, y=micro_conc_chloro)) +
    geom_point() +
    geom_smooth(method = "lm", se=FALSE)+
    labs(title="Chloro")
ggplot(cmtx_micro, aes(x=cmtx_conc_pras, y=micro_conc_pras)) +
    geom_point() +
    geom_smooth(method = "lm", se=FALSE)+
    labs(title="Pras")
ggplot(cmtx_micro, aes(x=cmtx_conc_hapt, y=micro_conc_hapt)) +
    geom_point() +
    geom_smooth(method = "lm", se=FALSE)+
    labs(title="Hapt")
ggplot(cmtx_micro, aes(x=cmtx_conc_dino, y=micro_conc_dino)) +
    geom_point() +
    geom_smooth(method = "lm", se=FALSE)+
    labs(title="Dino")
ggplot(cmtx_micro, aes(x=cmtx_conc_diat, y=micro_conc_diat)) +
    geom_point() +
    geom_smooth(method = "lm", se=FALSE)+
    labs(title="Diat")

```
```{r Bland-Altman}
blandr.draw(cmtx_micro$cmtx_conc_cyano, cmtx_micro$micro_conc_cyano) +
    labs(title = "Cyanobacteria")
blandr.draw(cmtx_micro$cmtx_conc_crypto, cmtx_micro$micro_conc_crypto) +
    labs(title = "Cryptophytes")
blandr.draw(cmtx_micro$cmtx_conc_chloro, cmtx_micro$micro_conc_chloro) +
    labs(title = "Chlorophytes")
blandr.draw(cmtx_micro$cmtx_conc_pras, cmtx_micro$micro_conc_pras)+
    labs(title = "Prasinophytes")
blandr.draw(cmtx_micro$cmtx_conc_hapt, cmtx_micro$micro_conc_hapt) +
    labs(title = "Haptophytes")
blandr.draw(cmtx_micro$cmtx_conc_dino, cmtx_micro$micro_conc_dino) +
    labs(title = "Dinoflagellates")
blandr.draw(cmtx_micro$cmtx_conc_diat, cmtx_micro$micro_conc_diat) +
    labs(title = "Diatoms")

```

