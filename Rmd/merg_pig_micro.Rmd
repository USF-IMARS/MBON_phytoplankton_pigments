---
title: "HPLC Microscopy Match-up"
author: "Sebastian DiGeronimo"
date: '2022-06-30'
output: html_document
---

```{r}
library("ggplot2")
library("tibble")
library("tidyr")
library("readr")
library("purrr")
library("dplyr")
library("stringr")
library("forcats")
library("lubridate")
library("glue")
library("fs")
library("magrittr")


root <- rprojroot::find_rstudio_root_file()
```

```{r}
df_pig <-
    readr::read_csv(paste0(root, "/data/processed/combined_pig_dat.csv")) %>%
    mutate(date_time_utc = replace(
        date_time_utc,
        station == "MR" &
            as_date(date_time_utc) == "2018-01-08",
        ymd_hms("2018-01-09 00:52:00")
    ))

```

```{r microscopy}
micro_path <-
    fs::dir_ls(
        paste0(root, "/data/raw/"),
               regexp = "Sample overview.+FWRI\\.xlsx$",
               recurse = T
        )

df_micro <-
    readxl::read_excel(
        micro_path,
        skip = 2,
        sheet = 2,
        .name_repair = janitor::make_clean_names
    ) %>%
    
    rename(lat = latitude,
           lon = longitude) %>%
           
    mutate(
        sample_time = hms::as_hms(strftime(sample_time, format = "%H:%M:%S", 
                                           tz = "utc")),
        date_time = ymd_hms(paste(sample_date, sample_time),
                            tz = "utc"),
        .before = time_zone
    ) %>%
    # removes rows without station IDs
    filter(!is.na(station_id)) %>%
    
    # extracts station #, removing 
   mutate(station = str_remove(station_id, "^(Keys MBON |NOAA-AOML )"),
          station = str_replace_all(station, "/|\\s", "_"),
          station = str_replace(station, "21_LK", "LK"),
           .after = station_id
    ) %>%
    
    # replaces NA values to 0 for count data
    mutate(across(achnanthes_sp:last_col(), ~ replace_na(., 0))) %>%

    # filter rows for full counts only
    filter(str_detect(count_details, "Full.*"))

   

# rm(micro_path)
```
```{r}
df_pig %>%
    filter(year == 2018) %>% 
    select(station, date_time_utc) %>%
    mutate(new = replace(date_time_utc, station == "MR" & as_date(date_time_utc) == "2018-01-08", ymd_hms("2018-01-09 00:52:00"))) %>%
    filter(station == "MR") %>%
    arrange(new)
          
```

```{r}

sm_mic <- 
    df_micro %>%
    rename(depth = sample_depth_m) %>%
    select(habid, date = sample_date, date_time, station, lat, lon, depth)  %>%
    group_by(station, date_time) %>%
    mutate(depth_id = case_when(
        n() > 1 & depth  == min(depth) ~ "SUR",
        n() > 1 & depth == max(depth) ~ "BOT",
        depth > 5 ~ "BOT",
        TRUE ~ "SUR"
    )) %>%
       ungroup()

sm_pig <- 
    df_pig %>%
    select(sample, station, date_time_utc, lat, lon, depth) %>%
    # filters duplicates at same depth
    distinct(station, date_time_utc, depth, .keep_all = T) %>%
    group_by(station, date_time_utc) %>%
    mutate(depth_id = case_when(
        n() > 1 & depth  == min(depth) ~ "SUR",
        n() > 1 & depth > min(depth) ~ "BOT",
        depth > 5 ~ "BOT",
        TRUE ~ "SUR"
    ),
    date = as.Date(date_time_utc)) %>%
       ungroup()
    
# unique(sm_pig$station)
# dupes <- sm_pig %>%
#     filter(station %in% unique(sm_pig$station[duplicated(sm_pig$station)]))
```
```{r}
final <- right_join(sm_pig, sm_mic, by = c("station", "date", "depth_id")) %>%
    filter(!is.na(date_time_utc)) %>%
    relocate(date_time, .after = date_time_utc) %>%
    relocate(depth.y, .after = depth.x) %>%
    arrange(date_time_utc)


final
```


